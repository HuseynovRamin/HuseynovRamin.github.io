<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Waterify Pro</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#060b18">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* Existing styles remain the same, only adding new styles */

/* ===== NEW: ACHIEVEMENT POPUP ANIMATION ===== */
.achievement-popup {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  animation: fadeIn 0.5s ease;
}

.achievement-popup.show {
  display: flex;
}

.achievement-content {
  width: 90%;
  max-width: 400px;
  background: linear-gradient(145deg, rgba(18, 26, 47, 0.95), rgba(12, 18, 34, 0.95));
  border: 2px solid var(--accent);
  border-radius: 24px;
  padding: 40px 30px;
  text-align: center;
  position: relative;
  overflow: hidden;
  box-shadow: 
    0 20px 60px rgba(79, 209, 255, 0.3),
    0 0 100px rgba(79, 209, 255, 0.1);
  animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes popIn {
  0% { transform: scale(0.8) translateY(50px); opacity: 0; }
  100% { transform: scale(1) translateY(0); opacity: 1; }
}

.achievement-badge-large {
  width: 100px;
  height: 100px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 20px;
  font-size: 48px;
  color: #000;
  box-shadow: 0 10px 40px rgba(79, 209, 255, 0.5);
  animation: badgePulse 2s infinite;
  position: relative;
  z-index: 1;
}

@keyframes badgePulse {
  0%, 100% { transform: scale(1); box-shadow: 0 10px 40px rgba(79, 209, 255, 0.5); }
  50% { transform: scale(1.1); box-shadow: 0 15px 50px rgba(79, 209, 255, 0.7); }
}

.achievement-title {
  font-size: 24px;
  font-weight: 700;
  margin: 0 0 10px 0;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.achievement-description {
  color: var(--muted);
  font-size: 16px;
  margin-bottom: 30px;
  line-height: 1.5;
}

.confetti {
  position: absolute;
  width: 10px;
  height: 10px;
  background: var(--accent);
  border-radius: 50%;
  opacity: 0;
}

/* ===== UPDATED: TIME PROGRESS - 24 HOURS ===== */
.time-progress {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  margin: 20px 0;
}

.time-slot {
  text-align: center;
  padding: 12px 8px;
  background: var(--glass);
  border-radius: 12px;
  border: 1px solid var(--glass-border);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.time-slot.active {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(79, 209, 255, 0.2);
}

.time-slot::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  transform: translateY(-100%);
  transition: transform 0.3s ease;
}

.time-slot.active::before {
  transform: translateY(0);
}

.time-label {
  font-size: 10px;
  color: var(--muted);
  margin-bottom: 5px;
  font-weight: 500;
}

.time-value {
  font-weight: 600;
  font-size: 12px;
  color: var(--accent);
}

/* ===== NEW: REMOVE DRINK BUTTON ===== */
.drink-item-remove {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 24px;
  height: 24px;
  background: var(--danger);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 12px;
  cursor: pointer;
  opacity: 0;
  transform: scale(0.8);
  transition: all 0.3s ease;
  z-index: 10;
}

.drink-item:hover .drink-item-remove {
  opacity: 1;
  transform: scale(1);
}

.drink-item-remove:hover {
  background: #ff2e4d;
  transform: scale(1.1);
}

/* ===== ENHANCED RECENT ACTIVITY WITH DELETE ===== */
.recent-activity-item {
  position: relative;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  margin-bottom: 8px;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  transition: all 0.3s ease;
}

.recent-activity-item:hover {
  background: rgba(79, 209, 255, 0.05);
  border-color: rgba(79, 209, 255, 0.3);
}

.recent-activity-delete {
  position: absolute;
  top: -8px;
  right: -8px;
  width: 24px;
  height: 24px;
  background: var(--danger);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 10px;
  cursor: pointer;
  opacity: 0;
  transform: scale(0);
  transition: all 0.3s ease;
  z-index: 2;
}

.recent-activity-item:hover .recent-activity-delete {
  opacity: 1;
  transform: scale(1);
}

.recent-activity-delete:hover {
  background: #ff2e4d;
  transform: scale(1.1);
}

/* ===== NEW: NIGHT-TIME STYLING ===== */
.time-slot.night {
  background: linear-gradient(135deg, rgba(12, 18, 34, 0.8), rgba(18, 26, 47, 0.8));
  border-color: rgba(107, 124, 255, 0.3);
}

.time-slot.night.active {
  background: linear-gradient(135deg, rgba(79, 209, 255, 0.1), rgba(107, 124, 255, 0.1));
  border-color: var(--accent2);
}

.time-slot.night .time-label {
  color: #8b9bff;
}

.time-slot.night .time-value {
  color: var(--accent2);
}

/* ===== ENHANCED ACHIEVEMENT BADGE ===== */
.achievement-badge {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #000;
  font-size: 20px;
  box-shadow: 0 0 20px rgba(79, 209, 255, 0.5);
  animation: pulse 2s infinite;
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 100;
}

.achievement-badge:hover {
  transform: scale(1.1);
  box-shadow: 0 0 30px rgba(79, 209, 255, 0.7);
}

.achievement-badge.has-new {
  animation: pulseGold 1.5s infinite;
  background: linear-gradient(135deg, #FFD700, #FFA500);
}

@keyframes pulseGold {
  0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
  50% { transform: scale(1.1); box-shadow: 0 0 30px rgba(255, 215, 0, 0.8); }
}

/* ===== NEW: CONFETTI ANIMATION ===== */
.confetti-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 1500;
}

.confetti-piece {
  position: absolute;
  width: 10px;
  height: 20px;
  background: linear-gradient(135deg, var(--accent), var(--accent2), #FFD700, #FFA500);
  opacity: 0;
}

/* ===== RESPONSIVE ADJUSTMENTS ===== */
@media (max-width: 480px) {
  .time-progress {
    grid-template-columns: repeat(2, 1fr);
    gap: 6px;
  }
  
  .time-slot {
    padding: 10px 6px;
  }
  
  .time-label {
    font-size: 9px;
  }
  
  .time-value {
    font-size: 11px;
  }
  
  .achievement-content {
    padding: 30px 20px;
  }
  
  .achievement-badge-large {
    width: 80px;
    height: 80px;
    font-size: 36px;
  }
  
  .achievement-title {
    font-size: 20px;
  }
}
</style>
</head>

<body>
<!-- Water Drop Animation Container -->
<div id="waterDropsContainer"></div>

<!-- Achievement Popup -->
<div class="achievement-popup" id="achievementPopup">
  <div class="achievement-content">
    <div class="achievement-badge-large" id="achievementBadgeIcon">
      <i class="fas fa-trophy"></i>
    </div>
    <h3 class="achievement-title" id="achievementPopupTitle">Achievement Unlocked!</h3>
    <p class="achievement-description" id="achievementPopupDesc">Congratulations on your achievement!</p>
    <button class="btn" onclick="closeAchievementPopup()" style="width: 100%;">
      <i class="fas fa-check"></i> Awesome!
    </button>
  </div>
</div>

<!-- Confetti Container -->
<div class="confetti-container" id="confettiContainer"></div>

<!-- Achievement Badge -->
<div class="achievement-badge" id="achievementBadge" onclick="showAchievementsModal()" title="View Achievements">
  <i class="fas fa-trophy"></i>
</div>

<div class="app">
  <!-- Main Dashboard -->
  <div id="dashboard" class="screen">
    <div class="card" style="position: relative;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
          <h1 style="margin: 0; font-size: 28px; font-weight: 700; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Waterify Pro</h1>
          <p style="margin: 5px 0 0 0; color: var(--muted); font-size: 14px;" id="greetingMessage">Stay Hydrated, Stay Healthy</p>
        </div>
        <div class="btn-small" onclick="openProfile()" style="background: var(--glass); border: 1px solid var(--glass-border); color: var(--text);">
          <i class="fas fa-user"></i>
          <span id="userName">Profile</span>
        </div>
      </div>

      <!-- Time-based Progress - ENHANCED FOR 24 HOURS -->
      <div class="time-progress" id="timeProgress">
        <!-- Will be populated by JavaScript -->
      </div>

      <div style="text-align: center; margin-bottom: 30px;">
        <div class="progress-container">
          <div class="progress-header">
            <span style="font-weight: 600; color: var(--accent);">Daily Progress</span>
            <span style="font-weight: 600;" id="progressText">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>
      </div>

      <!-- Hydration Levels -->
      <div class="hydration-levels">
        <div class="hydration-level" onclick="setGoalPercentage(0)">
          <div class="level-circle level-0"></div>
          <div style="font-size: 11px;">Low</div>
        </div>
        <div class="hydration-level" onclick="setGoalPercentage(25)">
          <div class="level-circle level-1"></div>
          <div style="font-size: 11px;">25%</div>
        </div>
        <div class="hydration-level" onclick="setGoalPercentage(50)">
          <div class="level-circle level-2"></div>
          <div style="font-size: 11px;">50%</div>
        </div>
        <div class="hydration-level" onclick="setGoalPercentage(75)">
          <div class="level-circle level-3"></div>
          <div style="font-size: 11px;">75%</div>
        </div>
        <div class="hydration-level active" onclick="setGoalPercentage(100)">
          <div class="level-circle level-4"></div>
          <div style="font-size: 11px;">Goal</div>
        </div>
      </div>

      <div class="bottle-container">
        <div class="bottle">
          <div class="water" id="waterLevel"></div>
        </div>
      </div>

      <div style="text-align: center; margin: 30px 0;">
        <div id="consumedDisplay" style="font-size: 48px; font-weight: 800; color: var(--accent); margin-bottom: 10px; text-shadow: 0 0 20px rgba(79, 209, 255, 0.5);">0 ml</div>
        <div id="goalDisplay" style="color: var(--muted); font-size: 16px;">of 0 ml goal</div>
        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: var(--accent);" id="drinksCount">0</div>
            <div style="font-size: 12px; color: var(--muted);">Drinks</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: var(--accent);" id="streakCount">0</div>
            <div style="font-size: 12px; color: var(--muted);">Day Streak</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: var(--accent);" id="todayBest">0</div>
            <div style="font-size: 12px; color: var(--muted);">Today's Best</div>
          </div>
        </div>
      </div>

      <!-- Quick Add Buttons -->
      <div class="quick-add-buttons">
        <div class="quick-add-btn" onclick="quickAddDrink('water', 250)">
          <i class="fas fa-tint"></i>
          <span>250ml</span>
        </div>
        <div class="quick-add-btn" onclick="quickAddDrink('water', 500)">
          <i class="fas fa-wine-bottle"></i>
          <span>500ml</span>
        </div>
        <div class="quick-add-btn" onclick="quickAddDrink('water', 750)">
          <i class="fas fa-glass-water"></i>
          <span>750ml</span>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
        <button class="btn" onclick="openDrinkModal()">
          <i class="fas fa-plus"></i> Add Drink
        </button>
        <button class="btn-secondary" onclick="openStats()">
          <i class="fas fa-chart-line"></i> Stats
        </button>
      </div>

      <div style="margin-top: 30px;">
        <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;">
          <i class="fas fa-history" style="color: var(--accent); margin-right: 10px;"></i>
          Recent Activity
          <span id="activityCount" style="font-size: 12px; background: var(--accent); color: #000; padding: 2px 8px; border-radius: 10px; margin-left: 8px;">0</span>
        </h3>
        <div id="recentActivity" style="max-height: 200px; overflow-y: auto; padding-right: 10px;"></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-chart-bar" style="color: var(--accent); margin-right: 10px;"></i>Quick Stats</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="weekAvg">0</div>
          <div class="stat-label">Weekly Avg</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="monthTotal">0</div>
          <div class="stat-label">Monthly Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="goalDays">0%</div>
          <div class="stat-label">Goal Days</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="bestStreak">0</div>
          <div class="stat-label">Best Streak</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-lightbulb" style="color: var(--accent); margin-right: 10px;"></i>Hydration Tip</h3>
      <div id="hydrationTip" style="color: var(--muted); font-size: 14px; line-height: 1.6;">Loading tip...</div>
    </div>
  </div>

  <!-- Statistics Screen -->
  <div id="statsScreen" class="screen" style="display: none;">
    <div class="card">
      <div class="modal-header">
        <h3><i class="fas fa-chart-line"></i> Advanced Statistics</h3>
        <button class="close-btn" onclick="closeStats()"><i class="fas fa-times"></i></button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalConsumed">0</div>
          <div class="stat-label">Lifetime Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="avgDaily">0</div>
          <div class="stat-label">Daily Average</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="bestDay">0</div>
          <div class="stat-label">Best Day</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="completionRate">0%</div>
          <div class="stat-label">Success Rate</div>
        </div>
      </div>

      <div class="advanced-stats">
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">Weekly Trend</div>
            <div class="chart-actions">
              <button class="chart-btn active" onclick="changeChartType('weekly')">Week</button>
              <button class="chart-btn" onclick="changeChartType('monthly')">Month</button>
              <button class="chart-btn" onclick="changeChartType('yearly')">Year</button>
            </div>
          </div>
          <div id="chartContainer" style="width: 100%; height: 250px;">
            <canvas id="trendChart" style="width: 100%; height: 100%;"></canvas>
          </div>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">Drink Distribution</div>
            <div class="chart-actions">
              <button class="chart-btn active" onclick="changePieType('today')">Today</button>
              <button class="chart-btn" onclick="changePieType('week')">Week</button>
              <button class="chart-btn" onclick="changePieType('month')">Month</button>
            </div>
          </div>
          <div id="pieContainer" style="width: 100%; height: 250px;">
            <canvas id="distributionChart" style="width: 100%; height: 100%;"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-calendar-alt" style="color: var(--accent); margin-right: 10px;"></i>Monthly Overview</h3>
      <div id="calendarContainer" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">
        <!-- Calendar will be generated here -->
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 20px;">
        <button class="btn-small" onclick="prevMonth()"><i class="fas fa-chevron-left"></i> Prev</button>
        <span id="currentMonth" style="font-weight: 600; color: var(--accent);">January 2024</span>
        <button class="btn-small" onclick="nextMonth()">Next <i class="fas fa-chevron-right"></i></button>
      </div>
    </div>
  </div>

  <!-- Profile Screen -->
  <div id="profileScreen" class="screen" style="display: none;">
    <div class="card">
      <div class="modal-header">
        <h3><i class="fas fa-user-cog"></i> Profile Settings</h3>
        <button class="close-btn" onclick="closeProfile()"><i class="fas fa-times"></i></button>
      </div>

      <div class="input-group">
        <label class="input-label">Your Name</label>
        <input type="text" class="manual-input" id="userNameInput" placeholder="Enter your name">
      </div>

      <!-- Gender Selection -->
      <div class="input-group">
        <label class="input-label">Gender</label>
        <div class="gender-selector">
          <div class="gender-option" data-gender="male" onclick="selectGender('male')">
            <i class="fas fa-mars"></i> Male
          </div>
          <div class="gender-option" data-gender="female" onclick="selectGender('female')">
            <i class="fas fa-venus"></i> Female
          </div>
          <div class="gender-option" data-gender="other" onclick="selectGender('other')">
            <i class="fas fa-genderless"></i> Other
          </div>
        </div>
      </div>

      <div class="ruler-section">
        <label class="input-label">
          <span id="weightLabel">Weight (kg)</span>
          <div class="unit-conversion">
            <button class="unit-conversion-btn active" data-unit="metric" onclick="setWeightUnit('metric')">kg/cm</button>
            <button class="unit-conversion-btn" data-unit="imperial" onclick="setWeightUnit('imperial')">lbs/ft</button>
          </div>
        </label>
        <div class="ruler-value-display">
          <span id="weightValue">70</span>
          <span id="weightUnit">kg</span>
        </div>
        <div class="input-with-controls">
          <input type="number" class="manual-input" id="weightInput" min="30" max="200" step="1" value="70" onchange="updateWeightFromInput()">
          <button class="unit-btn" onclick="adjustWeight(-1)">-1</button>
          <button class="unit-btn" onclick="adjustWeight(1)">+1</button>
        </div>
        <div class="ruler-container">
          <div class="ruler-track"></div>
          <div class="center-indicator"></div>
          <div class="ruler-scroll" id="weightRuler"></div>
        </div>
      </div>

      <div class="ruler-section">
        <label class="input-label">
          <span id="heightLabel">Height (cm)</span>
        </label>
        <div class="ruler-value-display">
          <span id="heightValue">170</span>
          <span id="heightUnit">cm</span>
        </div>
        <div class="input-with-controls">
          <input type="number" class="manual-input" id="heightInput" min="100" max="250" step="1" value="170" onchange="updateHeightFromInput()">
          <button class="unit-btn" onclick="adjustHeight(-1)">-1</button>
          <button class="unit-btn" onclick="adjustHeight(1)">+1</button>
        </div>
        <div class="ruler-container">
          <div class="ruler-track"></div>
          <div class="center-indicator"></div>
          <div class="ruler-scroll" id="heightRuler"></div>
        </div>
      </div>

      <div class="age-selector">
        <label class="input-label">Age</label>
        <div class="age-display" id="ageValue">25</div>
        <div class="age-controls">
          <button class="age-btn" onclick="adjustAge(-1)"><i class="fas fa-minus"></i></button>
          <input type="number" class="manual-input" id="ageManualInput" min="10" max="100" value="25" style="width: 100px;" onchange="updateAgeFromInput()">
          <button class="age-btn" onclick="adjustAge(1)"><i class="fas fa-plus"></i></button>
        </div>
        <div class="input-with-controls">
          <button class="unit-btn" onclick="setAge(18)">18</button>
          <button class="unit-btn" onclick="setAge(25)">25</button>
          <button class="unit-btn" onclick="setAge(35)">35</button>
          <button class="unit-btn" onclick="setAge(50)">50</button>
        </div>
      </div>

      <!-- Activity Level -->
      <div class="input-group">
        <label class="input-label">Activity Level</label>
        <div class="activity-levels">
          <div class="activity-level" data-level="sedentary" onclick="selectActivityLevel('sedentary')">
            <span>Sedentary</span>
            <span class="activity-info">Little or no exercise</span>
          </div>
          <div class="activity-level" data-level="light" onclick="selectActivityLevel('light')">
            <span>Lightly Active</span>
            <span class="activity-info">Light exercise 1-3 days/week</span>
          </div>
          <div class="activity-level active" data-level="moderate" onclick="selectActivityLevel('moderate')">
            <span>Moderately Active</span>
            <span class="activity-info">Moderate exercise 3-5 days/week</span>
          </div>
          <div class="activity-level" data-level="active" onclick="selectActivityLevel('active')">
            <span>Very Active</span>
            <span class="activity-info">Hard exercise 6-7 days/week</span>
          </div>
          <div class="activity-level" data-level="athlete" onclick="selectActivityLevel('athlete')">
            <span>Extremely Active</span>
            <span class="activity-info">Very hard exercise & physical job</span>
          </div>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Daily Goal (ml)</label>
        <div class="input-with-controls">
          <input type="number" class="manual-input" id="dailyGoalInput" min="1000" max="5000" step="50" value="2000">
          <button class="unit-btn" onclick="calculateRecommendedGoal()">Recommended</button>
        </div>
      </div>

      <button class="btn" onclick="saveProfile()" style="margin-top: 30px;">
        <i class="fas fa-save"></i> Save Profile
      </button>
    </div>

    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-bell" style="color: var(--accent); margin-right: 10px;"></i>Reminders</h3>
      
      <div class="input-group">
        <label class="input-label">Enable Reminders</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="remindersEnabled" checked style="width: 20px; height: 20px;">
            <span>Enable daily reminders</span>
          </label>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Reminder Time</label>
        <input type="time" class="manual-input" id="reminderTime" value="09:00">
      </div>

      <div class="input-group">
        <label class="input-label">Reminder Frequency</label>
        <select class="manual-input" id="reminderFrequency">
          <option value="1">Every hour</option>
          <option value="2" selected>Every 2 hours</option>
          <option value="3">Every 3 hours</option>
          <option value="4">Every 4 hours</option>
        </select>
      </div>

      <button class="btn-secondary" onclick="testReminder()" style="margin-top: 10px;">
        <i class="fas fa-bell"></i> Test Reminder
      </button>
    </div>

    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-download" style="color: var(--accent); margin-right: 10px;"></i>Data Management</h3>
      
      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button class="btn-small" onclick="exportData()">
          <i class="fas fa-file-export"></i> Export Data
        </button>
        <button class="btn-small btn-secondary" onclick="importData()">
          <i class="fas fa-file-import"></i> Import Data
        </button>
        <button class="btn-small" onclick="resetData()" style="background: var(--danger);">
          <i class="fas fa-trash"></i> Reset All
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Navigation -->
<div class="nav">
  <div class="nav-item active" onclick="showScreen('dashboard')">
    <i class="fas fa-home"></i>
    <span>Home</span>
  </div>
  <div class="nav-item" onclick="openDrinkModal()">
    <i class="fas fa-plus-circle"></i>
    <span>Add</span>
  </div>
  <div class="nav-item" onclick="showScreen('statsScreen')">
    <i class="fas fa-chart-bar"></i>
    <span>Stats</span>
  </div>
  <div class="nav-item" onclick="showScreen('profileScreen')">
    <i class="fas fa-cog"></i>
    <span>Settings</span>
  </div>
</div>

<!-- Drink Selection Modal -->
<div class="modal" id="drinkModal">
  <div class="modal-content card">
    <div class="modal-header">
      <h3><i class="fas fa-wine-bottle"></i> Add Drink</h3>
      <button class="close-btn" onclick="closeModal('drinkModal')"><i class="fas fa-times"></i></button>
    </div>

    <div class="drink-grid" id="drinkGrid"></div>
  </div>
</div>

<!-- Amount Selection Modal -->
<div class="modal" id="amountModal">
  <div class="modal-content card">
    <div class="modal-header">
      <h3 id="amountTitle"><i class="fas fa-tint"></i> Select Amount</h3>
      <button class="close-btn" onclick="closeModal('amountModal')"><i class="fas fa-times"></i></button>
    </div>

    <div id="waterContentInfo" style="text-align: center; margin: 15px 0; padding: 15px; background: var(--glass); border-radius: 12px; border: 1px solid var(--glass-border);"></div>

    <div class="amount-grid" id="amountGrid"></div>

    <div style="margin-top: 20px;">
      <input type="number" class="custom-amount" id="customAmount" placeholder="Enter custom amount (ml)" min="1" max="5000">
    </div>

    <button class="btn" onclick="confirmDrink()" style="margin-top: 20px;">
      <i class="fas fa-check"></i> Add Drink
    </button>
  </div>
</div>

<!-- Date Detail Modal -->
<div class="modal" id="dateDetailModal">
  <div class="modal-content card">
    <div class="modal-header">
      <h3><i class="fas fa-calendar-day"></i> Daily Details</h3>
      <button class="close-btn" onclick="closeModal('dateDetailModal')"><i class="fas fa-times"></i></button>
    </div>
    <div id="dateDetailContent">
      <!-- Content will be populated by JavaScript -->
    </div>
    <button class="btn-secondary" onclick="closeModal('dateDetailModal')" style="margin-top: 20px;">
      Close
    </button>
  </div>
</div>

<!-- Achievements Modal -->
<div class="modal" id="achievementsModal">
  <div class="modal-content card">
    <div class="modal-header">
      <h3><i class="fas fa-trophy"></i> Achievements</h3>
      <button class="close-btn" onclick="closeModal('achievementsModal')"><i class="fas fa-times"></i></button>
    </div>
    <div id="achievementsContent" style="margin: 20px 0;">
      <!-- Achievements will be populated here -->
    </div>
    <button class="btn-secondary" onclick="closeModal('achievementsModal')" style="margin-top: 20px;">
      Close
    </button>
  </div>
</div>

<!-- Welcome Modal for New Users -->
<div class="modal welcome-modal" id="welcomeModal">
  <div class="modal-content card">
    <div class="modal-header">
      <h3><i class="fas fa-glass-water"></i> Welcome to Waterify Pro!</h3>
    </div>
    <div style="text-align: center; padding: 20px;">
      <i class="fas fa-tint" style="font-size: 64px; color: var(--accent); margin-bottom: 20px;"></i>
      <h3 style="margin: 0 0 10px 0;">Let's Set Up Your Profile</h3>
      <p style="color: var(--muted); margin-bottom: 30px;">To provide accurate hydration recommendations, we need some information about you.</p>
      <button class="btn" onclick="closeModal('welcomeModal'); openProfile();">
        <i class="fas fa-user-cog"></i> Set Up Profile
      </button>
    </div>
  </div>
</div>

<!-- Notification -->
<div id="notification" class="notification">
  <i class="fas fa-check-circle"></i> <span id="notificationText">Drink added successfully!</span>
</div>

<!-- Import Data Input (Hidden) -->
<input type="file" id="importFile" accept=".json" style="display: none;">

<script>
// ============================================
// WATERIFY PRO - Enhanced Hydration Tracker
// ============================================

// ===== NEW: ACHIEVEMENT ANIMATION FUNCTIONS =====
let hasNewAchievements = false;

function showAchievementPopup(achievement) {
  const popup = document.getElementById('achievementPopup');
  const title = document.getElementById('achievementPopupTitle');
  const desc = document.getElementById('achievementPopupDesc');
  const badgeIcon = document.getElementById('achievementBadgeIcon');
  
  // Set achievement details
  title.textContent = achievement.name;
  desc.textContent = `ðŸŽ‰ ${achievement.description}`;
  badgeIcon.innerHTML = `<i class="fas ${achievement.icon}"></i>`;
  
  // Show popup
  popup.classList.add('show');
  
  // Create confetti effect
  createConfetti();
  
  // Play sound if available
  if (typeof Audio !== 'undefined') {
    try {
      const achievementSound = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ');
      achievementSound.volume = 0.3;
      achievementSound.play().catch(() => {});
    } catch (e) {}
  }
  
  // Update achievement badge to show gold effect
  const achievementBadge = document.getElementById('achievementBadge');
  achievementBadge.classList.add('has-new');
  hasNewAchievements = true;
}

function closeAchievementPopup() {
  const popup = document.getElementById('achievementPopup');
  popup.classList.remove('show');
}

function createConfetti() {
  const container = document.getElementById('confettiContainer');
  container.innerHTML = '';
  
  const colors = ['#4fd1ff', '#6b7cff', '#FFD700', '#FFA500', '#4dff88', '#ff4d6d'];
  
  for (let i = 0; i < 150; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti-piece';
    
    // Random properties
    const color = colors[Math.floor(Math.random() * colors.length)];
    const size = Math.random() * 10 + 5;
    const left = Math.random() * 100;
    const duration = Math.random() * 2 + 1;
    const delay = Math.random() * 0.5;
    
    confetti.style.cssText = `
      width: ${size}px;
      height: ${size}px;
      background: ${color};
      left: ${left}%;
      border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
      animation: confettiFall ${duration}s ease-out ${delay}s forwards;
    `;
    
    container.appendChild(confetti);
    
    // Remove after animation
    setTimeout(() => {
      if (confetti.parentNode) {
        confetti.parentNode.removeChild(confetti);
      }
    }, (duration + delay) * 1000);
  }
}

// Add confetti animation keyframes
const style = document.createElement('style');
style.textContent = `
@keyframes confettiFall {
  0% {
    transform: translateY(-100px) rotate(0deg) scale(0);
    opacity: 1;
  }
  100% {
    transform: translateY(100vh) rotate(360deg) scale(1);
    opacity: 0;
  }
}
`;
document.head.appendChild(style);

// ===== UPDATED: CHECK AND UPDATE ACHIEVEMENTS =====
function checkAndUpdateAchievements() {
  if (!appState.profile) return;
  
  const achievements = appState.profile.achievements || {};
  let newAchievements = [];
  
  ACHIEVEMENTS.forEach(achievement => {
    if (!achievements[achievement.id] || !achievements[achievement.id].unlocked) {
      if (achievement.condition(appState.profile, appState.todayData, appState.historicalData)) {
        if (!achievements[achievement.id]) {
          achievements[achievement.id] = {
            unlocked: true,
            unlockedAt: new Date().toISOString()
          };
          newAchievements.push(achievement);
        }
      }
    }
  });
  
  appState.profile.achievements = achievements;
  
  // Show beautiful popup for new achievements
  if (newAchievements.length > 0) {
    // Show first achievement immediately
    showAchievementPopup(newAchievements[0]);
    
    // Queue remaining achievements
    for (let i = 1; i < newAchievements.length; i++) {
      setTimeout(() => {
        showAchievementPopup(newAchievements[i]);
      }, i * 3000); // Show each achievement 3 seconds apart
    }
    
    saveAllData();
  }
}

// ===== UPDATED: TIME PROGRESS - 24 HOUR COVERAGE =====
function updateTimeProgress() {
  const container = document.getElementById('timeProgress');
  
  // Define 8 time slots covering 24 hours (3 hours each)
  const timeSlots = [
    { label: "12-3 AM", start: 0, end: 3, isNight: true },
    { label: "3-6 AM", start: 3, end: 6, isNight: true },
    { label: "6-9 AM", start: 6, end: 9, isNight: false },
    { label: "9-12 PM", start: 9, end: 12, isNight: false },
    { label: "12-3 PM", start: 12, end: 15, isNight: false },
    { label: "3-6 PM", start: 15, end: 18, isNight: false },
    { label: "6-9 PM", start: 18, end: 21, isNight: true },
    { label: "9-12 AM", start: 21, end: 24, isNight: true }
  ];
  
  const currentHour = new Date().getHours();
  
  container.innerHTML = '';
  
  timeSlots.forEach(slot => {
    const div = document.createElement('div');
    div.className = 'time-slot';
    
    // Add night class for evening/morning slots
    if (slot.isNight) {
      div.classList.add('night');
    }
    
    // Check if current hour falls in this slot
    if (currentHour >= slot.start && currentHour < slot.end) {
      div.classList.add('active');
    }
    
    // Calculate drinks in this time slot
    const drinksInSlot = appState.todayData?.drinks?.filter(drink => {
      const drinkHour = new Date(drink.timestamp).getHours();
      return drinkHour >= slot.start && drinkHour < slot.end;
    }) || [];
    
    const totalInSlot = drinksInSlot.reduce((sum, drink) => sum + drink.amount, 0);
    
    div.innerHTML = `
      <div class="time-label">${slot.label}</div>
      <div class="time-value">${totalInSlot}ml</div>
    `;
    
    // Add hover effect
    div.title = `${drinksInSlot.length} drink${drinksInSlot.length !== 1 ? 's' : ''} in this period`;
    
    container.appendChild(div);
  });
}

// ===== NEW: REMOVE DRINK FUNCTIONALITY =====
function removeDrink(timestamp) {
  if (!appState.todayData || !appState.todayData.drinks) return;
  
  const drinkIndex = appState.todayData.drinks.findIndex(d => d.timestamp === timestamp);
  
  if (drinkIndex === -1) return;
  
  const drink = appState.todayData.drinks[drinkIndex];
  
  // Remove drink from array
  appState.todayData.drinks.splice(drinkIndex, 1);
  
  // Update total consumed
  appState.todayData.consumed -= drink.waterContent;
  
  // Update goal completion status
  if (appState.todayData.completed && appState.todayData.consumed < appState.todayData.goal) {
    appState.todayData.completed = false;
  }
  
  // Save and update UI
  saveAllData();
  updateDashboard();
  updateStatistics();
  updateTimeProgress();
  
  showNotification(`Removed ${drink.amount}ml of ${BEVERAGES[drink.type].name}`, "success");
}

// ===== UPDATED: UPDATE RECENT ACTIVITY WITH DELETE BUTTONS =====
function updateRecentActivity() {
  const container = document.getElementById('recentActivity');
  const countElement = document.getElementById('activityCount');
  
  if (!appState.todayData?.drinks) {
    container.innerHTML = `
      <div style="text-align: center; padding: 20px; color: var(--muted);">
        <i class="fas fa-tint" style="font-size: 24px; margin-bottom: 10px; display: block; opacity: 0.5;"></i>
        No drinks added yet today
      </div>
    `;
    countElement.textContent = '0';
    return;
  }
  
  const recentDrinks = appState.todayData.drinks.slice(-5).reverse();
  countElement.textContent = appState.todayData.drinks.length;
  
  if (recentDrinks.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 20px; color: var(--muted);">
        <i class="fas fa-tint" style="font-size: 24px; margin-bottom: 10px; display: block; opacity: 0.5;"></i>
        No drinks added yet today
      </div>
    `;
    return;
  }
  
  container.innerHTML = '';
  recentDrinks.forEach(drink => {
    const beverage = BEVERAGES[drink.type];
    if (!beverage) return;
    
    const item = document.createElement('div');
    item.className = 'recent-activity-item';
    
    const timeAgo = getTimeAgo(drink.timestamp);
    
    item.innerHTML = `
      <div style="display: flex; align-items: center; gap: 12px;">
        <i class="fas ${beverage.icon}" style="color: ${beverage.color}; font-size: 20px;"></i>
        <div>
          <div style="font-weight: 600; font-size: 14px;">${beverage.name}</div>
          <div style="font-size: 12px; color: var(--muted);">${timeAgo} â€¢ ${drink.time}</div>
        </div>
      </div>
      <div style="text-align: right;">
        <div style="font-weight: 700; font-size: 16px;">${drink.amount}ml</div>
        <div style="font-size: 11px; color: var(--accent);">${drink.waterContent}ml water</div>
      </div>
      <div class="recent-activity-delete" onclick="event.stopPropagation(); removeDrink('${drink.timestamp}')" title="Remove this drink">
        <i class="fas fa-times"></i>
      </div>
    `;
    
    container.appendChild(item);
  });
  
  // Add "Clear All" button if there are drinks
  if (appState.todayData.drinks.length > 0) {
    const clearAllBtn = document.createElement('button');
    clearAllBtn.className = 'btn-secondary';
    clearAllBtn.style.cssText = 'width: 100%; margin-top: 10px; padding: 10px; font-size: 14px;';
    clearAllBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Clear All Drinks';
    clearAllBtn.onclick = () => {
      if (confirm('Are you sure you want to remove all drinks from today?')) {
        appState.todayData.drinks = [];
        appState.todayData.consumed = 0;
        appState.todayData.completed = false;
        saveAllData();
        updateDashboard();
        updateRecentActivity();
        showNotification('All drinks removed', 'success');
      }
    };
    container.appendChild(clearAllBtn);
  }
}

function getTimeAgo(timestamp) {
  const now = new Date();
  const drinkTime = new Date(timestamp);
  const diffMs = now - drinkTime;
  const diffMins = Math.floor(diffMs / (1000 * 60));
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  
  const diffHours = Math.floor(diffMins / 60);
  if (diffHours < 24) return `${diffHours}h ago`;
  
  return 'Today';
}

// ===== UPDATED: DATE DETAIL MODAL WITH DELETE OPTIONS =====
function showDateDetails(dateStr, dayData) {
  const modal = document.getElementById('dateDetailModal');
  const content = document.getElementById('dateDetailContent');
  
  const date = new Date(dateStr);
  const formattedDate = date.toLocaleDateString('en-US', { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
  
  if (dayData) {
    const goal = appState.profile?.dailyGoal || 2000;
    const progress = Math.round((dayData.consumed / goal) * 100);
    const drinksCount = dayData.drinks ? dayData.drinks.length : 0;
    
    let drinksHtml = '';
    if (dayData.drinks && dayData.drinks.length > 0) {
      drinksHtml = '<div style="margin-top: 15px;"><strong>Drinks:</strong><ul style="margin: 10px 0 0 0; padding-left: 0; list-style: none;">';
      dayData.drinks.forEach((drink, index) => {
        const beverage = BEVERAGES[drink.type];
        drinksHtml += `
          <li style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--glass); border-radius: 8px; margin-bottom: 5px; position: relative;">
            <div>
              <i class="fas ${beverage.icon}" style="color: ${beverage.color}; margin-right: 8px;"></i>
              ${drink.amount}ml ${beverage.name}
              <div style="font-size: 11px; color: var(--muted);">${drink.time}</div>
            </div>
            <button onclick="removeHistoricalDrink('${dateStr}', ${index})" style="background: var(--danger); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px;" title="Remove this drink">
              <i class="fas fa-times"></i>
            </button>
          </li>
        `;
      });
      drinksHtml += '</ul></div>';
    }
    
    content.innerHTML = `
      <h4 style="margin: 0 0 15px 0; color: var(--accent);">${formattedDate}</h4>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
        <div style="text-align: center; padding: 15px; background: var(--glass); border-radius: 12px;">
          <div style="font-size: 24px; font-weight: 700; color: var(--accent);">${dayData.consumed}ml</div>
          <div style="font-size: 12px; color: var(--muted);">Total Consumed</div>
        </div>
        <div style="text-align: center; padding: 15px; background: var(--glass); border-radius: 12px;">
          <div style="font-size: 24px; font-weight: 700; color: ${progress >= 100 ? 'var(--success)' : progress >= 75 ? '#a6ff4d' : progress >= 50 ? 'var(--warning)' : '#ff9966'};">${progress}%</div>
          <div style="font-size: 12px; color: var(--muted);">Goal Progress</div>
        </div>
        <div style="text-align: center; padding: 15px; background: var(--glass); border-radius: 12px;">
          <div style="font-size: 24px; font-weight: 700; color: var(--accent);">${drinksCount}</div>
          <div style="font-size: 12px; color: var(--muted);">Number of Drinks</div>
        </div>
        <div style="text-align: center; padding: 15px; background: var(--glass); border-radius: 12px;">
          <div style="font-size: 24px; font-weight: 700; color: ${dayData.completed ? 'var(--success)' : 'var(--danger)'};">${dayData.completed ? 'âœ“' : 'âœ—'}</div>
          <div style="font-size: 12px; color: var(--muted);">Goal ${dayData.completed ? 'Achieved' : 'Not Met'}</div>
        </div>
      </div>
      ${drinksHtml}
      ${drinksCount > 0 ? `
        <button class="btn-small" onclick="removeAllDrinksFromDate('${dateStr}')" style="background: var(--danger); width: 100%; margin-top: 10px;">
          <i class="fas fa-trash"></i> Remove All Drinks from This Day
        </button>
      ` : ''}
    `;
  } else {
    content.innerHTML = `
      <h4 style="margin: 0 0 15px 0; color: var(--accent);">${formattedDate}</h4>
      <div style="text-align: center; padding: 40px 20px;">
        <i class="fas fa-tint" style="font-size: 48px; color: var(--muted); opacity: 0.5; margin-bottom: 20px;"></i>
        <p style="color: var(--muted);">No hydration data recorded for this day.</p>
      </div>
    `;
  }
  
  openModal('dateDetailModal');
}

// ===== NEW: REMOVE DRINK FROM HISTORICAL DATA =====
function removeHistoricalDrink(dateStr, index) {
  if (!appState.historicalData[dateStr] || !appState.historicalData[dateStr].drinks) return;
  
  const dayData = appState.historicalData[dateStr];
  const drink = dayData.drinks[index];
  
  // Remove drink
  dayData.drinks.splice(index, 1);
  
  // Recalculate total consumed
  dayData.consumed = dayData.drinks.reduce((sum, d) => sum + d.waterContent, 0);
  
  // Update completion status
  const goal = appState.profile?.dailyGoal || 2000;
  dayData.completed = dayData.consumed >= goal;
  
  saveAllData();
  showDateDetails(dateStr, dayData);
  updateDashboard();
  
  showNotification(`Removed ${drink.amount}ml from ${new Date(dateStr).toLocaleDateString()}`, "success");
}

function removeAllDrinksFromDate(dateStr) {
  if (!appState.historicalData[dateStr]) return;
  
  if (confirm('Are you sure you want to remove all drinks from this day?')) {
    appState.historicalData[dateStr].drinks = [];
    appState.historicalData[dateStr].consumed = 0;
    appState.historicalData[dateStr].completed = false;
    
    saveAllData();
    showDateDetails(dateStr, appState.historicalData[dateStr]);
    updateDashboard();
    
    showNotification('All drinks removed from this day', 'success');
  }
}

// ===== UPDATED: INITIALIZE APP WITH ENHANCEMENTS =====
function initializeApp() {
  // Load all data
  loadAllData();
  
  // Check if user is new (no profile exists)
  const isNewUser = !appState.profile || !appState.profile.name || appState.profile.name === "User";
  
  // Initialize default profile if none exists
  if (!appState.profile) {
    appState.profile = {
      name: "User",
      weight: 70,
      height: 170,
      age: 25,
      gender: "male",
      activityLevel: "moderate",
      dailyGoal: 2000,
      createdAt: new Date().toISOString(),
      currentStreak: 0,
      bestStreak: 0,
      unitSystem: 'metric',
      achievements: {}
    };
  }
  
  // Set unit system
  appState.unitSystem = appState.profile.unitSystem || 'metric';
  
  // Initialize today's data
  const today = new Date().toDateString();
  const todayData = JSON.parse(localStorage.getItem('waterify_today'));
  
  if (!todayData || todayData.date !== today) {
    // Check and update streak
    checkAndUpdateStreak();
    
    // Save yesterday's data to history if it exists
    if (todayData && todayData.date !== today) {
      appState.historicalData[todayData.date] = todayData;
      saveAllData();
    }
    
    // Create new day data
    appState.todayData = {
      date: today,
      consumed: 0,
      drinks: [],
      goal: appState.profile.dailyGoal,
      completed: false
    };
  } else {
    appState.todayData = todayData;
  }
  
  // Initialize settings
  if (!appState.settings.reminders) {
    appState.settings = {
      reminders: {
        enabled: true,
        frequency: 2,
        time: "09:00"
      }
    };
  }
  
  // Update UI
  updateDashboard();
  updateProfileUI();
  updateTimeProgress();
  setupReminders();
  
  // Set greeting message
  updateGreetingMessage();
  
  // Initialize charts
  setTimeout(() => {
    if (typeof Chart !== 'undefined') {
      initializeCharts();
    }
  }, 100);
  
  // Create water drop animations
  createWaterDrops();
  
  // Check achievements on startup
  checkAndUpdateAchievements();
  
  // Show welcome modal for new users
  if (isNewUser) {
    setTimeout(() => {
      openModal('welcomeModal');
    }, 500);
  }
}

// ===== UPDATED: SHOW ACHIEVEMENTS MODAL =====
function showAchievementsModal() {
  const content = document.getElementById('achievementsContent');
  content.innerHTML = '';
  
  if (!appState.profile || !appState.profile.achievements) {
    content.innerHTML = '<p style="text-align: center; color: var(--muted);">No achievements yet. Keep hydrating!</p>';
    openModal('achievementsModal');
    return;
  }
  
  const achievementsGrid = document.createElement('div');
  achievementsGrid.className = 'achievements-grid';
  
  ACHIEVEMENTS.forEach(achievement => {
    const achievementData = appState.profile.achievements[achievement.id];
    const isUnlocked = achievementData && achievementData.unlocked;
    
    const item = document.createElement('div');
    item.className = `achievement-item ${isUnlocked ? 'unlocked' : 'locked'}`;
    
    item.innerHTML = `
      <div class="achievement-icon" style="background: ${isUnlocked ? 'linear-gradient(135deg, var(--accent), var(--accent2))' : 'var(--glass)'};">
        <i class="fas ${achievement.icon}" style="color: ${isUnlocked ? '#000' : 'var(--muted)'};"></i>
      </div>
      <div class="achievement-name">${achievement.name}</div>
      <div class="achievement-desc">${achievement.description}</div>
      ${isUnlocked && achievementData.unlockedAt ? 
        `<div class="achievement-date" style="color: var(--accent);">ðŸŽ‰ ${new Date(achievementData.unlockedAt).toLocaleDateString()}</div>` : 
        '<div class="achievement-date" style="color: var(--muted);">ðŸ”’ Locked</div>'}
    `;
    
    achievementsGrid.appendChild(item);
  });
  
  content.appendChild(achievementsGrid);
  
  // Reset new achievement indicator
  const achievementBadge = document.getElementById('achievementBadge');
  achievementBadge.classList.remove('has-new');
  hasNewAchievements = false;
  
  openModal('achievementsModal');
}

// ===== ENHANCED ADD DRINK WITH ANIMATION =====
function addDrink(type, amount) {
  const drink = BEVERAGES[type];
  if (!drink) return;
  
  // Add the full water content amount
  const waterContent = Math.round(amount * drink.waterContent / 100);
  
  const drinkRecord = {
    type,
    amount,
    waterContent,
    timestamp: new Date().toISOString(),
    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
  };
  
  // Add waterContent to consumed
  appState.todayData.consumed += waterContent;
  if (!appState.todayData.drinks) appState.todayData.drinks = [];
  appState.todayData.drinks.push(drinkRecord);
  
  // Check if goal achieved
  if (!appState.todayData.completed && appState.todayData.consumed >= appState.todayData.goal) {
    appState.todayData.completed = true;
    showNotification("ðŸŽ‰ Daily goal achieved! Amazing work!", "success");
    
    // Add water drop celebration
    createWaterDrops(true);
  }
  
  // Check for achievements
  checkAndUpdateAchievements();
  
  saveAllData();
  updateDashboard();
  updateStatistics();
  updateTimeProgress();
  
  // Enhanced notification with animation
  showNotification(`âœ¨ Added ${amount}ml of ${drink.name} (${waterContent}ml water)`, "success");
}

// ===== ENHANCED WATER DROPS =====
function createWaterDrops(celebration = false) {
  const container = document.getElementById('waterDropsContainer');
  if (!container) return;
  
  const dropCount = celebration ? 30 : 15;
  
  for (let i = 0; i < dropCount; i++) {
    setTimeout(() => {
      const drop = document.createElement('div');
      drop.className = 'water-drop';
      drop.style.left = `${Math.random() * 100}%`;
      drop.style.animationDelay = `${Math.random() * 2}s`;
      drop.style.width = `${Math.random() * 10 + 5}px`;
      drop.style.height = `${Math.random() * 20 + 10}px`;
      drop.style.opacity = Math.random() * 0.3 + 0.1;
      
      if (celebration) {
        drop.style.background = `linear-gradient(180deg, 
          rgba(123, 231, 255, 0.9) 0%,
          rgba(255, 215, 0, 0.9) 100%)`;
      }
      
      container.appendChild(drop);
      
      setTimeout(() => {
        if (drop.parentNode) {
          drop.parentNode.removeChild(drop);
        }
      }, 1500);
    }, i * (celebration ? 100 : 300));
  }
  
  if (!celebration) {
    setTimeout(createWaterDrops, 15000);
  }
}

// ===== UPDATED: UPDATE DASHBOARD =====
function updateDashboard() {
  if (!appState.todayData) return;
  
  const consumed = appState.todayData.consumed || 0;
  const goal = appState.todayData.goal || appState.profile?.dailyGoal || 2000;
  const progress = Math.min(Math.round((consumed / goal) * 100), 100);
  
  // Animate progress bar
  const progressFill = document.getElementById('progressFill');
  progressFill.style.transition = 'width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1)';
  progressFill.style.width = `${progress}%`;
  
  // Animate water level
  const waterLevel = document.getElementById('waterLevel');
  waterLevel.style.transition = 'height 0.8s cubic-bezier(0.34, 1.56, 0.64, 1)';
  waterLevel.style.height = `${progress}%`;
  
  document.getElementById('progressText').textContent = `${progress}%`;
  document.getElementById('consumedDisplay').textContent = `${consumed.toLocaleString()} ml`;
  document.getElementById('goalDisplay').textContent = `of ${goal.toLocaleString()} ml goal`;
  document.getElementById('drinksCount').textContent = appState.todayData.drinks?.length || 0;
  document.getElementById('streakCount').textContent = appState.profile?.currentStreak || 0;
  
  // Today's best drink
  const todayDrinks = appState.todayData.drinks || [];
  const todayBest = todayDrinks.length > 0 ? Math.max(...todayDrinks.map(d => d.amount)) : 0;
  document.getElementById('todayBest').textContent = `${todayBest}ml`;
  
  // Update quick stats
  updateQuickStats();
  
  // Update recent activity
  updateRecentActivity();
  
  // Update hydration tip
  updateHydrationTip();
  
  // Update user name display
  if (appState.profile?.name) {
    document.getElementById('userName').textContent = appState.profile.name;
  }
}

// ===== ENHANCED NOTIFICATION =====
function showNotification(message, type = 'success') {
  const notification = document.getElementById('notification');
  const text = document.getElementById('notificationText');
  
  text.textContent = message;
  
  if (type === 'error') {
    notification.style.background = 'linear-gradient(135deg, var(--danger), #ff6b6b)';
    notification.style.color = '#000';
  } else if (type === 'reminder') {
    notification.style.background = 'linear-gradient(135deg, var(--secondary), #8b5cf6)';
    notification.style.color = '#000';
  } else if (type === 'achievement') {
    notification.style.background = 'linear-gradient(135deg, #FFD700, #FFA500)';
    notification.style.color = '#000';
  } else {
    notification.style.background = 'linear-gradient(135deg, var(--accent), var(--accent2))';
    notification.style.color = '#000';
  }
  
  notification.style.display = 'block';
  notification.classList.add('show');
  
  // Add vibration if available
  if (navigator.vibrate) {
    navigator.vibrate(50);
  }
  
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      notification.style.display = 'none';
    }, 500);
  }, 3000);
}

// ===== KEEP ALL OTHER FUNCTIONS EXACTLY AS THEY WERE =====
// (All the original code remains unchanged below this point)

// Beverage database
const BEVERAGES = {
  water: {
    name: "Water",
    icon: "fa-tint",
    color: "#4fd1ff",
    waterContent: 100,
    description: "Pure hydration - no additives"
  },
  sparkling_water: {
    name: "Sparkling Water",
    icon: "fa-glass-water",
    color: "#6b7cff",
    waterContent: 100,
    description: "Carbonated water - same hydration"
  },
  herbal_tea: {
    name: "Herbal Tea",
    icon: "fa-mug-hot",
    color: "#ffb84d",
    waterContent: 99,
    description: "No caffeine - excellent hydration"
  },
  green_tea: {
    name: "Green Tea",
    icon: "fa-leaf",
    color: "#4dff88",
    waterContent: 99,
    description: "Antioxidants - minimal caffeine"
  },
  black_coffee: {
    name: "Black Coffee",
    icon: "fa-coffee",
    color: "#8B4513",
    waterContent: 98,
    description: "Caffeine reduces hydration by 15%"
  },
  milk: {
    name: "Milk",
    icon: "fa-cow",
    color: "#ffffff",
    waterContent: 87,
    description: "Contains nutrients - good hydration"
  },
  fruit_juice: {
    name: "Fruit Juice",
    icon: "fa-apple-alt",
    color: "#ff6b6b",
    waterContent: 88,
    description: "Natural sugars - moderate hydration"
  },
  sports_drink: {
    name: "Sports Drink",
    icon: "fa-bolt",
    color: "#ff4d6d",
    waterContent: 94,
    description: "Electrolytes - good for exercise"
  },
  soda: {
    name: "Soda",
    icon: "fa-glass-whiskey",
    color: "#ff4757",
    waterContent: 90,
    description: "High sugar - poor hydration"
  },
  smoothie: {
    name: "Smoothie",
    icon: "fa-blender",
    color: "#9d4edd",
    waterContent: 85,
    description: "Nutrient-rich - good hydration"
  }
};

// Achievements database
const ACHIEVEMENTS = [
  {
    id: 'first_drink',
    name: 'First Sip',
    description: 'Added your first drink',
    icon: 'fa-tint',
    condition: (profile, todayData, historicalData) => {
      const totalDrinks = (todayData?.drinks?.length || 0) + 
                         Object.values(historicalData).reduce((sum, day) => sum + (day.drinks?.length || 0), 0);
      return totalDrinks >= 1;
    }
  },
  {
    id: 'first_streak',
    name: 'Streak Starter',
    description: 'Achieved a 3-day streak',
    icon: 'fa-fire',
    condition: (profile) => profile.currentStreak >= 3
  },
  {
    id: 'hydrated_beginner',
    name: 'Hydration Beginner',
    description: 'Reached daily goal for first time',
    icon: 'fa-star',
    condition: (profile, todayData, historicalData) => {
      const completedDays = Object.values(historicalData).filter(d => d.completed).length;
      return completedDays >= 1;
    }
  },
  {
    id: 'week_warrior',
    name: 'Week Warrior',
    description: 'Completed a full week of hydration',
    icon: 'fa-calendar-week',
    condition: (profile, todayData, historicalData) => {
      const last7Days = getLastNDaysData(7);
      const completedDays = last7Days.filter(d => d?.completed).length;
      return completedDays >= 7;
    }
  },
  {
    id: 'month_master',
    name: 'Month Master',
    description: 'Completed 30 days of hydration',
    icon: 'fa-calendar-alt',
    condition: (profile, todayData, historicalData) => {
      const completedDays = Object.values(historicalData).filter(d => d.completed).length;
      return completedDays >= 30;
    }
  },
  {
    id: 'water_expert',
    name: 'Water Expert',
    description: 'Drank 3L in a single day',
    icon: 'fa-water',
    condition: (profile, todayData, historicalData) => {
      const allDays = [todayData, ...Object.values(historicalData)];
      return allDays.some(d => d && d.consumed >= 3000);
    }
  },
  {
    id: 'consistency_king',
    name: 'Consistency King',
    description: 'Maintained a 7-day streak',
    icon: 'fa-crown',
    condition: (profile) => profile.bestStreak >= 7
  },
  {
    id: 'legendary_hydrator',
    name: 'Legendary Hydrator',
    description: 'Maintained a 30-day streak',
    icon: 'fa-trophy',
    condition: (profile) => profile.bestStreak >= 30
  },
  {
    id: 'variety_seeker',
    name: 'Variety Seeker',
    description: 'Tried 5 different drink types',
    icon: 'fa-glass-whiskey',
    condition: (profile, todayData, historicalData) => {
      const allDrinks = [...(todayData?.drinks || []), 
                        ...Object.values(historicalData).flatMap(d => d.drinks || [])];
      const uniqueTypes = new Set(allDrinks.map(d => d.type));
      return uniqueTypes.size >= 5;
    }
  },
  {
    id: 'early_bird',
    name: 'Early Bird',
    description: 'Drank before 8 AM for 5 days',
    icon: 'fa-sun',
    condition: (profile, todayData, historicalData) => {
      const earlyDrinks = [...(todayData?.drinks || []), 
                          ...Object.values(historicalData).flatMap(d => d.drinks || [])];
      const earlyDays = new Set();
      earlyDrinks.forEach(drink => {
        const hour = new Date(drink.timestamp).getHours();
        if (hour < 8) {
          const date = new Date(drink.timestamp).toDateString();
          earlyDays.add(date);
        }
      });
      return earlyDays.size >= 5;
    }
  }
];

// Hydration tips
const HYDRATION_TIPS = [
  "Start your day with a glass of water to kickstart metabolism",
  "Drink water 30 minutes before meals for better digestion",
  "Your body is about 60% water - keep it replenished!",
  "Dehydration can reduce cognitive performance by up to 30%",
  "Carry a reusable water bottle to stay hydrated on the go",
  "Eat water-rich foods like watermelon, cucumber, and oranges",
  "Listen to your body - thirst is a sign you're already dehydrated",
  "Alcohol and caffeine can dehydrate you - balance with water",
  "Stay hydrated during exercise to maintain performance",
  "Proper hydration helps regulate body temperature"
];

// Activity level multipliers
const ACTIVITY_LEVELS = {
  sedentary: 1.0,
  light: 1.2,
  moderate: 1.4,
  active: 1.6,
  athlete: 1.8
};

// State management
let appState = {
  profile: null,
  todayData: null,
  historicalData: {},
  settings: {},
  selectedDrink: null,
  selectedAmount: 250,
  currentChartType: 'weekly',
  currentPieType: 'today',
  currentMonth: new Date().getMonth(),
  currentYear: new Date().getFullYear(),
  dataVersion: 5,
  unitSystem: 'metric'
};

// Charts
let trendChart = null;
let distributionChart = null;

function getLastNDaysData(n) {
  const days = [];
  for (let i = 0; i < n; i++) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const dateStr = date.toDateString();
    days.push(appState.historicalData[dateStr]);
  }
  return days;
}

function loadAllData() {
  try {
    appState.profile = JSON.parse(localStorage.getItem('waterify_profile')) || null;
    
    // Load today's data
    const todayData = JSON.parse(localStorage.getItem('waterify_today'));
    const today = new Date().toDateString();
    
    if (todayData && todayData.date === today) {
      appState.todayData = todayData;
    }
    
    appState.historicalData = JSON.parse(localStorage.getItem('waterify_history')) || {};
    appState.settings = JSON.parse(localStorage.getItem('waterify_settings')) || {};
  } catch (e) {
    console.error('Error loading data:', e);
    appState.profile = null;
    appState.todayData = null;
    appState.historicalData = {};
    appState.settings = {};
  }
}

function saveAllData() {
  try {
    localStorage.setItem('waterify_profile', JSON.stringify(appState.profile));
    localStorage.setItem('waterify_today', JSON.stringify(appState.todayData));
    localStorage.setItem('waterify_history', JSON.stringify(appState.historicalData));
    localStorage.setItem('waterify_settings', JSON.stringify(appState.settings));
    localStorage.setItem('waterify_version', '5');
  } catch (e) {
    console.error('Error saving data:', e);
  }
}

function setWeightUnit(system) {
  appState.unitSystem = system;
  appState.profile.unitSystem = system;
  
  // Update UI buttons
  document.querySelectorAll('.unit-conversion-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.unit === system);
  });
  
  // Update labels
  if (system === 'metric') {
    document.getElementById('weightLabel').textContent = 'Weight (kg)';
    document.getElementById('heightLabel').textContent = 'Height (cm)';
    document.getElementById('weightUnit').textContent = 'kg';
    document.getElementById('heightUnit').textContent = 'cm';
    
    // Convert values back to metric if they're in imperial
    if (appState.profile.weight > 200) { // Likely in lbs
      appState.profile.weight = Math.round(appState.profile.weight / 2.20462);
    }
    if (appState.profile.height > 84) { // Likely in inches
      appState.profile.height = Math.round(appState.profile.height * 2.54);
    }
    
    // Update displays
    document.getElementById('weightValue').textContent = appState.profile.weight;
    document.getElementById('heightValue').textContent = appState.profile.height;
    document.getElementById('weightInput').value = appState.profile.weight;
    document.getElementById('heightInput').value = appState.profile.height;
    
    // Update rulers
    initRuler('weightRuler', 30, 200, appState.profile.weight, 'kg', (value) => {
      appState.profile.weight = value;
      document.getElementById('weightValue').textContent = value;
      document.getElementById('weightInput').value = value;
    });
    
    initRuler('heightRuler', 100, 250, appState.profile.height, 'cm', (value) => {
      appState.profile.height = value;
      document.getElementById('heightValue').textContent = value;
      document.getElementById('heightInput').value = value;
    });
    
  } else { // imperial
    document.getElementById('weightLabel').textContent = 'Weight (lbs)';
    document.getElementById('heightLabel').textContent = 'Height (in)';
    document.getElementById('weightUnit').textContent = 'lbs';
    document.getElementById('heightUnit').textContent = 'in';
    
    // Convert values to imperial
    const weightLbs = Math.round(appState.profile.weight * 2.20462);
    const heightIn = Math.round(appState.profile.height / 2.54);
    
    // Update displays
    document.getElementById('weightValue').textContent = weightLbs;
    document.getElementById('heightValue').textContent = heightIn;
    document.getElementById('weightInput').value = weightLbs;
    document.getElementById('heightInput').value = heightIn;
    
    // Update rulers for imperial
    initRuler('weightRuler', 66, 440, weightLbs, 'lbs', (value) => {
      appState.profile.weight = Math.round(value / 2.20462);
      document.getElementById('weightValue').textContent = value;
      document.getElementById('weightInput').value = value;
    });
    
    initRuler('heightRuler', 39, 98, heightIn, 'in', (value) => {
      appState.profile.height = Math.round(value * 2.54);
      document.getElementById('heightValue').textContent = value;
      document.getElementById('heightInput').value = value;
    });
  }
  
  // Update goal based on new units
  calculateRecommendedGoal();
}

function initRuler(containerId, min, max, initial, unit, onChange) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  
  // Create ticks for every unit
  for (let i = min; i <= max; i++) {
    const tick = document.createElement('div');
    tick.className = 'ruler-tick';
    tick.dataset.value = i;
    
    // Show every 5th unit with a label, others just tick marks
    const isMajor = i % 5 === 0;
    const lineHeight = isMajor ? 40 : 20;
    
    tick.innerHTML = `
      <div class="tick-line" style="height: ${lineHeight}px;"></div>
      ${isMajor ? `<div class="tick-label">${i}${unit}</div>` : ''}
    `;
    
    if (i === initial) {
      tick.classList.add('active');
    }
    
    container.appendChild(tick);
  }
  
  // Set up scroll event listener
  let scrollTimeout;
  container.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      const center = container.scrollLeft + container.clientWidth / 2;
      const ticks = Array.from(container.children);
      let closestTick = null;
      let closestDistance = Infinity;
      
      ticks.forEach(tick => {
        const tickCenter = tick.offsetLeft + tick.offsetWidth / 2;
        const distance = Math.abs(tickCenter - center);
        
        if (distance < closestDistance) {
          closestDistance = distance;
          closestTick = tick;
        }
      });
      
      if (closestTick) {
        const value = parseInt(closestTick.dataset.value);
        onChange(value);
        
        ticks.forEach(t => t.classList.remove('active'));
        closestTick.classList.add('active');
        
        if (navigator.vibrate) {
          navigator.vibrate(10);
        }
      }
    }, 150);
  });
  
  // Scroll to initial value
  setTimeout(() => {
    const tickWidth = 40;
    const centerOffset = container.clientWidth / 2;
    const targetTick = Array.from(container.children).find(t => parseInt(t.dataset.value) === initial);
    if (targetTick) {
      const tickIndex = Array.from(container.children).indexOf(targetTick);
      container.scrollLeft = (tickIndex * tickWidth) - centerOffset + (tickWidth / 2);
    }
  }, 100);
}

function selectGender(gender) {
  if (!appState.profile) return;
  appState.profile.gender = gender;
  
  // Update UI - remove active from all, add to clicked
  document.querySelectorAll('.gender-option').forEach(option => {
    option.classList.remove('active');
    if (option.dataset.gender === gender) {
      option.classList.add('active');
    }
  });
  
  saveAllData();
}

function selectActivityLevel(level) {
  if (!appState.profile) return;
  appState.profile.activityLevel = level;
  
  document.querySelectorAll('.activity-level').forEach(item => {
    item.classList.remove('active');
    if (item.dataset.level === level) {
      item.classList.add('active');
    }
  });
}

function calculateRecommendedGoal() {
  if (!appState.profile) return;
  
  // Get weight in kg regardless of unit system
  let weightKg = appState.profile.weight;
  if (appState.unitSystem === 'imperial') {
    weightKg = weightKg / 2.20462;
  }
  
  // Get height in cm regardless of unit system
  let heightCm = appState.profile.height;
  if (appState.unitSystem === 'imperial') {
    heightCm = heightCm * 2.54;
  }
  
  // Calculate base goal
  let baseGoal;
  if (appState.profile.gender === 'male') {
    baseGoal = weightKg * 35;
  } else if (appState.profile.gender === 'female') {
    baseGoal = weightKg * 31;
  } else {
    baseGoal = weightKg * 33;
  }
  
  // Adjust for height
  const heightFactor = heightCm / 170;
  baseGoal *= heightFactor;
  
  // Adjust for age
  if (appState.profile.age < 18) {
    baseGoal *= 1.1;
  } else if (appState.profile.age > 50) {
    baseGoal *= 0.95;
  }
  
  // Apply activity level
  const activityMultiplier = ACTIVITY_LEVELS[appState.profile.activityLevel] || 1.0;
  baseGoal *= activityMultiplier;
  
  // Round to nearest 50ml
  const roundedGoal = Math.round(baseGoal / 50) * 50;
  
  // Ensure within bounds
  const finalGoal = Math.max(1500, Math.min(roundedGoal, 4000));
  
  document.getElementById('dailyGoalInput').value = finalGoal;
  appState.profile.dailyGoal = finalGoal;
  if (appState.todayData) {
    appState.todayData.goal = finalGoal;
  }
  
  showNotification(`Recommended daily goal: ${finalGoal}ml`, "success");
}

function renderCalendar() {
  const container = document.getElementById('calendarContainer');
  const month = appState.currentMonth;
  const year = appState.currentYear;
  
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
  
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  container.innerHTML = '';
  
  // Day headers
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  dayNames.forEach(day => {
    const dayElement = document.createElement('div');
    dayElement.style.cssText = `
      text-align: center;
      padding: 8px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
    `;
    dayElement.textContent = day;
    container.appendChild(dayElement);
  });
  
  // Empty cells
  for (let i = 0; i < firstDay; i++) {
    const empty = document.createElement('div');
    container.appendChild(empty);
  }
  
  // Days of the month
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    const dateStr = date.toDateString();
    const dayData = appState.historicalData[dateStr];
    
    const dayElement = document.createElement('div');
    dayElement.style.cssText = `
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      background: var(--glass);
      border: 1px solid var(--glass-border);
    `;
    
    dayElement.textContent = day;
    dayElement.dataset.date = dateStr;
    
    if (dayData) {
      const goal = appState.profile?.dailyGoal || 2000;
      const progress = Math.min((dayData.consumed / goal) * 100, 100);
      
      // Color coding
      if (progress >= 100) {
        dayElement.style.background = `linear-gradient(135deg, var(--success), rgba(77, 255, 184, 0.3))`;
        dayElement.style.borderColor = 'var(--success)';
      } else if (progress >= 75) {
        dayElement.style.background = `linear-gradient(135deg, #a6ff4d, rgba(166, 255, 77, 0.3))`;
      } else if (progress >= 50) {
        dayElement.style.background = `linear-gradient(135deg, var(--warning), rgba(255, 184, 77, 0.3))`;
      } else if (progress > 0) {
        dayElement.style.background = `linear-gradient(135deg, #ff9966, rgba(255, 153, 102, 0.3))`;
      }
      
      if (dayData.completed) {
        dayElement.style.border = '2px solid var(--accent)';
      }
      
      // Add click handler to show details
      dayElement.onclick = () => showDateDetails(dateStr, dayData);
    }
    
    // Highlight today
    if (date.toDateString() === new Date().toDateString()) {
      dayElement.style.boxShadow = '0 0 0 2px var(--accent)';
      dayElement.style.fontWeight = '700';
    }
    
    // Add tooltip
    if (dayData) {
      dayElement.title = `${dayData.consumed}ml (${Math.round((dayData.consumed / (appState.profile?.dailyGoal || 2000)) * 100)}%)`;
    } else {
      dayElement.title = 'No data';
      dayElement.onclick = () => showDateDetails(dateStr, null);
    }
    
    container.appendChild(dayElement);
  }
}

function updateGreetingMessage() {
  const hour = new Date().getHours();
  let greeting = "Stay Hydrated, Stay Healthy";
  
  if (hour < 12) greeting = "Good morning! Stay hydrated today";
  else if (hour < 18) greeting = "Good afternoon! Keep drinking water";
  else greeting = "Good evening! Finish your hydration goal";
  
  document.getElementById('greetingMessage').textContent = greeting;
}

function quickAddDrink(type, amount) {
  addDrink(type, amount);
}

function setGoalPercentage(percentage) {
  const goal = appState.profile.dailyGoal;
  const targetAmount = Math.round((goal * percentage) / 100);
  
  if (appState.todayData.consumed < targetAmount) {
    const needed = targetAmount - appState.todayData.consumed;
    if (needed > 0) {
      addDrink('water', needed);
    }
  }
  
  document.querySelectorAll('.hydration-level').forEach((level, index) => {
    level.classList.toggle('active', 
      (percentage === 0 && index === 0) ||
      (percentage === 25 && index === 1) ||
      (percentage === 50 && index === 2) ||
      (percentage === 75 && index === 3) ||
      (percentage === 100 && index === 4)
    );
  });
}

function checkAndUpdateStreak() {
  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayStr = yesterday.toDateString();
  
  const yesterdayData = appState.historicalData[yesterdayStr];
  
  if (yesterdayData) {
    if (yesterdayData.completed) {
      appState.profile.currentStreak = (appState.profile.currentStreak || 0) + 1;
      appState.profile.bestStreak = Math.max(appState.profile.bestStreak || 0, appState.profile.currentStreak);
    } else {
      appState.profile.currentStreak = 0;
    }
  }
}

function updateQuickStats() {
  if (!appState.todayData || !appState.historicalData) return;
  
  // Weekly average
  const last7Days = getLastNDays(7);
  const daysWithData = last7Days.filter(d => d && d.consumed > 0);
  const weeklyTotal = daysWithData.reduce((sum, day) => sum + (day?.consumed || 0), 0);
  const weekAvg = daysWithData.length > 0 ? Math.round(weeklyTotal / daysWithData.length) : 0;
  document.getElementById('weekAvg').textContent = `${weekAvg}ml`;
  
  // Monthly total
  const last30Days = getLastNDays(30);
  const monthlyTotal = last30Days.reduce((sum, day) => sum + (day?.consumed || 0), 0);
  document.getElementById('monthTotal').textContent = `${Math.round(monthlyTotal / 1000)}L`;
  
  // Goal days percentage
  const goalDays = last30Days.filter(d => d?.completed).length;
  const goalPercent = last30Days.length > 0 ? Math.round((goalDays / last30Days.length) * 100) : 0;
  document.getElementById('goalDays').textContent = `${goalPercent}%`;
  
  // Best streak
  document.getElementById('bestStreak').textContent = appState.profile?.bestStreak || 0;
}

function getLastNDays(n) {
  const days = [];
  for (let i = 0; i < n; i++) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const dateStr = date.toDateString();
    days.push(appState.historicalData[dateStr]);
  }
  return days;
}

function updateHydrationTip() {
  const tip = HYDRATION_TIPS[Math.floor(Math.random() * HYDRATION_TIPS.length)];
  document.getElementById('hydrationTip').textContent = tip;
}

function updateProfileUI() {
  if (!appState.profile) return;
  
  const profile = appState.profile;
  
  document.getElementById('userName').textContent = profile.name || 'Profile';
  document.getElementById('userNameInput').value = profile.name || '';
  document.getElementById('ageValue').textContent = profile.age;
  document.getElementById('ageManualInput').value = profile.age;
  document.getElementById('dailyGoalInput').value = profile.dailyGoal || 2000;
  
  document.getElementById('remindersEnabled').checked = appState.settings.reminders?.enabled || true;
  document.getElementById('reminderTime').value = appState.settings.reminders?.time || "09:00";
  document.getElementById('reminderFrequency').value = appState.settings.reminders?.frequency || 2;
  
  // Update gender selection
  document.querySelectorAll('.gender-option').forEach(option => {
    option.classList.remove('active');
    if (option.dataset.gender === profile.gender) {
      option.classList.add('active');
    }
  });
  
  // Update activity level selection
  document.querySelectorAll('.activity-level').forEach(item => {
    item.classList.remove('active');
    if (item.dataset.level === profile.activityLevel) {
      item.classList.add('active');
    }
  });
  
  // Set unit system
  setWeightUnit(profile.unitSystem || 'metric');
}

function adjustWeight(change) {
  const input = document.getElementById('weightInput');
  let value = parseInt(input.value) + change;
  
  if (appState.unitSystem === 'metric') {
    value = Math.max(30, Math.min(200, value));
  } else {
    value = Math.max(66, Math.min(440, value));
  }
  
  input.value = value;
  appState.profile.weight = value;
  document.getElementById('weightValue').textContent = value;
  updateRuler('weightRuler', value);
}

function adjustHeight(change) {
  const input = document.getElementById('heightInput');
  let value = parseInt(input.value) + change;
  
  if (appState.unitSystem === 'metric') {
    value = Math.max(100, Math.min(250, value));
  } else {
    value = Math.max(39, Math.min(98, value));
  }
  
  input.value = value;
  appState.profile.height = value;
  document.getElementById('heightValue').textContent = value;
  updateRuler('heightRuler', value);
}

function adjustAge(change) {
  const input = document.getElementById('ageManualInput');
  let value = parseInt(input.value) + change;
  value = Math.max(10, Math.min(100, value));
  input.value = value;
  appState.profile.age = value;
  document.getElementById('ageValue').textContent = value;
}

function setAge(age) {
  const input = document.getElementById('ageManualInput');
  input.value = age;
  appState.profile.age = age;
  document.getElementById('ageValue').textContent = age;
}

function updateWeightFromInput() {
  const input = document.getElementById('weightInput');
  let value = parseInt(input.value);
  
  if (appState.unitSystem === 'metric') {
    value = Math.max(30, Math.min(200, value));
  } else {
    value = Math.max(66, Math.min(440, value));
  }
  
  input.value = value;
  appState.profile.weight = value;
  document.getElementById('weightValue').textContent = value;
  updateRuler('weightRuler', value);
}

function updateHeightFromInput() {
  const input = document.getElementById('heightInput');
  let value = parseInt(input.value);
  
  if (appState.unitSystem === 'metric') {
    value = Math.max(100, Math.min(250, value));
  } else {
    value = Math.max(39, Math.min(98, value));
  }
  
  input.value = value;
  appState.profile.height = value;
  document.getElementById('heightValue').textContent = value;
  updateRuler('heightRuler', value);
}

function updateAgeFromInput() {
  const input = document.getElementById('ageManualInput');
  let value = parseInt(input.value);
  value = Math.max(10, Math.min(100, value));
  input.value = value;
  appState.profile.age = value;
  document.getElementById('ageValue').textContent = value;
}

function updateRuler(containerId, value) {
  const container = document.getElementById(containerId);
  Array.from(container.children).forEach(tick => {
    const tickValue = parseInt(tick.dataset.value);
    tick.classList.toggle('active', tickValue === value);
  });
}

function saveProfile() {
  // Save profile data
  appState.profile.name = document.getElementById('userNameInput').value || 'User';
  appState.profile.weight = parseInt(document.getElementById('weightInput').value);
  appState.profile.height = parseInt(document.getElementById('heightInput').value);
  appState.profile.age = parseInt(document.getElementById('ageManualInput').value);
  appState.profile.dailyGoal = parseInt(document.getElementById('dailyGoalInput').value);
  appState.profile.unitSystem = appState.unitSystem;
  
  // Get gender from active button
  const activeGender = document.querySelector('.gender-option.active');
  if (activeGender) {
    appState.profile.gender = activeGender.dataset.gender;
  }
  
  // Get activity level from active item
  const activeActivity = document.querySelector('.activity-level.active');
  if (activeActivity) {
    appState.profile.activityLevel = activeActivity.dataset.level;
  }
  
  appState.settings.reminders = {
    enabled: document.getElementById('remindersEnabled').checked,
    frequency: parseInt(document.getElementById('reminderFrequency').value),
    time: document.getElementById('reminderTime').value
  };
  
  appState.todayData.goal = appState.profile.dailyGoal;
  
  saveAllData();
  updateDashboard();
  setupReminders();
  
  showNotification("Profile saved successfully!", "success");
  closeProfile();
}

function openStats() {
  showScreen('statsScreen');
  updateStatistics();
  renderCalendar();
  updateCharts();
}

function updateStatistics() {
  const history = appState.historicalData;
  const todayData = appState.todayData;
  
  let allDays = Object.values(history);
  if (todayData && todayData.consumed > 0) {
    allDays = [todayData, ...allDays];
  }
  
  if (allDays.length === 0) {
    document.getElementById('totalConsumed').textContent = '0';
    document.getElementById('avgDaily').textContent = '0';
    document.getElementById('bestDay').textContent = '0';
    document.getElementById('completionRate').textContent = '0%';
    return;
  }
  
  const totalConsumed = allDays.reduce((sum, day) => sum + (day.consumed || 0), 0);
  const avgDaily = Math.round(totalConsumed / allDays.length);
  const bestDay = Math.max(...allDays.map(d => d.consumed || 0));
  const completionRate = Math.round((allDays.filter(d => d.completed).length / allDays.length) * 100);
  
  document.getElementById('totalConsumed').textContent = Math.round(totalConsumed / 1000).toLocaleString() + 'L';
  document.getElementById('avgDaily').textContent = avgDaily.toLocaleString() + 'ml';
  document.getElementById('bestDay').textContent = bestDay.toLocaleString() + 'ml';
  document.getElementById('completionRate').textContent = `${completionRate}%`;
}

function initializeCharts() {
  const trendCtx = document.getElementById('trendChart').getContext('2d');
  const distCtx = document.getElementById('distributionChart').getContext('2d');
  
  Chart.defaults.color = 'rgba(255, 255, 255, 0.8)';
  Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.2)';
  
  trendChart = new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Water Intake (ml)',
        data: [],
        borderColor: 'var(--accent)',
        backgroundColor: 'rgba(79, 209, 255, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: 'var(--accent)',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(18, 26, 47, 0.95)',
          titleColor: 'var(--accent)',
          bodyColor: 'var(--text)',
          borderColor: 'var(--accent)',
          borderWidth: 1,
          padding: 12,
          cornerRadius: 8
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(255, 255, 255, 0.15)' },
          ticks: {
            color: 'rgba(255, 255, 255, 0.8)',
            callback: function(value) { return value + 'ml'; }
          }
        },
        x: {
          grid: { color: 'rgba(255, 255, 255, 0.1)' },
          ticks: { color: 'rgba(255, 255, 255, 0.8)' }
        }
      }
    }
  });
  
  distributionChart = new Chart(distCtx, {
    type: 'doughnut',
    data: {
      labels: [],
      datasets: [{
        data: [],
        backgroundColor: [],
        borderWidth: 2,
        borderColor: 'var(--card)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: 'rgba(255, 255, 255, 0.8)',
            padding: 20,
            usePointStyle: true,
            pointStyle: 'circle',
            font: { size: 11 }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(18, 26, 47, 0.95)',
          titleColor: 'var(--accent)',
          bodyColor: 'var(--text)',
          borderColor: 'var(--accent)',
          borderWidth: 1,
          padding: 12,
          cornerRadius: 8
        }
      },
      cutout: '60%'
    }
  });
  
  updateCharts();
}

function updateCharts() {
  if (!trendChart || !distributionChart) return;
  
  let labels = [];
  let data = [];
  
  if (appState.currentChartType === 'weekly') {
    for (let i = 6; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      const dateStr = date.toDateString();
      const dayData = appState.historicalData[dateStr];
      
      labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
      data.push(dayData ? dayData.consumed : 0);
    }
  } else if (appState.currentChartType === 'monthly') {
    const daysInMonth = new Date(appState.currentYear, appState.currentMonth + 1, 0).getDate();
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(appState.currentYear, appState.currentMonth, day);
      const dateStr = date.toDateString();
      const dayData = appState.historicalData[dateStr];
      
      labels.push(day);
      data.push(dayData ? dayData.consumed : 0);
    }
  } else if (appState.currentChartType === 'yearly') {
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    labels = months;
    data = Array(12).fill(0);
    
    Object.entries(appState.historicalData).forEach(([dateStr, dayData]) => {
      const date = new Date(dateStr);
      const month = date.getMonth();
      data[month] = Math.max(data[month], dayData.consumed);
    });
  }
  
  trendChart.data.labels = labels;
  trendChart.data.datasets[0].data = data;
  trendChart.update();
  
  updateDistributionChart();
}

function updateDistributionChart() {
  if (!distributionChart) return;
  
  const drinkTypes = {};
  let drinks = [];
  
  if (appState.currentPieType === 'today') {
    drinks = appState.todayData?.drinks || [];
  } else if (appState.currentPieType === 'week') {
    const last7Days = getLastNDays(7);
    drinks = last7Days.flatMap(day => day?.drinks || []);
  } else if (appState.currentPieType === 'month') {
    const last30Days = getLastNDays(30);
    drinks = last30Days.flatMap(day => day?.drinks || []);
  }
  
  drinks.forEach(drink => {
    drinkTypes[drink.type] = (drinkTypes[drink.type] || 0) + drink.amount;
  });
  
  const labels = [];
  const data = [];
  const colors = [];
  
  Object.entries(drinkTypes).forEach(([type, amount]) => {
    labels.push(BEVERAGES[type]?.name || type);
    data.push(amount);
    colors.push(BEVERAGES[type]?.color || '#4fd1ff');
  });
  
  distributionChart.data.labels = labels;
  distributionChart.data.datasets[0].data = data;
  distributionChart.data.datasets[0].backgroundColor = colors;
  distributionChart.update();
}

function changeChartType(type) {
  appState.currentChartType = type;
  document.querySelectorAll('.chart-actions .chart-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  updateCharts();
}

function changePieType(type) {
  appState.currentPieType = type;
  document.querySelectorAll('.chart-actions .chart-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  updateDistributionChart();
}

function prevMonth() {
  appState.currentMonth--;
  if (appState.currentMonth < 0) {
    appState.currentMonth = 11;
    appState.currentYear--;
  }
  renderCalendar();
}

function nextMonth() {
  appState.currentMonth++;
  if (appState.currentMonth > 11) {
    appState.currentMonth = 0;
    appState.currentYear++;
  }
  renderCalendar();
}

function updateDrinkGrid() {
  const container = document.getElementById('drinkGrid');
  container.innerHTML = '';
  
  Object.entries(BEVERAGES).forEach(([key, drink]) => {
    const item = document.createElement('div');
    item.className = 'drink-item';
    item.onclick = () => selectDrink(key);
    
    item.innerHTML = `
      <i class="fas ${drink.icon} drink-icon" style="color: ${drink.color};"></i>
      <div class="drink-name">${drink.name}</div>
      <div class="drink-percentage">${drink.waterContent}% water</div>
    `;
    
    container.appendChild(item);
  });
}

function selectDrink(type) {
  appState.selectedDrink = type;
  const drink = BEVERAGES[type];
  
  document.getElementById('amountTitle').innerHTML = `
    <i class="fas ${drink.icon}" style="color: ${drink.color};"></i> ${drink.name}
  `;
  
  document.getElementById('waterContentInfo').innerHTML = `
    <div style="font-weight: 600; margin-bottom: 5px;">${drink.description}</div>
    <div style="font-size: 14px; color: var(--accent);">Contains ${drink.waterContent}% water</div>
  `;
  
  const amounts = [100, 200, 250, 300, 400, 500, 750, 1000];
  const container = document.getElementById('amountGrid');
  container.innerHTML = '';
  
  amounts.forEach(amount => {
    const waterAmount = Math.round(amount * drink.waterContent / 100);
    const btn = document.createElement('button');
    btn.className = 'amount-btn';
    if (amount === appState.selectedAmount) btn.classList.add('active');
    
    btn.innerHTML = `
      <div class="amount-value">${amount === 1000 ? '1L' : `${amount}ml`}</div>
      <div class="amount-water">${waterAmount}ml water</div>
    `;
    
    btn.onclick = () => {
      document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      appState.selectedAmount = amount;
      document.getElementById('customAmount').value = '';
    };
    
    container.appendChild(btn);
  });
  
  closeModal('drinkModal');
  openModal('amountModal');
}

function confirmDrink() {
  let amount = appState.selectedAmount;
  const customAmount = parseInt(document.getElementById('customAmount').value);
  
  if (customAmount && customAmount > 0) {
    amount = customAmount;
  }
  
  if (!appState.selectedDrink || amount <= 0) {
    showNotification("Please select a valid amount", "error");
    return;
  }
  
  addDrink(appState.selectedDrink, amount);
  closeModal('amountModal');
  appState.selectedDrink = null;
  appState.selectedAmount = 250;
}

function setupReminders() {
  if (!appState.settings.reminders?.enabled) return;
  
  if ("Notification" in window && Notification.permission === "default") {
    Notification.requestPermission();
  }
  
  scheduleSystemNotifications();
}

function scheduleSystemNotifications() {
  if (!appState.settings.reminders?.enabled) return;
  
  if (window.reminderInterval) {
    clearInterval(window.reminderInterval);
  }
  
  const frequencyHours = appState.settings.reminders.frequency;
  const [hours, minutes] = appState.settings.reminders.time.split(':').map(Number);
  const reminderMinutes = hours * 60 + minutes;
  
  const now = new Date();
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  const minutesUntilReminder = (reminderMinutes - currentMinutes + 24 * 60) % (24 * 60);
  
  setTimeout(() => {
    sendSystemReminder();
    window.reminderInterval = setInterval(sendSystemReminder, frequencyHours * 60 * 60 * 1000);
  }, minutesUntilReminder * 60 * 1000);
}

function sendSystemReminder() {
  if (!appState.settings.reminders?.enabled) return;
  
  const progress = appState.todayData ? (appState.todayData.consumed / appState.todayData.goal) * 100 : 0;
  let message = "ðŸ’§ Time to hydrate!";
  
  if (progress < 25) {
    message = "ðŸ’§ Start your hydration journey! Drink some water.";
  } else if (progress < 50) {
    message = "ðŸ’§ Keep going! You're making good progress.";
  } else if (progress < 75) {
    message = "ðŸ’§ Halfway there! Stay hydrated.";
  } else if (progress < 100) {
    message = "ðŸ’§ Almost at your goal! One more drink.";
  } else {
    message = "ðŸŽ‰ Goal achieved! Maintain your hydration.";
  }
  
  showNotification(message, "reminder");
  
  if ("Notification" in window && Notification.permission === "granted") {
    new Notification("Waterify Pro Reminder", {
      body: message,
      icon: "https://cdn.jsdelivr.net/npm/emoji-datasource-apple/img/apple/64/1f4a7.png",
      tag: "hydration-reminder"
    });
  }
  
  if (navigator.vibrate) {
    navigator.vibrate([100, 50, 100]);
  }
}

function testReminder() {
  sendSystemReminder();
  showNotification("Test reminder sent!", "success");
}

function exportData() {
  const data = {
    profile: appState.profile,
    historicalData: appState.historicalData,
    settings: appState.settings,
    exportDate: new Date().toISOString(),
    version: 5
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `waterify-data-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showNotification("Data exported successfully!", "success");
}

function importData() {
  document.getElementById('importFile').click();
}

document.getElementById('importFile').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      
      if (confirm("This will replace all your current data. Continue?")) {
        appState.profile = data.profile || appState.profile;
        appState.historicalData = data.historicalData || appState.historicalData;
        appState.settings = data.settings || appState.settings;
        
        saveAllData();
        updateDashboard();
        updateProfileUI();
        
        showNotification("Data imported successfully!", "success");
      }
    } catch (error) {
      showNotification("Error importing data. Invalid file format.", "error");
    }
  };
  reader.readAsText(file);
});

function resetData() {
  if (confirm("Are you sure you want to reset all data? This cannot be undone.")) {
    localStorage.clear();
    location.reload();
  }
}

function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(screen => {
    screen.style.display = 'none';
  });
  
  document.getElementById(screenId).style.display = 'block';
  
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  if (screenId === 'dashboard') {
    document.querySelector('.nav-item:nth-child(1)').classList.add('active');
  } else if (screenId === 'statsScreen') {
    document.querySelector('.nav-item:nth-child(3)').classList.add('active');
  } else if (screenId === 'profileScreen') {
    document.querySelector('.nav-item:nth-child(4)').classList.add('active');
  }
}

function openProfile() {
  showScreen('profileScreen');
}

function closeProfile() {
  showScreen('dashboard');
}

function openDrinkModal() {
  openModal('drinkModal');
}

function openModal(modalId) {
  document.getElementById(modalId).style.display = 'flex';
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

function closeStats() {
  showScreen('dashboard');
}

// ===== INITIALIZE APP =====

// Load Chart.js dynamically
const script = document.createElement('script');
script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
script.onload = initializeApp;
document.head.appendChild(script);

// Initialize the rest
window.addEventListener('load', () => {
  if (typeof Chart !== 'undefined') {
    initializeApp();
  }
  updateDrinkGrid();
});

// Service Worker Registration for PWA
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
      .then(registration => {
        console.log('Service Worker registered:', registration);
      })
      .catch(error => {
        console.log('Service Worker registration failed:', error);
      });
  });
}
</script>
</body>
</html>
