<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Waterify Pro</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#060b18">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
  --bg: #060b18;
  --card: #121a2f;
  --accent: #4fd1ff;
  --accent2: #6b7cff;
  --text: #fff;
  --muted: #9aa4bf;
  --success: #4dffb8;
  --warning: #ffb84d;
  --danger: #ff4d6d;
  --secondary: #8b5cf6;
  --grid-bg: rgba(79, 209, 255, 0.05);
  --glass: rgba(255, 255, 255, 0.05);
  --glass-border: rgba(255, 255, 255, 0.1);
}

* {
  box-sizing: border-box;
  font-family: 'Poppins', sans-serif;
  -webkit-tap-highlight-color: transparent;
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  overflow-x: hidden;
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 20% 80%, rgba(79, 209, 255, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(107, 124, 255, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
  pointer-events: none;
  z-index: -1;
}

.app {
  max-width: 480px;
  margin: auto;
  padding: 16px;
  padding-bottom: 100px;
  min-height: 100vh;
  position: relative;
}

/* Card */
.card {
  background: linear-gradient(145deg, rgba(18, 26, 47, 0.95), rgba(12, 18, 34, 0.95));
  backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  border-radius: 24px;
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 
    0 8px 32px rgba(0, 0, 0, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
  position: relative;
  overflow: hidden;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 
    0 12px 40px rgba(0, 0, 0, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.15);
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--accent), transparent);
}

/* Bottle */
.bottle-container {
  position: relative;
  width: 160px;
  height: 320px;
  margin: 24px auto;
  perspective: 1000px;
}

.bottle {
  width: 100%;
  height: 100%;
  border-radius: 40px;
  border: 2px solid rgba(255, 255, 255, 0.15);
  position: relative;
  overflow: hidden;
  background: rgba(0, 0, 0, 0.2);
  box-shadow: 
    inset 0 0 20px rgba(0, 0, 0, 0.5),
    0 10px 30px rgba(79, 209, 255, 0.2);
  transform-style: preserve-3d;
  animation: floatBottle 4s ease-in-out infinite;
}

@keyframes floatBottle {
  0%, 100% { transform: translateY(0) rotateX(5deg); }
  50% { transform: translateY(-10px) rotateX(5deg); }
}

.water {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 0%;
  background: linear-gradient(180deg, 
    rgba(123, 231, 255, 0.9) 0%,
    rgba(63, 169, 245, 0.9) 100%);
  transition: height 1s cubic-bezier(0.34, 1.56, 0.64, 1);
  border-radius: 0 0 38px 38px;
  box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.3);
}

/* Buttons */
.btn {
  width: 100%;
  padding: 16px;
  border: none;
  border-radius: 16px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  font-weight: 600;
  color: #000;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  font-size: 16px;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(79, 209, 255, 0.4);
}

.btn-secondary {
  background: var(--glass);
  color: var(--text);
  border: 1px solid var(--glass-border);
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.1);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.btn-small {
  padding: 8px 16px;
  width: auto;
  font-size: 14px;
}

/* Navigation */
.nav {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(11, 18, 40, 0.95);
  backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 50px;
  display: flex;
  justify-content: space-around;
  padding: 12px 24px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
  z-index: 100;
}

.nav-item {
  position: relative;
  padding: 10px;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  color: var(--muted);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  min-width: 60px;
}

.nav-item i {
  font-size: 20px;
  transition: all 0.3s ease;
}

.nav-item span {
  font-size: 11px;
  font-weight: 500;
  opacity: 0.8;
}

.nav-item.active {
  color: var(--accent);
  background: rgba(79, 209, 255, 0.1);
}

.nav-item.active::after {
  content: '';
  position: absolute;
  bottom: -12px;
  left: 50%;
  transform: translateX(-50%);
  width: 4px;
  height: 4px;
  background: var(--accent);
  border-radius: 50%;
  box-shadow: 0 0 10px var(--accent);
}

.nav-item:hover:not(.active) {
  color: var(--text);
  background: rgba(255, 255, 255, 0.05);
}

/* Modals */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(10px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  width: 100%;
  max-width: 420px;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes slideUp {
  from { transform: translateY(50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid var(--glass-border);
}

.modal-header h3 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
}

.close-btn {
  background: none;
  border: none;
  color: var(--muted);
  font-size: 20px;
  cursor: pointer;
  padding: 5px;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.close-btn:hover {
  color: var(--text);
  background: rgba(255, 255, 255, 0.1);
}

/* Enhanced Rulers */
.ruler-section {
  margin: 20px 0;
}

.ruler-value-display {
  text-align: center;
  font-size: 42px;
  font-weight: 700;
  margin: 15px 0;
  color: var(--accent);
  text-shadow: 0 0 20px rgba(79, 209, 255, 0.5);
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.ruler-container {
  position: relative;
  height: 140px;
  margin: 30px -20px 40px -20px;
  overflow: hidden;
  padding-top: 20px;
}

.ruler-track {
  position: absolute;
  top: 60%;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, 
    transparent 10%, 
    var(--glass-border) 10%, 
    var(--glass-border) 90%, 
    transparent 90%);
  transform: translateY(-50%);
}

.ruler-scroll {
  display: flex;
  height: 100%;
  overflow-x: scroll;
  scrollbar-width: none;
  scroll-behavior: smooth;
  padding: 0 50%;
  -webkit-overflow-scrolling: touch;
}

.ruler-scroll::-webkit-scrollbar {
  display: none;
}

.ruler-tick {
  width: 20px;
  flex-shrink: 0;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  padding-bottom: 30px;
  cursor: pointer;
}

.tick-line {
  width: 2px;
  background: var(--glass-border);
  transition: all 0.3s ease;
}

.tick-label {
  position: absolute;
  bottom: 0;
  font-size: 11px;
  color: var(--muted);
  font-weight: 500;
  opacity: 0.5;
  transition: all 0.3s ease;
  text-align: center;
  width: 100%;
}

.ruler-tick.active .tick-line {
  height: 40px !important;
  background: var(--accent);
  box-shadow: 0 0 10px var(--accent);
}

.ruler-tick.active .tick-label {
  color: var(--accent);
  opacity: 1;
  font-weight: 600;
  font-size: 12px;
}

.center-indicator {
  position: absolute;
  top: 60%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 4px;
  height: 60px;
  background: var(--accent);
  box-shadow: 0 0 20px var(--accent);
  border-radius: 2px;
  z-index: 2;
}

/* Manual Input Controls */
.input-group {
  margin-bottom: 20px;
}

.input-label {
  display: block;
  margin-bottom: 8px;
  color: var(--muted);
  font-size: 14px;
  font-weight: 500;
}

.input-with-controls {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 10px;
}

.manual-input {
  flex: 1;
  padding: 14px;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  color: var(--text);
  font-size: 16px;
  font-weight: 500;
  text-align: center;
  outline: none;
  transition: all 0.3s ease;
}

.manual-input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(79, 209, 255, 0.2);
}

.unit-btn {
  padding: 10px 16px;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  color: var(--text);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  min-width: 60px;
}

.unit-btn:hover {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
}

/* Age Selector */
.age-selector {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 30px 0;
}

.age-display {
  font-size: 48px;
  font-weight: 800;
  color: var(--accent);
  margin: 20px 0;
  text-shadow: 0 0 30px rgba(79, 209, 255, 0.5);
}

.age-controls {
  display: flex;
  gap: 20px;
  align-items: center;
  margin-bottom: 30px;
}

.age-btn {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  color: var(--text);
  font-size: 24px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.age-btn:hover {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
  transform: scale(1.1);
}

/* Enhanced Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
  margin: 20px 0;
}

.stat-card {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  transition: all 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-2px);
  border-color: var(--accent);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}

.stat-value {
  font-size: 32px;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 5px;
}

.stat-label {
  font-size: 12px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Progress Indicators */
.progress-container {
  margin: 20px 0;
}

.progress-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.progress-bar {
  height: 8px;
  background: var(--glass);
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  border-radius: 4px;
  transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* Drink Selection */
.drink-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin: 20px 0;
}

.drink-item {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.drink-item:hover {
  transform: translateY(-4px);
  border-color: var(--accent);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}

.drink-icon {
  font-size: 32px;
  margin-bottom: 5px;
}

.drink-name {
  font-weight: 600;
  font-size: 14px;
}

.drink-percentage {
  font-size: 12px;
  color: var(--muted);
}

/* Amount Selection */
.amount-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin: 20px 0;
}

.amount-btn {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 16px 8px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.amount-btn:hover {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
}

.amount-btn.active {
  background: var(--accent);
  color: #000;
  border-color: var(--accent);
  box-shadow: 0 0 20px rgba(79, 209, 255, 0.3);
}

.amount-value {
  font-weight: 600;
  font-size: 16px;
}

.amount-water {
  font-size: 11px;
  color: var(--muted);
}

.custom-amount {
  grid-column: span 4;
  padding: 16px;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  color: var(--text);
  font-size: 16px;
  text-align: center;
  outline: none;
  transition: all 0.3s ease;
}

.custom-amount:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(79, 209, 255, 0.2);
}

/* Advanced Stats Section */
.advanced-stats {
  margin-top: 30px;
}

.chart-container {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.chart-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--accent);
}

.chart-actions {
  display: flex;
  gap: 10px;
}

.chart-btn {
  padding: 6px 12px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--glass-border);
  border-radius: 8px;
  color: var(--text);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.chart-btn:hover {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
}

.chart-btn.active {
  background: var(--accent);
  color: #000;
  border-color: var(--accent);
}

/* Notification */
.notification {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: #000;
  padding: 15px 25px;
  border-radius: 15px;
  font-weight: 600;
  box-shadow: 0 10px 30px rgba(79, 209, 255, 0.4);
  z-index: 1000;
  transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
  text-align: center;
  display: none;
}

.notification.show {
  transform: translateX(-50%) translateY(0);
}

/* Mobile Optimizations */
@media (max-width: 480px) {
  .app {
    padding: 12px;
    padding-bottom: 100px;
  }
  
  .card {
    padding: 20px;
    border-radius: 20px;
  }
  
  .drink-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .amount-grid {
    grid-template-columns: repeat(3, 1fr);
  }
  
  .amount-btn {
    padding: 14px 6px;
  }
  
  .nav {
    padding: 10px 20px;
    border-radius: 40px;
  }
  
  .nav-item {
    min-width: 50px;
    padding: 8px;
  }
  
  .nav-item i {
    font-size: 18px;
  }
  
  .nav-item span {
    font-size: 10px;
  }
}

/* Scrollbar Styling */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--accent2);
}

/* NEW FEATURES */
/* Hydration Levels */
.hydration-levels {
  display: flex;
  justify-content: space-between;
  margin: 20px 0;
}

.hydration-level {
  text-align: center;
  opacity: 0.5;
  transition: all 0.3s ease;
  cursor: pointer;
}

.hydration-level.active {
  opacity: 1;
  transform: scale(1.1);
}

.level-circle {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin: 0 auto 8px;
  transition: all 0.3s ease;
}

.level-0 { background: var(--danger); }
.level-1 { background: #ff9966; }
.level-2 { background: var(--warning); }
.level-3 { background: #a6ff4d; }
.level-4 { background: var(--success); }

/* Time-based Progress */
.time-progress {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  margin: 20px 0;
}

.time-slot {
  text-align: center;
  padding: 12px;
  background: var(--glass);
  border-radius: 12px;
  border: 1px solid var(--glass-border);
  transition: all 0.3s ease;
}

.time-slot.active {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
}

.time-label {
  font-size: 11px;
  color: var(--muted);
  margin-bottom: 5px;
}

.time-value {
  font-weight: 600;
  font-size: 14px;
  color: var(--accent);
}

/* Achievement Badges */
.achievement-badge {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 40px;
  height: 40px;
  background: var(--accent);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #000;
  font-size: 20px;
  box-shadow: 0 0 20px rgba(79, 209, 255, 0.5);
  animation: pulse 2s infinite;
  cursor: pointer;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* Water Drop Animation */
.water-drop {
  position: fixed;
  width: 20px;
  height: 30px;
  background: rgba(79, 209, 255, 0.3);
  border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
  animation: drop 1.5s linear infinite;
  pointer-events: none;
  z-index: 1;
}

@keyframes drop {
  0% {
    transform: translateY(-100vh) rotate(0deg);
    opacity: 0;
  }
  10% {
    opacity: 1;
  }
  90% {
    opacity: 1;
  }
  100% {
    transform: translateY(100vh) rotate(360deg);
    opacity: 0;
  }
}

/* Quick Add Buttons */
.quick-add-buttons {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin: 20px 0;
}

.quick-add-btn {
  padding: 12px;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.quick-add-btn:hover {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
}

.quick-add-btn i {
  font-size: 20px;
  color: var(--accent);
}

.quick-add-btn span {
  font-size: 12px;
  color: var(--muted);
}

/* Gender Selector */
.gender-selector {
  display: flex;
  gap: 10px;
  margin: 15px 0;
}

.gender-option {
  flex: 1;
  padding: 12px;
  text-align: center;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.gender-option.active {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
  color: var(--accent);
}

/* Activity Level Selector */
.activity-levels {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin: 15px 0;
}

.activity-level {
  padding: 12px;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.activity-level.active {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
}

.activity-info {
  font-size: 12px;
  color: var(--muted);
}

/* Unit System Toggle */
.unit-system-toggle {
  display: flex;
  gap: 10px;
  margin: 15px 0;
}

.unit-system-btn {
  flex: 1;
  padding: 12px;
  text-align: center;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 14px;
  font-weight: 500;
}

.unit-system-btn.active {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
  color: var(--accent);
}

/* Chart Fixes */
.chart-grid-white {
  background: rgba(255, 255, 255, 0.1) !important;
  border-color: rgba(255, 255, 255, 0.2) !important;
}

.chart-text-white {
  color: rgba(255, 255, 255, 0.8) !important;
}
</style>
</head>

<body>
<!-- Water Drop Animation Container -->
<div id="waterDropsContainer"></div>

<!-- Achievement Badge -->
<div class="achievement-badge" onclick="showAchievements()" title="View Achievements">
  <i class="fas fa-trophy"></i>
</div>

<div class="app">
  <!-- Main Dashboard -->
  <div id="dashboard" class="screen">
    <div class="card" style="position: relative;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
          <h1 style="margin: 0; font-size: 28px; font-weight: 700; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Waterify Pro</h1>
          <p style="margin: 5px 0 0 0; color: var(--muted); font-size: 14px;" id="greetingMessage">Stay Hydrated, Stay Healthy</p>
        </div>
        <div class="btn-small" onclick="openProfile()" style="background: var(--glass); border: 1px solid var(--glass-border); color: var(--text);">
          <i class="fas fa-user"></i>
          <span id="userName">Profile</span>
        </div>
      </div>

      <!-- Time-based Progress -->
      <div class="time-progress" id="timeProgress">
        <!-- Will be populated by JavaScript -->
      </div>

      <div style="text-align: center; margin-bottom: 30px;">
        <div class="progress-container">
          <div class="progress-header">
            <span style="font-weight: 600; color: var(--accent);">Daily Progress</span>
            <span style="font-weight: 600;" id="progressText">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>
      </div>

      <!-- Hydration Levels -->
      <div class="hydration-levels">
        <div class="hydration-level" onclick="setGoalPercentage(0)">
          <div class="level-circle level-0"></div>
          <div style="font-size: 11px;">Low</div>
        </div>
        <div class="hydration-level" onclick="setGoalPercentage(25)">
          <div class="level-circle level-1"></div>
          <div style="font-size: 11px;">25%</div>
        </div>
        <div class="hydration-level" onclick="setGoalPercentage(50)">
          <div class="level-circle level-2"></div>
          <div style="font-size: 11px;">50%</div>
        </div>
        <div class="hydration-level" onclick="setGoalPercentage(75)">
          <div class="level-circle level-3"></div>
          <div style="font-size: 11px;">75%</div>
        </div>
        <div class="hydration-level active" onclick="setGoalPercentage(100)">
          <div class="level-circle level-4"></div>
          <div style="font-size: 11px;">Goal</div>
        </div>
      </div>

      <div class="bottle-container">
        <div class="bottle">
          <div class="water" id="waterLevel"></div>
        </div>
      </div>

      <div style="text-align: center; margin: 30px 0;">
        <div id="consumedDisplay" style="font-size: 48px; font-weight: 800; color: var(--accent); margin-bottom: 10px; text-shadow: 0 0 20px rgba(79, 209, 255, 0.5);">0 ml</div>
        <div id="goalDisplay" style="color: var(--muted); font-size: 16px;">of 0 ml goal</div>
        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: var(--accent);" id="drinksCount">0</div>
            <div style="font-size: 12px; color: var(--muted);">Drinks</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: var(--accent);" id="streakCount">0</div>
            <div style="font-size: 12px; color: var(--muted);">Day Streak</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: var(--accent);" id="todayAvg">0ml</div>
            <div style="font-size: 12px; color: var(--muted);">Today's Avg</div>
          </div>
        </div>
      </div>

      <!-- Quick Add Buttons -->
      <div class="quick-add-buttons">
        <div class="quick-add-btn" onclick="quickAddDrink('water', 250)">
          <i class="fas fa-tint"></i>
          <span>250ml</span>
        </div>
        <div class="quick-add-btn" onclick="quickAddDrink('water', 500)">
          <i class="fas fa-wine-bottle"></i>
          <span>500ml</span>
        </div>
        <div class="quick-add-btn" onclick="quickAddDrink('water', 750)">
          <i class="fas fa-glass-water"></i>
          <span>750ml</span>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
        <button class="btn" onclick="openDrinkModal()">
          <i class="fas fa-plus"></i> Add Drink
        </button>
        <button class="btn-secondary" onclick="openStats()">
          <i class="fas fa-chart-line"></i> Stats
        </button>
      </div>

      <div style="margin-top: 30px;">
        <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-history" style="color: var(--accent); margin-right: 10px;"></i>Recent Activity</h3>
        <div id="recentActivity" style="max-height: 200px; overflow-y: auto; padding-right: 10px;"></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-chart-bar" style="color: var(--accent); margin-right: 10px;"></i>Quick Stats</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="todayBest">0</div>
          <div class="stat-label">Today's Best</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="weekAvg">0</div>
          <div class="stat-label">Weekly Avg</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="monthTotal">0</div>
          <div class="stat-label">Monthly Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="goalDays">0%</div>
          <div class="stat-label">Goal Days</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-lightbulb" style="color: var(--accent); margin-right: 10px;"></i>Hydration Tip</h3>
      <div id="hydrationTip" style="color: var(--muted); font-size: 14px; line-height: 1.6;">Loading tip...</div>
    </div>
  </div>

  <!-- Statistics Screen -->
  <div id="statsScreen" class="screen" style="display: none;">
    <div class="card">
      <div class="modal-header">
        <h3><i class="fas fa-chart-line"></i> Advanced Statistics</h3>
        <button class="close-btn" onclick="closeStats()"><i class="fas fa-times"></i></button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalConsumed">0</div>
          <div class="stat-label">Lifetime Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="avgDaily">0</div>
          <div class="stat-label">Daily Average</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="bestDay">0</div>
          <div class="stat-label">Best Day</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="completionRate">0%</div>
          <div class="stat-label">Success Rate</div>
        </div>
      </div>

      <div class="advanced-stats">
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">Weekly Trend</div>
            <div class="chart-actions">
              <button class="chart-btn active" onclick="changeChartType('weekly')">Week</button>
              <button class="chart-btn" onclick="changeChartType('monthly')">Month</button>
              <button class="chart-btn" onclick="changeChartType('yearly')">Year</button>
            </div>
          </div>
          <div id="chartContainer" style="width: 100%; height: 250px;">
            <canvas id="trendChart" style="width: 100%; height: 100%;"></canvas>
          </div>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">Drink Distribution</div>
            <div class="chart-actions">
              <button class="chart-btn active" onclick="changePieType('today')">Today</button>
              <button class="chart-btn" onclick="changePieType('week')">Week</button>
              <button class="chart-btn" onclick="changePieType('month')">Month</button>
            </div>
          </div>
          <div id="pieContainer" style="width: 100%; height: 250px;">
            <canvas id="distributionChart" style="width: 100%; height: 100%;"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-calendar-alt" style="color: var(--accent); margin-right: 10px;"></i>Monthly Overview</h3>
      <div id="calendarContainer" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">
        <!-- Calendar will be generated here -->
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 20px;">
        <button class="btn-small" onclick="prevMonth()"><i class="fas fa-chevron-left"></i> Prev</button>
        <span id="currentMonth" style="font-weight: 600; color: var(--accent);">January 2024</span>
        <button class="btn-small" onclick="nextMonth()">Next <i class="fas fa-chevron-right"></i></button>
      </div>
    </div>
  </div>

  <!-- Profile Screen -->
  <div id="profileScreen" class="screen" style="display: none;">
    <div class="card">
      <div class="modal-header">
        <h3><i class="fas fa-user-cog"></i> Profile Settings</h3>
        <button class="close-btn" onclick="closeProfile()"><i class="fas fa-times"></i></button>
      </div>

      <div class="input-group">
        <label class="input-label">Your Name</label>
        <input type="text" class="manual-input" id="userNameInput" placeholder="Enter your name">
      </div>

      <!-- Gender Selection -->
      <div class="input-group">
        <label class="input-label">Gender</label>
        <div class="gender-selector">
          <div class="gender-option active" onclick="selectGender('male')">
            <i class="fas fa-mars"></i> Male
          </div>
          <div class="gender-option" onclick="selectGender('female')">
            <i class="fas fa-venus"></i> Female
          </div>
          <div class="gender-option" onclick="selectGender('other')">
            <i class="fas fa-genderless"></i> Other
          </div>
        </div>
      </div>

      <!-- Unit System Toggle -->
      <div class="input-group">
        <label class="input-label">Unit System</label>
        <div class="unit-system-toggle">
          <div class="unit-system-btn active" onclick="setUnitSystem('metric')">
            Metric (kg/cm)
          </div>
          <div class="unit-system-btn" onclick="setUnitSystem('imperial')">
            Imperial (lbs/ft)
          </div>
        </div>
      </div>

      <!-- Weight Section -->
      <div class="ruler-section">
        <label class="input-label" id="weightLabel">Weight (kg)</label>
        <div class="ruler-value-display" id="weightValue">70</div>
        <div class="input-with-controls">
          <input type="number" class="manual-input" id="weightInput" min="30" max="200" step="1" value="70" onchange="updateWeightFromInput()">
          <button class="unit-btn" onclick="adjustWeight(-1)">-1</button>
          <button class="unit-btn" onclick="adjustWeight(1)">+1</button>
        </div>
        <div class="ruler-container">
          <div class="ruler-track"></div>
          <div class="center-indicator"></div>
          <div class="ruler-scroll" id="weightRuler"></div>
        </div>
      </div>

      <!-- Height Section -->
      <div class="ruler-section">
        <label class="input-label" id="heightLabel">Height (cm)</label>
        <div class="ruler-value-display" id="heightValue">170</div>
        <div class="input-with-controls">
          <input type="number" class="manual-input" id="heightInput" min="100" max="250" step="1" value="170" onchange="updateHeightFromInput()">
          <button class="unit-btn" onclick="adjustHeight(-1)">-1</button>
          <button class="unit-btn" onclick="adjustHeight(1)">+1</button>
        </div>
        <div class="ruler-container">
          <div class="ruler-track"></div>
          <div class="center-indicator"></div>
          <div class="ruler-scroll" id="heightRuler"></div>
        </div>
      </div>

      <div class="age-selector">
        <label class="input-label">Age</label>
        <div class="age-display" id="ageValue">25</div>
        <div class="age-controls">
          <button class="age-btn" onclick="adjustAge(-1)"><i class="fas fa-minus"></i></button>
          <input type="number" class="manual-input" id="ageManualInput" min="10" max="100" value="25" style="width: 100px;" onchange="updateAgeFromInput()">
          <button class="age-btn" onclick="adjustAge(1)"><i class="fas fa-plus"></i></button>
        </div>
        <div class="input-with-controls">
          <button class="unit-btn" onclick="setAge(18)">18</button>
          <button class="unit-btn" onclick="setAge(25)">25</button>
          <button class="unit-btn" onclick="setAge(35)">35</button>
          <button class="unit-btn" onclick="setAge(50)">50</button>
        </div>
      </div>

      <!-- Activity Level -->
      <div class="input-group">
        <label class="input-label">Activity Level</label>
        <div class="activity-levels">
          <div class="activity-level active" onclick="selectActivityLevel('sedentary')">
            <span>Sedentary</span>
            <span class="activity-info">Little or no exercise</span>
          </div>
          <div class="activity-level" onclick="selectActivityLevel('light')">
            <span>Lightly Active</span>
            <span class="activity-info">Light exercise 1-3 days/week</span>
          </div>
          <div class="activity-level" onclick="selectActivityLevel('moderate')">
            <span>Moderately Active</span>
            <span class="activity-info">Moderate exercise 3-5 days/week</span>
          </div>
          <div class="activity-level" onclick="selectActivityLevel('active')">
            <span>Very Active</span>
            <span class="activity-info">Hard exercise 6-7 days/week</span>
          </div>
          <div class="activity-level" onclick="selectActivityLevel('athlete')">
            <span>Extremely Active</span>
            <span class="activity-info">Very hard exercise & physical job</span>
          </div>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Daily Goal (ml)</label>
        <div class="input-with-controls">
          <input type="number" class="manual-input" id="dailyGoalInput" min="1000" max="5000" step="50" value="2000">
          <button class="unit-btn" onclick="calculateRecommendedGoal()">Recommended</button>
        </div>
      </div>

      <button class="btn" onclick="saveProfile()" style="margin-top: 30px;">
        <i class="fas fa-save"></i> Save Profile
      </button>
    </div>

    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-bell" style="color: var(--accent); margin-right: 10px;"></i>Reminders</h3>
      
      <div class="input-group">
        <label class="input-label">Enable Reminders</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="remindersEnabled" checked style="width: 20px; height: 20px;">
            <span>Enable daily reminders</span>
          </label>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Reminder Time</label>
        <input type="time" class="manual-input" id="reminderTime" value="09:00">
      </div>

      <div class="input-group">
        <label class="input-label">Reminder Frequency</label>
        <select class="manual-input" id="reminderFrequency">
          <option value="1">Every hour</option>
          <option value="2" selected>Every 2 hours</option>
          <option value="3">Every 3 hours</option>
          <option value="4">Every 4 hours</option>
        </select>
      </div>

      <button class="btn-secondary" onclick="testReminder()" style="margin-top: 10px;">
        <i class="fas fa-bell"></i> Test Reminder
      </button>
    </div>

    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-download" style="color: var(--accent); margin-right: 10px;"></i>Data Management</h3>
      
      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button class="btn-small" onclick="exportData()">
          <i class="fas fa-file-export"></i> Export Data
        </button>
        <button class="btn-small btn-secondary" onclick="importData()">
          <i class="fas fa-file-import"></i> Import Data
        </button>
        <button class="btn-small" onclick="resetData()" style="background: var(--danger);">
          <i class="fas fa-trash"></i> Reset All
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Navigation -->
<div class="nav">
  <div class="nav-item active" onclick="showScreen('dashboard')">
    <i class="fas fa-home"></i>
    <span>Home</span>
  </div>
  <div class="nav-item" onclick="openDrinkModal()">
    <i class="fas fa-plus-circle"></i>
    <span>Add</span>
  </div>
  <div class="nav-item" onclick="showScreen('statsScreen')">
    <i class="fas fa-chart-bar"></i>
    <span>Stats</span>
  </div>
  <div class="nav-item" onclick="showScreen('profileScreen')">
    <i class="fas fa-cog"></i>
    <span>Settings</span>
  </div>
</div>

<!-- Drink Selection Modal -->
<div class="modal" id="drinkModal">
  <div class="modal-content card">
    <div class="modal-header">
      <h3><i class="fas fa-wine-bottle"></i> Add Drink</h3>
      <button class="close-btn" onclick="closeModal('drinkModal')"><i class="fas fa-times"></i></button>
    </div>

    <div class="drink-grid" id="drinkGrid"></div>

    <button class="btn-secondary" onclick="closeModal('drinkModal')" style="margin-top: 20px;">
      Cancel
    </button>
  </div>
</div>

<!-- Amount Selection Modal -->
<div class="modal" id="amountModal">
  <div class="modal-content card">
    <div class="modal-header">
      <h3 id="amountTitle"><i class="fas fa-tint"></i> Select Amount</h3>
      <button class="close-btn" onclick="closeModal('amountModal')"><i class="fas fa-times"></i></button>
    </div>

    <div id="waterContentInfo" style="text-align: center; margin: 15px 0; padding: 15px; background: var(--glass); border-radius: 12px; border: 1px solid var(--glass-border);"></div>

    <div class="amount-grid" id="amountGrid"></div>

    <div style="margin-top: 20px;">
      <input type="number" class="custom-amount" id="customAmount" placeholder="Enter custom amount (ml)" min="1" max="5000">
    </div>

    <button class="btn" onclick="confirmDrink()" style="margin-top: 20px;">
      <i class="fas fa-check"></i> Add Drink
    </button>

    <button class="btn-secondary" onclick="closeModal('amountModal')" style="margin-top: 10px;">
      Cancel
    </button>
  </div>
</div>

<!-- Day Details Modal -->
<div class="modal" id="dayDetailsModal">
  <div class="modal-content card">
    <div class="modal-header">
      <h3><i class="fas fa-calendar-day"></i> Day Details</h3>
      <button class="close-btn" onclick="closeModal('dayDetailsModal')"><i class="fas fa-times"></i></button>
    </div>
    
    <div id="dayDetailsContent" style="max-height: 400px; overflow-y: auto;">
      <!-- Content will be populated by JavaScript -->
    </div>
    
    <button class="btn-secondary" onclick="closeModal('dayDetailsModal')" style="margin-top: 20px;">
      Close
    </button>
  </div>
</div>

<!-- Notification -->
<div id="notification" class="notification">
  <i class="fas fa-check-circle"></i> <span id="notificationText">Drink added successfully!</span>
</div>

<!-- Import Data Input (Hidden) -->
<input type="file" id="importFile" accept=".json" style="display: none;">

<script>
// ============================================
// WATERIFY PRO - FIXED & ENHANCED
// ============================================

// Beverage database
const BEVERAGES = {
  water: {
    name: "Water",
    icon: "fa-tint",
    color: "#4fd1ff",
    waterContent: 100,
    hydrationFactor: 1.0,
    description: "Pure hydration - no additives"
  },
  sparkling_water: {
    name: "Sparkling Water",
    icon: "fa-glass-water",
    color: "#6b7cff",
    waterContent: 100,
    hydrationFactor: 1.0,
    description: "Carbonated water - same hydration"
  },
  herbal_tea: {
    name: "Herbal Tea",
    icon: "fa-mug-hot",
    color: "#ffb84d",
    waterContent: 99,
    hydrationFactor: 0.95,
    description: "No caffeine - excellent hydration"
  },
  green_tea: {
    name: "Green Tea",
    icon: "fa-leaf",
    color: "#4dff88",
    waterContent: 99,
    hydrationFactor: 0.9,
    description: "Antioxidants - minimal caffeine"
  },
  black_coffee: {
    name: "Black Coffee",
    icon: "fa-coffee",
    color: "#8B4513",
    waterContent: 98,
    hydrationFactor: 0.85,
    description: "Caffeine reduces hydration by 15%"
  },
  milk: {
    name: "Milk",
    icon: "fa-cow",
    color: "#ffffff",
    waterContent: 87,
    hydrationFactor: 0.95,
    description: "Contains nutrients - good hydration"
  },
  fruit_juice: {
    name: "Fruit Juice",
    icon: "fa-apple-alt",
    color: "#ff6b6b",
    waterContent: 88,
    hydrationFactor: 0.8,
    description: "Natural sugars - moderate hydration"
  },
  sports_drink: {
    name: "Sports Drink",
    icon: "fa-bolt",
    color: "#ff4d6d",
    waterContent: 94,
    hydrationFactor: 0.9,
    description: "Electrolytes - good for exercise"
  },
  soda: {
    name: "Soda",
    icon: "fa-glass-whiskey",
    color: "#ff4757",
    waterContent: 90,
    hydrationFactor: 0.7,
    description: "High sugar - poor hydration"
  },
  smoothie: {
    name: "Smoothie",
    icon: "fa-blender",
    color: "#9d4edd",
    waterContent: 85,
    hydrationFactor: 0.85,
    description: "Nutrient-rich - good hydration"
  }
};

// Hydration tips
const HYDRATION_TIPS = [
  "Start your day with a glass of water to kickstart metabolism",
  "Drink water 30 minutes before meals for better digestion",
  "Your body is about 60% water - keep it replenished!",
  "Dehydration can reduce cognitive performance by up to 30%",
  "Carry a reusable water bottle to stay hydrated on the go",
  "Eat water-rich foods like watermelon, cucumber, and oranges",
  "Listen to your body - thirst is a sign you're already dehydrated",
  "Alcohol and caffeine can dehydrate you - balance with water",
  "Stay hydrated during exercise to maintain performance",
  "Proper hydration helps regulate body temperature"
];

// Activity level multipliers (based on scientific research)
const ACTIVITY_LEVELS = {
  sedentary: 1.0,    // Little or no exercise
  light: 1.2,       // Light exercise 1-3 days/week
  moderate: 1.4,    // Moderate exercise 3-5 days/week
  active: 1.6,      // Hard exercise 6-7 days/week
  athlete: 1.8      // Very hard exercise & physical job
};

// State management
let appState = {
  profile: null,
  todayData: null,
  historicalData: {},
  settings: {},
  selectedDrink: null,
  selectedAmount: 250,
  currentChartType: 'weekly',
  currentPieType: 'today',
  currentMonth: new Date().getMonth(),
  currentYear: new Date().getFullYear(),
  unitSystem: 'metric', // 'metric' or 'imperial'
  dataVersion: 4 // Current data version
};

// Charts
let trendChart = null;
let distributionChart = null;

// ============================================
// UNIT SYSTEM FUNCTIONS
// ============================================

function setUnitSystem(system) {
  appState.unitSystem = system;
  
  // Update UI
  document.querySelectorAll('.unit-system-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // Update labels
  if (system === 'metric') {
    document.getElementById('weightLabel').textContent = 'Weight (kg)';
    document.getElementById('heightLabel').textContent = 'Height (cm)';
    
    // Convert weight from lbs to kg if needed
    if (appState.profile && appState.profile.weight > 200) { // If weight looks like lbs
      appState.profile.weight = Math.round(appState.profile.weight / 2.20462);
    }
    
    // Convert height from ft/in to cm if needed
    if (appState.profile && appState.profile.height < 100) { // If height looks like inches
      appState.profile.height = Math.round(appState.profile.height * 2.54);
    }
  } else {
    document.getElementById('weightLabel').textContent = 'Weight (lbs)';
    document.getElementById('heightLabel').textContent = 'Height (ft/in)';
    
    // Convert weight from kg to lbs if needed
    if (appState.profile && appState.profile.weight < 200) { // If weight looks like kg
      appState.profile.weight = Math.round(appState.profile.weight * 2.20462);
    }
    
    // Convert height from cm to ft/in if needed
    if (appState.profile && appState.profile.height > 100) { // If height looks like cm
      const totalInches = appState.profile.height / 2.54;
      const feet = Math.floor(totalInches / 12);
      const inches = Math.round(totalInches % 12);
      // We'll store as inches for easier handling
      appState.profile.height = Math.round(totalInches);
    }
  }
  
  // Update UI with new values
  updateProfileUI();
}

function formatHeightForDisplay(heightInInches) {
  if (appState.unitSystem === 'metric') {
    // Convert inches to cm
    const cm = Math.round(heightInInches * 2.54);
    return cm;
  } else {
    // Convert inches to ft/in
    const feet = Math.floor(heightInInches / 12);
    const inches = Math.round(heightInInches % 12);
    return `${feet}'${inches}"`;
  }
}

function formatWeightForDisplay(weightInLbs) {
  if (appState.unitSystem === 'metric') {
    // Convert lbs to kg
    const kg = Math.round(weightInLbs / 2.20462);
    return kg;
  } else {
    return weightInLbs;
  }
}

// ============================================
// DATA MIGRATION SYSTEM
// ============================================

function migrateData() {
  const version = localStorage.getItem('waterify_version') || 1;
  const currentVersion = 4;
  
  if (parseInt(version) < currentVersion) {
    console.log(`Migrating from version ${version} to ${currentVersion}`);
    
    // Migrate from version 1 to 4
    if (version <= 3) {
      // Check if old data exists
      const oldProfile = JSON.parse(localStorage.getItem('waterify_profile') || localStorage.getItem('hydrotrack_profile'));
      const oldHistory = JSON.parse(localStorage.getItem('waterify_history') || localStorage.getItem('hydrotrack_history') || {});
      
      if (oldProfile) {
        // Add missing fields with default values
        if (!oldProfile.gender) oldProfile.gender = 'male';
        if (!oldProfile.activityLevel) oldProfile.activityLevel = 'moderate';
        if (!oldProfile.currentStreak) oldProfile.currentStreak = 0;
        if (!oldProfile.bestStreak) oldProfile.bestStreak = 0;
        if (!oldProfile.unitSystem) oldProfile.unitSystem = 'metric';
        
        // Recalculate goal with new formula
        oldProfile.dailyGoal = calculateRecommendedGoalValue(
          oldProfile.weight || 70,
          oldProfile.height || 170,
          oldProfile.age || 25,
          oldProfile.gender || 'male',
          oldProfile.activityLevel || 'moderate'
        );
        
        localStorage.setItem('waterify_profile', JSON.stringify(oldProfile));
      }
      
      // Fix historical data structure
      const today = new Date().toDateString();
      const todayData = JSON.parse(localStorage.getItem('waterify_today') || localStorage.getItem('hydrotrack_today'));
      
      if (todayData && todayData.date !== today) {
        // Save yesterday's data to history
        oldHistory[todayData.date] = todayData;
        localStorage.setItem('waterify_history', JSON.stringify(oldHistory));
      }
      
      // Update version
      localStorage.setItem('waterify_version', currentVersion);
      
      // Clean up old storage keys
      localStorage.removeItem('hydrotrack_profile');
      localStorage.removeItem('hydrotrack_today');
      localStorage.removeItem('hydrotrack_history');
      localStorage.removeItem('hydrotrack_settings');
      localStorage.removeItem('hydrotrack_version');
    }
  }
}

// ============================================
// SCIENTIFIC GOAL CALCULATION
// ============================================

function calculateRecommendedGoalValue(weight, height, age, gender, activityLevel = 'moderate') {
  // Official formula based on medical research:
  // Base water requirement = 30-40 ml per kg of body weight
  // Adjust for gender, age, height, and activity level
  
  let baseGoal;
  
  // Convert weight to kg if in imperial
  let weightInKg = weight;
  if (appState.unitSystem === 'imperial') {
    weightInKg = weight / 2.20462;
  }
  
  // Convert height to cm if in imperial
  let heightInCm = height;
  if (appState.unitSystem === 'imperial') {
    heightInCm = height * 2.54;
  }
  
  // Base calculation (ml per kg)
  if (gender === 'male') {
    baseGoal = weightInKg * 35; // 35 ml/kg for men
  } else if (gender === 'female') {
    baseGoal = weightInKg * 31; // 31 ml/kg for women
  } else {
    baseGoal = weightInKg * 33; // Average for other
  }
  
  // Adjust for height (taller = more water)
  // Normalize to 170cm reference height
  const heightFactor = heightInCm / 170;
  baseGoal *= heightFactor;
  
  // Adjust for age (older = slightly less, children = more)
  if (age < 18) {
    // Children and teens need more relative to weight
    baseGoal *= 1.1;
  } else if (age > 50) {
    // Elderly need slightly less
    baseGoal *= 0.95;
  }
  
  // Apply activity level multiplier
  const activityMultiplier = ACTIVITY_LEVELS[activityLevel] || 1.0;
  baseGoal *= activityMultiplier;
  
  // Round to nearest 50ml
  const roundedGoal = Math.round(baseGoal / 50) * 50;
  
  // Ensure goal is within safe and reasonable bounds (1500-4000ml)
  return Math.max(1500, Math.min(roundedGoal, 4000));
}

function calculateRecommendedGoal() {
  if (!appState.profile) return;
  
  const goal = calculateRecommendedGoalValue(
    appState.profile.weight,
    appState.profile.height,
    appState.profile.age,
    appState.profile.gender,
    appState.profile.activityLevel
  );
  
  document.getElementById('dailyGoalInput').value = goal;
  appState.profile.dailyGoal = goal;
  appState.todayData.goal = goal;
  
  showNotification(`Recommended daily goal: ${goal}ml`, "success");
}

// ============================================
// INITIALIZATION - WITH NEW USER FLOW
// ============================================

function initializeApp() {
  // Run data migration first
  migrateData();
  
  // Load all data
  loadAllData();
  
  // Check if this is a new user (no profile exists)
  const isNewUser = !appState.profile;
  
  // Initialize default profile if none exists
  if (!appState.profile) {
    appState.profile = {
      name: "User",
      weight: 70, // kg
      height: 170, // cm
      age: 25,
      gender: "male",
      activityLevel: "moderate",
      unitSystem: "metric",
      dailyGoal: calculateRecommendedGoalValue(70, 170, 25, "male", "moderate"),
      createdAt: new Date().toISOString(),
      currentStreak: 0,
      bestStreak: 0,
      profileComplete: false
    };
  }
  
  // Initialize today's data
  const today = new Date().toDateString();
  const todayData = JSON.parse(localStorage.getItem('waterify_today'));
  
  if (!todayData || todayData.date !== today) {
    // Check and update streak
    checkAndUpdateStreak();
    
    // Save yesterday's data to history if it exists
    if (todayData && todayData.date !== today) {
      appState.historicalData[todayData.date] = todayData;
      saveAllData();
    }
    
    // Create new day data
    appState.todayData = {
      date: today,
      consumed: 0,
      drinks: [],
      goal: appState.profile.dailyGoal,
      completed: false
    };
  } else {
    appState.todayData = todayData;
  }
  
  // Initialize settings
  if (!appState.settings.reminders) {
    appState.settings = {
      reminders: {
        enabled: true,
        frequency: 2,
        time: "09:00"
      }
    };
  }
  
  // Update UI
  updateDashboard();
  updateProfileUI();
  updateTimeProgress();
  setupReminders();
  
  // Set greeting message based on time of day
  updateGreetingMessage();
  
  // Initialize charts
  setTimeout(() => {
    if (typeof Chart !== 'undefined') {
      initializeCharts();
    }
  }, 100);
  
  // Create water drop animations
  createWaterDrops();
  
  // If new user or profile not complete, show profile screen first
  if (isNewUser || !appState.profile.profileComplete) {
    setTimeout(() => {
      showScreen('profileScreen');
      showNotification("Welcome! Please complete your profile to get started.", "success");
    }, 500);
  }
}

function loadAllData() {
  try {
    appState.profile = JSON.parse(localStorage.getItem('waterify_profile')) || null;
    
    // Load today's data
    const todayData = JSON.parse(localStorage.getItem('waterify_today'));
    const today = new Date().toDateString();
    
    if (todayData && todayData.date === today) {
      appState.todayData = todayData;
    }
    
    appState.historicalData = JSON.parse(localStorage.getItem('waterify_history')) || {};
    appState.settings = JSON.parse(localStorage.getItem('waterify_settings')) || {};
  } catch (e) {
    console.error('Error loading data:', e);
    // Initialize fresh data on error
    appState.profile = null;
    appState.todayData = null;
    appState.historicalData = {};
    appState.settings = {};
  }
}

function saveAllData() {
  try {
    localStorage.setItem('waterify_profile', JSON.stringify(appState.profile));
    localStorage.setItem('waterify_today', JSON.stringify(appState.todayData));
    localStorage.setItem('waterify_history', JSON.stringify(appState.historicalData));
    localStorage.setItem('waterify_settings', JSON.stringify(appState.settings));
    localStorage.setItem('waterify_version', '4'); // Save current version
  } catch (e) {
    console.error('Error saving data:', e);
  }
}

// ============================================
// NEW FEATURES
// ============================================

function updateGreetingMessage() {
  const hour = new Date().getHours();
  let greeting = "Stay Hydrated, Stay Healthy";
  
  if (hour < 12) greeting = "Good morning! Stay hydrated today";
  else if (hour < 18) greeting = "Good afternoon! Keep drinking water";
  else greeting = "Good evening! Finish your hydration goal";
  
  document.getElementById('greetingMessage').textContent = greeting;
}

function updateTimeProgress() {
  const container = document.getElementById('timeProgress');
  const timeSlots = [
    { label: "6-9 AM", hour: 7 },
    { label: "9-12 PM", hour: 10 },
    { label: "12-3 PM", hour: 13 },
    { label: "3-6 PM", hour: 16 }
  ];
  
  const currentHour = new Date().getHours();
  
  container.innerHTML = '';
  
  timeSlots.forEach(slot => {
    const div = document.createElement('div');
    div.className = 'time-slot';
    
    if (currentHour >= slot.hour && currentHour < slot.hour + 3) {
      div.classList.add('active');
    }
    
    // Calculate drinks in this time slot
    const drinksInSlot = appState.todayData?.drinks?.filter(drink => {
      const drinkHour = new Date(drink.timestamp).getHours();
      return drinkHour >= slot.hour && drinkHour < slot.hour + 3;
    }) || [];
    
    const totalInSlot = drinksInSlot.reduce((sum, drink) => sum + drink.amount, 0);
    
    div.innerHTML = `
      <div class="time-label">${slot.label}</div>
      <div class="time-value">${totalInSlot}ml</div>
    `;
    
    container.appendChild(div);
  });
}

function quickAddDrink(type, amount) {
  addDrink(type, amount);
}

function setGoalPercentage(percentage) {
  const goal = appState.profile.dailyGoal;
  const targetAmount = Math.round((goal * percentage) / 100);
  
  if (appState.todayData.consumed < targetAmount) {
    const needed = targetAmount - appState.todayData.consumed;
    if (needed > 0) {
      addDrink('water', needed);
    }
  }
  
  // Update active state on hydration levels
  document.querySelectorAll('.hydration-level').forEach((level, index) => {
    level.classList.toggle('active', 
      (percentage === 0 && index === 0) ||
      (percentage === 25 && index === 1) ||
      (percentage === 50 && index === 2) ||
      (percentage === 75 && index === 3) ||
      (percentage === 100 && index === 4)
    );
  });
}

function selectGender(gender) {
  if (!appState.profile) return;
  appState.profile.gender = gender;
  
  // Update UI - FIXED: Only activate clicked gender
  document.querySelectorAll('.gender-option').forEach(option => {
    option.classList.remove('active');
    if (option.textContent.toLowerCase().includes(gender)) {
      option.classList.add('active');
    }
  });
  
  // Save immediately
  saveAllData();
}

function selectActivityLevel(level) {
  if (!appState.profile) return;
  appState.profile.activityLevel = level;
  
  document.querySelectorAll('.activity-level').forEach(item => {
    item.classList.remove('active');
    const levelText = item.querySelector('span:first-child').textContent.toLowerCase();
    if (levelText.includes(level)) {
      item.classList.add('active');
    }
  });
}

function createWaterDrops() {
  const container = document.getElementById('waterDropsContainer');
  if (!container) return;
  
  // Create animated water drops in background
  for (let i = 0; i < 15; i++) {
    setTimeout(() => {
      const drop = document.createElement('div');
      drop.className = 'water-drop';
      drop.style.left = `${Math.random() * 100}%`;
      drop.style.animationDelay = `${Math.random() * 2}s`;
      drop.style.width = `${Math.random() * 10 + 5}px`;
      drop.style.height = `${Math.random() * 20 + 10}px`;
      drop.style.opacity = Math.random() * 0.3 + 0.1;
      
      container.appendChild(drop);
      
      // Remove drop after animation
      setTimeout(() => {
        if (drop.parentNode) {
          drop.parentNode.removeChild(drop);
        }
      }, 1500);
    }, i * 300);
  }
  
  // Repeat every 15 seconds
  setTimeout(createWaterDrops, 15000);
}

// ============================================
// CORE FUNCTIONS
// ============================================

function checkAndUpdateStreak() {
  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayStr = yesterday.toDateString();
  
  // Get yesterday's data from history
  const yesterdayData = appState.historicalData[yesterdayStr];
  
  if (yesterdayData) {
    if (yesterdayData.completed) {
      appState.profile.currentStreak = (appState.profile.currentStreak || 0) + 1;
      appState.profile.bestStreak = Math.max(appState.profile.bestStreak || 0, appState.profile.currentStreak);
    } else {
      appState.profile.currentStreak = 0;
    }
  }
}

function addDrink(type, amount) {
  const drink = BEVERAGES[type];
  if (!drink) return;
  
  const waterContent = Math.round(amount * drink.waterContent / 100);
  const effectiveHydration = Math.round(waterContent * drink.hydrationFactor);
  
  const drinkRecord = {
    type,
    amount,
    waterContent,
    effectiveHydration,
    timestamp: new Date().toISOString(),
    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
  };
  
  appState.todayData.consumed += effectiveHydration;
  if (!appState.todayData.drinks) appState.todayData.drinks = [];
  appState.todayData.drinks.push(drinkRecord);
  
  if (!appState.todayData.completed && appState.todayData.consumed >= appState.todayData.goal) {
    appState.todayData.completed = true;
    showNotification(" Daily goal achieved! Great work!", "success");
  }
  
  saveAllData();
  updateDashboard();
  updateStatistics();
  updateTimeProgress();
  showNotification(`Added ${amount}ml of ${drink.name} (${waterContent}ml water)`, "success");
}

// ============================================
// UI UPDATES (FIXED)
// ============================================

function updateDashboard() {
  if (!appState.todayData) return;
  
  const consumed = appState.todayData.consumed || 0;
  const goal = appState.todayData.goal || appState.profile?.dailyGoal || 2000;
  const progress = Math.min(Math.round((consumed / goal) * 100), 100);
  
  document.getElementById('progressFill').style.width = `${progress}%`;
  document.getElementById('progressText').textContent = `${progress}%`;
  document.getElementById('waterLevel').style.height = `${progress}%`;
  document.getElementById('consumedDisplay').textContent = `${consumed.toLocaleString()} ml`;
  document.getElementById('goalDisplay').textContent = `of ${goal.toLocaleString()} ml goal`;
  document.getElementById('drinksCount').textContent = appState.todayData.drinks?.length || 0;
  
  // Update streak from profile
  document.getElementById('streakCount').textContent = appState.profile?.currentStreak || 0;
  
  // Calculate today's average drink size
  const todayDrinks = appState.todayData.drinks || [];
  let todayAvg = 0;
  if (todayDrinks.length > 0) {
    const totalAmount = todayDrinks.reduce((sum, drink) => sum + drink.amount, 0);
    todayAvg = Math.round(totalAmount / todayDrinks.length);
  }
  document.getElementById('todayAvg').textContent = `${todayAvg}ml`;
  
  // Update quick stats
  updateQuickStats();
  
  // Update recent activity
  updateRecentActivity();
  
  // Update hydration tip
  updateHydrationTip();
  
  // Update user name display
  if (appState.profile?.name) {
    document.getElementById('userName').textContent = appState.profile.name;
  }
}

function updateQuickStats() {
  if (!appState.todayData || !appState.historicalData) return;
  
  // Today's best drink
  const todayDrinks = appState.todayData.drinks || [];
  const todayBest = todayDrinks.length > 0 ? Math.max(...todayDrinks.map(d => d.amount)) : 0;
  document.getElementById('todayBest').textContent = `${todayBest}ml`;
  
  // Weekly average - only count days with data
  const last7Days = getLastNDays(7);
  const daysWithData = last7Days.filter(d => d && d.consumed > 0);
  const weeklyTotal = daysWithData.reduce((sum, day) => sum + (day?.consumed || 0), 0);
  const weekAvg = daysWithData.length > 0 ? Math.round(weeklyTotal / daysWithData.length) : 0;
  document.getElementById('weekAvg').textContent = `${weekAvg}ml`;
  
  // Monthly total (last 30 days)
  const last30Days = getLastNDays(30);
  const monthlyTotal = last30Days.reduce((sum, day) => sum + (day?.consumed || 0), 0);
  document.getElementById('monthTotal').textContent = `${Math.round(monthlyTotal / 1000)}L`;
  
  // Goal days percentage
  const goalDays = last30Days.filter(d => d?.completed).length;
  const goalPercent = last30Days.length > 0 ? Math.round((goalDays / last30Days.length) * 100) : 0;
  document.getElementById('goalDays').textContent = `${goalPercent}%`;
}

function getLastNDays(n) {
  const days = [];
  for (let i = 0; i < n; i++) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const dateStr = date.toDateString();
    days.push(appState.historicalData[dateStr]);
  }
  return days;
}

function updateRecentActivity() {
  const container = document.getElementById('recentActivity');
  if (!appState.todayData?.drinks) return;
  
  const recentDrinks = appState.todayData.drinks.slice(-5).reverse();
  
  if (recentDrinks.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 20px; color: var(--muted);">
        <i class="fas fa-tint" style="font-size: 24px; margin-bottom: 10px; display: block; opacity: 0.5;"></i>
        No drinks added yet today
      </div>
    `;
    return;
  }
  
  container.innerHTML = '';
  recentDrinks.forEach(drink => {
    const beverage = BEVERAGES[drink.type];
    if (!beverage) return;
    
    const item = document.createElement('div');
    item.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      margin-bottom: 8px;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      transition: all 0.3s ease;
    `;
    
    item.innerHTML = `
      <div style="display: flex; align-items: center; gap: 12px;">
        <i class="fas ${beverage.icon}" style="color: ${beverage.color}; font-size: 20px;"></i>
        <div>
          <div style="font-weight: 600; font-size: 14px;">${beverage.name}</div>
          <div style="font-size: 12px; color: var(--muted);">${drink.time}</div>
        </div>
      </div>
      <div style="text-align: right;">
        <div style="font-weight: 700; font-size: 16px;">${drink.amount}ml</div>
        <div style="font-size: 11px; color: var(--accent);">${drink.waterContent}ml water</div>
      </div>
    `;
    
    container.appendChild(item);
  });
}

function updateHydrationTip() {
  const tip = HYDRATION_TIPS[Math.floor(Math.random() * HYDRATION_TIPS.length)];
  document.getElementById('hydrationTip').textContent = tip;
}

// ============================================
// PROFILE MANAGEMENT (WITH IMPROVED RULERS)
// ============================================

function updateProfileUI() {
  if (!appState.profile) return;
  
  const profile = appState.profile;
  
  document.getElementById('userName').textContent = profile.name || 'Profile';
  document.getElementById('userNameInput').value = profile.name || '';
  
  // Update weight display based on unit system
  const weightDisplay = formatWeightForDisplay(profile.weight);
  document.getElementById('weightValue').textContent = weightDisplay;
  document.getElementById('weightInput').value = weightDisplay;
  
  // Update height display based on unit system
  const heightDisplay = formatHeightForDisplay(profile.height);
  document.getElementById('heightValue').textContent = heightDisplay;
  document.getElementById('heightInput').value = profile.height; // Store in inches internally
  
  document.getElementById('ageValue').textContent = profile.age;
  document.getElementById('ageManualInput').value = profile.age;
  document.getElementById('dailyGoalInput').value = profile.dailyGoal || 2000;
  
  document.getElementById('remindersEnabled').checked = appState.settings.reminders?.enabled || true;
  document.getElementById('reminderTime').value = appState.settings.reminders?.time || "09:00";
  document.getElementById('reminderFrequency').value = appState.settings.reminders?.frequency || 2;
  
  // Update unit system toggle
  document.querySelectorAll('.unit-system-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.textContent.includes(appState.unitSystem === 'metric' ? 'Metric' : 'Imperial')) {
      btn.classList.add('active');
    }
  });
  
  // Update gender selection - FIXED: Only activate correct gender
  document.querySelectorAll('.gender-option').forEach(option => {
    option.classList.remove('active');
    const optionText = option.textContent.toLowerCase();
    if (optionText.includes(profile.gender)) {
      option.classList.add('active');
    }
  });
  
  // Update activity level selection
  document.querySelectorAll('.activity-level').forEach(item => {
    item.classList.remove('active');
    const levelText = item.querySelector('span:first-child').textContent.toLowerCase();
    if (levelText.includes(profile.activityLevel)) {
      item.classList.add('active');
    }
  });
  
  // Initialize rulers with 1-unit increments
  if (appState.unitSystem === 'metric') {
    initRuler('weightRuler', 30, 200, weightDisplay, 'kg', (value) => {
      appState.profile.weight = value;
      document.getElementById('weightValue').textContent = value;
      document.getElementById('weightInput').value = value;
    });
    
    initRuler('heightRuler', 100, 250, heightDisplay, 'cm', (value) => {
      appState.profile.height = value;
      document.getElementById('heightValue').textContent = value;
      document.getElementById('heightInput').value = value;
    });
  } else {
    initRuler('weightRuler', 66, 440, weightDisplay, 'lbs', (value) => {
      appState.profile.weight = value;
      document.getElementById('weightValue').textContent = value;
      document.getElementById('weightInput').value = value;
    });
    
    // For height in imperial, we need special handling
    initHeightRulerImperial();
  }
  
  updateDrinkGrid();
}

function initRuler(containerId, min, max, initial, unit, onChange) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  
  // Create ticks every 1 unit
  for (let i = min; i <= max; i++) {
    const tick = document.createElement('div');
    tick.className = 'ruler-tick';
    tick.dataset.value = i;
    
    // Show label for every 5 units
    const showLabel = i % 5 === 0;
    const lineHeight = showLabel ? 40 : (i % 2 === 0 ? 30 : 20);
    
    tick.innerHTML = `
      <div class="tick-line" style="height: ${lineHeight}px;"></div>
      ${showLabel ? `<div class="tick-label">${i}${unit}</div>` : ''}
    `;
    
    if (i === initial) {
      tick.classList.add('active');
    }
    
    container.appendChild(tick);
  }
  
  // Set up scroll event listener for auto-update
  let scrollTimeout;
  container.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      const center = container.scrollLeft + container.clientWidth / 2;
      const ticks = Array.from(container.children);
      let closestTick = null;
      let closestDistance = Infinity;
      
      ticks.forEach(tick => {
        const tickCenter = tick.offsetLeft + tick.offsetWidth / 2;
        const distance = Math.abs(tickCenter - center);
        
        if (distance < closestDistance) {
          closestDistance = distance;
          closestTick = tick;
        }
      });
      
      if (closestTick) {
        const value = parseInt(closestTick.dataset.value);
        onChange(value);
        
        // Update active state
        ticks.forEach(t => t.classList.remove('active'));
        closestTick.classList.add('active');
        
        // Vibrate if supported
        if (navigator.vibrate) {
          navigator.vibrate(10);
        }
      }
    }, 150);
  });
  
  // Scroll to initial value
  setTimeout(() => {
    const tickWidth = 20;
    const centerOffset = container.clientWidth / 2;
    const targetTick = Array.from(container.children).find(t => parseInt(t.dataset.value) === initial);
    if (targetTick) {
      const tickIndex = Array.from(container.children).indexOf(targetTick);
      container.scrollLeft = (tickIndex * tickWidth) - centerOffset + (tickWidth / 2);
    }
  }, 100);
}

function initHeightRulerImperial() {
  const container = document.getElementById('heightRuler');
  container.innerHTML = '';
  
  // For imperial height, we create ticks from 48 inches (4 feet) to 84 inches (7 feet)
  for (let inches = 48; inches <= 84; inches++) {
    const tick = document.createElement('div');
    tick.className = 'ruler-tick';
    tick.dataset.value = inches;
    
    const feet = Math.floor(inches / 12);
    const remainingInches = inches % 12;
    
    // Show label for every inch, but format nicely
    const showLabel = remainingInches === 0 || remainingInches === 6;
    const lineHeight = showLabel ? 40 : (inches % 3 === 0 ? 30 : 20);
    
    let label = '';
    if (showLabel) {
      if (remainingInches === 0) {
        label = `${feet}'`;
      } else {
        label = `${feet}'${remainingInches}"`;
      }
    }
    
    tick.innerHTML = `
      <div class="tick-line" style="height: ${lineHeight}px;"></div>
      ${showLabel ? `<div class="tick-label">${label}</div>` : ''}
    `;
    
    if (inches === appState.profile.height) {
      tick.classList.add('active');
    }
    
    container.appendChild(tick);
  }
  
  // Set up scroll event listener
  let scrollTimeout;
  container.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      const center = container.scrollLeft + container.clientWidth / 2;
      const ticks = Array.from(container.children);
      let closestTick = null;
      let closestDistance = Infinity;
      
      ticks.forEach(tick => {
        const tickCenter = tick.offsetLeft + tick.offsetWidth / 2;
        const distance = Math.abs(tickCenter - center);
        
        if (distance < closestDistance) {
          closestDistance = distance;
          closestTick = tick;
        }
      });
      
      if (closestTick) {
        const value = parseInt(closestTick.dataset.value);
        appState.profile.height = value;
        
        // Update display
        const feet = Math.floor(value / 12);
        const inches = value % 12;
        document.getElementById('heightValue').textContent = `${feet}'${inches}"`;
        document.getElementById('heightInput').value = value;
        
        // Update active state
        ticks.forEach(t => t.classList.remove('active'));
        closestTick.classList.add('active');
        
        // Vibrate if supported
        if (navigator.vibrate) {
          navigator.vibrate(10);
        }
      }
    }, 150);
  });
  
  // Scroll to initial value
  setTimeout(() => {
    const tickWidth = 20;
    const centerOffset = container.clientWidth / 2;
    const targetTick = Array.from(container.children).find(t => parseInt(t.dataset.value) === appState.profile.height);
    if (targetTick) {
      const tickIndex = Array.from(container.children).indexOf(targetTick);
      container.scrollLeft = (tickIndex * tickWidth) - centerOffset + (tickWidth / 2);
    }
  }, 100);
}

function adjustWeight(change) {
  const input = document.getElementById('weightInput');
  let value = parseInt(input.value) + change;
  
  if (appState.unitSystem === 'metric') {
    value = Math.max(30, Math.min(200, value));
  } else {
    value = Math.max(66, Math.min(440, value));
  }
  
  input.value = value;
  appState.profile.weight = value;
  document.getElementById('weightValue').textContent = value;
  updateRuler('weightRuler', value);
}

function adjustHeight(change) {
  const input = document.getElementById('heightInput');
  let value = parseInt(input.value) + change;
  
  if (appState.unitSystem === 'metric') {
    value = Math.max(100, Math.min(250, value));
    appState.profile.height = value;
    document.getElementById('heightValue').textContent = value;
    updateRuler('heightRuler', value);
  } else {
    value = Math.max(48, Math.min(84, value));
    appState.profile.height = value;
    const feet = Math.floor(value / 12);
    const inches = value % 12;
    document.getElementById('heightValue').textContent = `${feet}'${inches}"`;
    updateRuler('heightRuler', value);
  }
  
  input.value = value;
}

function adjustAge(change) {
  const input = document.getElementById('ageManualInput');
  let value = parseInt(input.value) + change;
  value = Math.max(10, Math.min(100, value));
  input.value = value;
  appState.profile.age = value;
  document.getElementById('ageValue').textContent = value;
}

function setAge(age) {
  const input = document.getElementById('ageManualInput');
  input.value = age;
  appState.profile.age = age;
  document.getElementById('ageValue').textContent = age;
}

function updateWeightFromInput() {
  const input = document.getElementById('weightInput');
  let value = parseInt(input.value);
  
  if (appState.unitSystem === 'metric') {
    value = Math.max(30, Math.min(200, value));
  } else {
    value = Math.max(66, Math.min(440, value));
  }
  
  input.value = value;
  appState.profile.weight = value;
  document.getElementById('weightValue').textContent = value;
  updateRuler('weightRuler', value);
}

function updateHeightFromInput() {
  const input = document.getElementById('heightInput');
  let value = parseInt(input.value);
  
  if (appState.unitSystem === 'metric') {
    value = Math.max(100, Math.min(250, value));
    appState.profile.height = value;
    document.getElementById('heightValue').textContent = value;
    updateRuler('heightRuler', value);
  } else {
    value = Math.max(48, Math.min(84, value));
    appState.profile.height = value;
    const feet = Math.floor(value / 12);
    const inches = value % 12;
    document.getElementById('heightValue').textContent = `${feet}'${inches}"`;
    updateRuler('heightRuler', value);
  }
  
  input.value = value;
}

function updateAgeFromInput() {
  const input = document.getElementById('ageManualInput');
  let value = parseInt(input.value);
  value = Math.max(10, Math.min(100, value));
  input.value = value;
  appState.profile.age = value;
  document.getElementById('ageValue').textContent = value;
}

function updateRuler(containerId, value) {
  const container = document.getElementById(containerId);
  Array.from(container.children).forEach(tick => {
    const tickValue = parseInt(tick.dataset.value);
    tick.classList.toggle('active', tickValue === value);
  });
}

function saveProfile() {
  // Save profile data
  appState.profile.name = document.getElementById('userNameInput').value || 'User';
  appState.profile.weight = parseInt(document.getElementById('weightInput').value);
  appState.profile.height = parseInt(document.getElementById('heightInput').value);
  appState.profile.age = parseInt(document.getElementById('ageManualInput').value);
  appState.profile.dailyGoal = parseInt(document.getElementById('dailyGoalInput').value);
  appState.profile.profileComplete = true;
  
  // Get gender from active button
  const activeGender = document.querySelector('.gender-option.active');
  if (activeGender) {
    const genderText = activeGender.textContent.toLowerCase();
    if (genderText.includes('male')) appState.profile.gender = 'male';
    else if (genderText.includes('female')) appState.profile.gender = 'female';
    else appState.profile.gender = 'other';
  }
  
  // Get activity level from active item
  const activeActivity = document.querySelector('.activity-level.active');
  if (activeActivity) {
    const activityText = activeActivity.querySelector('span:first-child').textContent.toLowerCase();
    if (activityText.includes('sedentary')) appState.profile.activityLevel = 'sedentary';
    else if (activityText.includes('light')) appState.profile.activityLevel = 'light';
    else if (activityText.includes('moderate')) appState.profile.activityLevel = 'moderate';
    else if (activityText.includes('active')) appState.profile.activityLevel = 'active';
    else if (activityText.includes('athlete')) appState.profile.activityLevel = 'athlete';
  }
  
  appState.settings.reminders = {
    enabled: document.getElementById('remindersEnabled').checked,
    frequency: parseInt(document.getElementById('reminderFrequency').value),
    time: document.getElementById('reminderTime').value
  };
  
  appState.todayData.goal = appState.profile.dailyGoal;
  
  saveAllData();
  updateDashboard();
  setupReminders();
  
  showNotification("Profile saved successfully!", "success");
  closeProfile();
}

// ============================================
// STATISTICS & CALENDAR - WITH DAY DETAILS
// ============================================

function openStats() {
  showScreen('statsScreen');
  updateStatistics();
  renderCalendar();
  updateCharts();
}

function updateStatistics() {
  const history = appState.historicalData;
  const todayData = appState.todayData;
  
  // Combine history with today's data
  let allDays = Object.values(history);
  if (todayData && todayData.consumed > 0) {
    allDays = [todayData, ...allDays];
  }
  
  if (allDays.length === 0) {
    document.getElementById('totalConsumed').textContent = '0';
    document.getElementById('avgDaily').textContent = '0';
    document.getElementById('bestDay').textContent = '0';
    document.getElementById('completionRate').textContent = '0%';
    return;
  }
  
  // Calculate statistics correctly
  const totalConsumed = allDays.reduce((sum, day) => sum + (day.consumed || 0), 0);
  const avgDaily = Math.round(totalConsumed / allDays.length);
  const bestDay = Math.max(...allDays.map(d => d.consumed || 0));
  const completionRate = Math.round((allDays.filter(d => d.completed).length / allDays.length) * 100);
  
  document.getElementById('totalConsumed').textContent = Math.round(totalConsumed / 1000).toLocaleString() + 'L';
  document.getElementById('avgDaily').textContent = avgDaily.toLocaleString() + 'ml';
  document.getElementById('bestDay').textContent = bestDay.toLocaleString() + 'ml';
  document.getElementById('completionRate').textContent = `${completionRate}%`;
}

function renderCalendar() {
  const container = document.getElementById('calendarContainer');
  const month = appState.currentMonth;
  const year = appState.currentYear;
  
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
  
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  container.innerHTML = '';
  
  // Day headers
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  dayNames.forEach(day => {
    const dayElement = document.createElement('div');
    dayElement.style.cssText = `
      text-align: center;
      padding: 8px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
    `;
    dayElement.textContent = day;
    container.appendChild(dayElement);
  });
  
  // Empty cells for days before first day
  for (let i = 0; i < firstDay; i++) {
    const empty = document.createElement('div');
    empty.style.cssText = `
      aspect-ratio: 1;
      border-radius: 8px;
      opacity: 0.3;
    `;
    container.appendChild(empty);
  }
  
  // Days of the month
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    const dateStr = date.toDateString();
    const dayData = appState.historicalData[dateStr];
    
    const dayElement = document.createElement('div');
    dayElement.style.cssText = `
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      background: var(--glass);
      border: 1px solid var(--glass-border);
    `;
    
    dayElement.textContent = day;
    
    // Add click event to show day details
    dayElement.onclick = () => showDayDetails(date, dayData);
    
    if (dayData) {
      const goal = appState.profile?.dailyGoal || 2000;
      const progress = Math.min((dayData.consumed / goal) * 100, 100);
      
      // Color coding based on progress
      if (progress >= 100) {
        dayElement.style.background = `linear-gradient(135deg, var(--success), rgba(77, 255, 184, 0.3))`;
        dayElement.style.borderColor = 'var(--success)';
      } else if (progress >= 75) {
        dayElement.style.background = `linear-gradient(135deg, #a6ff4d, rgba(166, 255, 77, 0.3))`;
      } else if (progress >= 50) {
        dayElement.style.background = `linear-gradient(135deg, var(--warning), rgba(255, 184, 77, 0.3))`;
      } else if (progress > 0) {
        dayElement.style.background = `linear-gradient(135deg, #ff9966, rgba(255, 153, 102, 0.3))`;
      }
      
      if (dayData.completed) {
        dayElement.style.border = '2px solid var(--accent)';
      }
    }
    
    // Highlight today
    if (date.toDateString() === new Date().toDateString()) {
      dayElement.style.boxShadow = '0 0 0 2px var(--accent)';
      dayElement.style.fontWeight = '700';
    }
    
    // Add tooltip on hover
    dayElement.title = dayData ? 
      `${dayData.consumed}ml consumed (${Math.round((dayData.consumed / (appState.profile?.dailyGoal || 2000)) * 100)}%)` : 
      'No data';
    
    container.appendChild(dayElement);
  }
}

function showDayDetails(date, dayData) {
  const container = document.getElementById('dayDetailsContent');
  const dateStr = date.toDateString();
  const formattedDate = date.toLocaleDateString('en-US', { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
  
  if (!dayData) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px 20px;">
        <i class="fas fa-tint" style="font-size: 48px; color: var(--muted); margin-bottom: 20px; opacity: 0.5;"></i>
        <h3 style="margin: 0 0 10px 0; color: var(--text);">${formattedDate}</h3>
        <p style="color: var(--muted); margin: 0;">No hydration data recorded for this day.</p>
      </div>
    `;
  } else {
    const goal = appState.profile?.dailyGoal || 2000;
    const progress = Math.min((dayData.consumed / goal) * 100, 100);
    const drinks = dayData.drinks || [];
    
    let drinksHTML = '';
    if (drinks.length > 0) {
      drinksHTML = '<h4 style="margin: 20px 0 10px 0; color: var(--accent);">Drinks Consumed:</h4>';
      drinks.forEach(drink => {
        const beverage = BEVERAGES[drink.type] || { name: drink.type, icon: 'fa-question', color: '#9aa4bf' };
        drinksHTML += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background: var(--glass); border-radius: 8px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <i class="fas ${beverage.icon}" style="color: ${beverage.color};"></i>
              <span>${beverage.name}</span>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: 600;">${drink.amount}ml</div>
              <div style="font-size: 11px; color: var(--accent);">${drink.time}</div>
            </div>
          </div>
        `;
      });
    } else {
      drinksHTML = '<p style="color: var(--muted); text-align: center;">No drinks recorded for this day.</p>';
    }
    
    container.innerHTML = `
      <div style="text-align: center; margin-bottom: 20px;">
        <h3 style="margin: 0 0 10px 0; color: var(--text);">${formattedDate}</h3>
        <div style="font-size: 48px; font-weight: 800; color: var(--accent); margin: 10px 0;">${dayData.consumed}ml</div>
        <div style="color: var(--muted);">of ${goal}ml goal</div>
        <div style="margin: 20px 0;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>Progress</span>
            <span>${Math.round(progress)}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${progress}%;"></div>
          </div>
        </div>
        ${dayData.completed ? 
          '<div style="background: rgba(77, 255, 184, 0.1); color: var(--success); padding: 8px; border-radius: 8px; margin: 15px 0; border: 1px solid var(--success);"><i class="fas fa-check-circle"></i> Daily goal achieved!</div>' : 
          ''}
      </div>
      ${drinksHTML}
    `;
  }
  
  openModal('dayDetailsModal');
}

function initializeCharts() {
  const trendCtx = document.getElementById('trendChart').getContext('2d');
  const distCtx = document.getElementById('distributionChart').getContext('2d');
  
  // Fix chart colors for better visibility
  Chart.defaults.color = 'rgba(255, 255, 255, 0.8)';
  Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.2)';
  
  trendChart = new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Water Intake (ml)',
        data: [],
        borderColor: 'var(--accent)',
        backgroundColor: 'rgba(79, 209, 255, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: 'var(--accent)',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(18, 26, 47, 0.95)',
          titleColor: 'var(--accent)',
          bodyColor: 'var(--text)',
          borderColor: 'var(--accent)',
          borderWidth: 1,
          padding: 12,
          cornerRadius: 8
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(255, 255, 255, 0.15)',
            drawBorder: false
          },
          ticks: {
            color: 'rgba(255, 255, 255, 0.8)',
            callback: function(value) {
              return value + 'ml';
            },
            padding: 8
          }
        },
        x: {
          grid: {
            color: 'rgba(255, 255, 255, 0.1)',
            drawBorder: false
          },
          ticks: {
            color: 'rgba(255, 255, 255, 0.8)',
            padding: 8
          }
        }
      }
    }
  });
  
  distributionChart = new Chart(distCtx, {
    type: 'doughnut',
    data: {
      labels: [],
      datasets: [{
        data: [],
        backgroundColor: [],
        borderWidth: 2,
        borderColor: 'var(--card)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: 'rgba(255, 255, 255, 0.8)',
            padding: 20,
            usePointStyle: true,
            pointStyle: 'circle',
            font: {
              size: 11
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(18, 26, 47, 0.95)',
          titleColor: 'var(--accent)',
          bodyColor: 'var(--text)',
          borderColor: 'var(--accent)',
          borderWidth: 1,
          padding: 12,
          cornerRadius: 8
        }
      },
      cutout: '60%'
    }
  });
  
  updateCharts();
}

function updateCharts() {
  if (!trendChart || !distributionChart) return;
  
  // Update trend chart based on current type
  let labels = [];
  let data = [];
  
  if (appState.currentChartType === 'weekly') {
    for (let i = 6; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      const dateStr = date.toDateString();
      const dayData = appState.historicalData[dateStr];
      
      labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
      data.push(dayData ? dayData.consumed : 0);
    }
  } else if (appState.currentChartType === 'monthly') {
    const daysInMonth = new Date(appState.currentYear, appState.currentMonth + 1, 0).getDate();
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(appState.currentYear, appState.currentMonth, day);
      const dateStr = date.toDateString();
      const dayData = appState.historicalData[dateStr];
      
      labels.push(day);
      data.push(dayData ? dayData.consumed : 0);
    }
  } else if (appState.currentChartType === 'yearly') {
    // Yearly view - monthly averages
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    labels = months;
    data = Array(12).fill(0);
    
    // Calculate monthly averages
    Object.entries(appState.historicalData).forEach(([dateStr, dayData]) => {
      const date = new Date(dateStr);
      const month = date.getMonth();
      data[month] = Math.max(data[month], dayData.consumed);
    });
  }
  
  trendChart.data.labels = labels;
  trendChart.data.datasets[0].data = data;
  trendChart.update();
  
  // Update distribution chart
  updateDistributionChart();
}

function updateDistributionChart() {
  if (!distributionChart) return;
  
  const drinkTypes = {};
  let drinks = [];
  
  if (appState.currentPieType === 'today') {
    drinks = appState.todayData?.drinks || [];
  } else if (appState.currentPieType === 'week') {
    const last7Days = getLastNDays(7);
    drinks = last7Days.flatMap(day => day?.drinks || []);
  } else if (appState.currentPieType === 'month') {
    const last30Days = getLastNDays(30);
    drinks = last30Days.flatMap(day => day?.drinks || []);
  }
  
  drinks.forEach(drink => {
    drinkTypes[drink.type] = (drinkTypes[drink.type] || 0) + drink.amount;
  });
  
  const labels = [];
  const data = [];
  const colors = [];
  
  Object.entries(drinkTypes).forEach(([type, amount]) => {
    labels.push(BEVERAGES[type]?.name || type);
    data.push(amount);
    colors.push(BEVERAGES[type]?.color || '#4fd1ff');
  });
  
  distributionChart.data.labels = labels;
  distributionChart.data.datasets[0].data = data;
  distributionChart.data.datasets[0].backgroundColor = colors;
  distributionChart.update();
}

function changeChartType(type) {
  appState.currentChartType = type;
  document.querySelectorAll('.chart-actions .chart-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  updateCharts();
}

function changePieType(type) {
  appState.currentPieType = type;
  document.querySelectorAll('.chart-actions .chart-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  updateDistributionChart();
}

function prevMonth() {
  appState.currentMonth--;
  if (appState.currentMonth < 0) {
    appState.currentMonth = 11;
    appState.currentYear--;
  }
  renderCalendar();
}

function nextMonth() {
  appState.currentMonth++;
  if (appState.currentMonth > 11) {
    appState.currentMonth = 0;
    appState.currentYear++;
  }
  renderCalendar();
}

// ============================================
// DRINK MANAGEMENT
// ============================================

function updateDrinkGrid() {
  const container = document.getElementById('drinkGrid');
  container.innerHTML = '';
  
  Object.entries(BEVERAGES).forEach(([key, drink]) => {
    const item = document.createElement('div');
    item.className = 'drink-item';
    item.onclick = () => selectDrink(key);
    
    item.innerHTML = `
      <i class="fas ${drink.icon} drink-icon" style="color: ${drink.color};"></i>
      <div class="drink-name">${drink.name}</div>
      <div class="drink-percentage">${drink.waterContent}% water</div>
    `;
    
    container.appendChild(item);
  });
}

function selectDrink(type) {
  appState.selectedDrink = type;
  const drink = BEVERAGES[type];
  
  document.getElementById('amountTitle').innerHTML = `
    <i class="fas ${drink.icon}" style="color: ${drink.color};"></i> ${drink.name}
  `;
  
  document.getElementById('waterContentInfo').innerHTML = `
    <div style="font-weight: 600; margin-bottom: 5px;">${drink.description}</div>
    <div style="font-size: 14px; color: var(--accent);">Contains ${drink.waterContent}% water  ${Math.round(drink.hydrationFactor * 100)}% hydration efficiency</div>
  `;
  
  const amounts = [100, 200, 250, 300, 400, 500, 750, 1000];
  const container = document.getElementById('amountGrid');
  container.innerHTML = '';
  
  amounts.forEach(amount => {
    const waterAmount = Math.round(amount * drink.waterContent / 100);
    const btn = document.createElement('button');
    btn.className = 'amount-btn';
    if (amount === appState.selectedAmount) btn.classList.add('active');
    
    btn.innerHTML = `
      <div class="amount-value">${amount === 1000 ? '1L' : `${amount}ml`}</div>
      <div class="amount-water">${waterAmount}ml water</div>
    `;
    
    btn.onclick = () => {
      document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      appState.selectedAmount = amount;
      document.getElementById('customAmount').value = '';
    };
    
    container.appendChild(btn);
  });
  
  closeModal('drinkModal');
  openModal('amountModal');
}

function confirmDrink() {
  let amount = appState.selectedAmount;
  const customAmount = parseInt(document.getElementById('customAmount').value);
  
  if (customAmount && customAmount > 0) {
    amount = customAmount;
  }
  
  if (!appState.selectedDrink || amount <= 0) {
    showNotification("Please select a valid amount", "error");
    return;
  }
  
  addDrink(appState.selectedDrink, amount);
  closeModal('amountModal');
  appState.selectedDrink = null;
  appState.selectedAmount = 250;
}

// ============================================
// NOTIFICATIONS & REMINDERS
// ============================================

function setupReminders() {
  if (!appState.settings.reminders?.enabled) return;
  
  // Request notification permission
  if ("Notification" in window && Notification.permission === "default") {
    Notification.requestPermission().then(permission => {
      if (permission === "granted") {
        console.log("Notification permission granted");
      }
    });
  }
  
  // Schedule reminders
  scheduleSystemNotifications();
}

function scheduleSystemNotifications() {
  if (!appState.settings.reminders?.enabled) return;
  
  // Clear existing intervals
  if (window.reminderInterval) {
    clearInterval(window.reminderInterval);
  }
  
  const frequencyHours = appState.settings.reminders.frequency;
  
  // Convert reminder time to minutes
  const [hours, minutes] = appState.settings.reminders.time.split(':').map(Number);
  const reminderMinutes = hours * 60 + minutes;
  
  // Calculate next reminder time
  const now = new Date();
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  const minutesUntilReminder = (reminderMinutes - currentMinutes + 24 * 60) % (24 * 60);
  
  // Schedule first reminder
  setTimeout(() => {
    sendSystemReminder();
    // Set up recurring reminders
    window.reminderInterval = setInterval(sendSystemReminder, frequencyHours * 60 * 60 * 1000);
  }, minutesUntilReminder * 60 * 1000);
}

function sendSystemReminder() {
  if (!appState.settings.reminders?.enabled) return;
  
  const progress = appState.todayData ? (appState.todayData.consumed / appState.todayData.goal) * 100 : 0;
  let message = " Time to hydrate!";
  
  if (progress < 25) {
    message = " Start your hydration journey! Drink some water.";
  } else if (progress < 50) {
    message = " Keep going! You're making good progress.";
  } else if (progress < 75) {
    message = " Halfway there! Stay hydrated.";
  } else if (progress < 100) {
    message = " Almost at your goal! One more drink.";
  } else {
    message = " Goal achieved! Maintain your hydration.";
  }
  
  // Show in-app notification
  showNotification(message, "reminder");
  
  // Show system notification if permission granted
  if ("Notification" in window && Notification.permission === "granted") {
    const notification = new Notification("Waterify Pro Reminder", {
      body: message,
      icon: "https://cdn.jsdelivr.net/npm/emoji-datasource-apple/img/apple/64/1f4a7.png",
      tag: "hydration-reminder",
      requireInteraction: false
    });
    
    // Close notification after 5 seconds
    setTimeout(() => notification.close(), 5000);
  }
  
  // Vibrate if supported
  if (navigator.vibrate) {
    navigator.vibrate([100, 50, 100]);
  }
}

function testReminder() {
  sendSystemReminder();
  showNotification("Test reminder sent!", "success");
}

// ============================================
// DATA MANAGEMENT
// ============================================

function exportData() {
  const data = {
    profile: appState.profile,
    historicalData: appState.historicalData,
    settings: appState.settings,
    exportDate: new Date().toISOString(),
    version: 4
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `waterify-data-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showNotification("Data exported successfully!", "success");
}

function importData() {
  document.getElementById('importFile').click();
}

document.getElementById('importFile').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      
      if (confirm("This will replace all your current data. Continue?")) {
        // Migrate imported data if needed
        if (data.version && data.version < 4) {
          // Add missing fields
          if (data.profile) {
            data.profile.gender = data.profile.gender || 'male';
            data.profile.activityLevel = data.profile.activityLevel || 'moderate';
            data.profile.currentStreak = data.profile.currentStreak || 0;
            data.profile.bestStreak = data.profile.bestStreak || 0;
            data.profile.unitSystem = data.profile.unitSystem || 'metric';
            data.profile.profileComplete = data.profile.profileComplete || true;
            data.profile.dailyGoal = calculateRecommendedGoalValue(
              data.profile.weight,
              data.profile.height,
              data.profile.age,
              data.profile.gender,
              data.profile.activityLevel
            );
          }
        }
        
        appState.profile = data.profile || appState.profile;
        appState.historicalData = data.historicalData || appState.historicalData;
        appState.settings = data.settings || appState.settings;
        
        saveAllData();
        updateDashboard();
        updateProfileUI();
        
        showNotification("Data imported successfully!", "success");
      }
    } catch (error) {
      showNotification("Error importing data. Invalid file format.", "error");
    }
  };
  reader.readAsText(file);
});

function resetData() {
  if (confirm("Are you sure you want to reset all data? This cannot be undone.")) {
    localStorage.clear();
    location.reload();
  }
}

// ============================================
// UI HELPER FUNCTIONS
// ============================================

function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(screen => {
    screen.style.display = 'none';
  });
  
  document.getElementById(screenId).style.display = 'block';
  
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  if (screenId === 'dashboard') {
    document.querySelector('.nav-item:nth-child(1)').classList.add('active');
  } else if (screenId === 'statsScreen') {
    document.querySelector('.nav-item:nth-child(3)').classList.add('active');
  } else if (screenId === 'profileScreen') {
    document.querySelector('.nav-item:nth-child(4)').classList.add('active');
  }
}

function openProfile() {
  showScreen('profileScreen');
}

function closeProfile() {
  showScreen('dashboard');
}

function openDrinkModal() {
  openModal('drinkModal');
}

function openModal(modalId) {
  document.getElementById(modalId).style.display = 'flex';
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

function closeStats() {
  showScreen('dashboard');
}

function showNotification(message, type = 'success') {
  const notification = document.getElementById('notification');
  const text = document.getElementById('notificationText');
  
  text.textContent = message;
  
  if (type === 'error') {
    notification.style.background = 'linear-gradient(135deg, var(--danger), #ff6b6b)';
  } else if (type === 'reminder') {
    notification.style.background = 'linear-gradient(135deg, var(--secondary), #8b5cf6)';
  } else {
    notification.style.background = 'linear-gradient(135deg, var(--accent), var(--accent2))';
  }
  
  notification.style.display = 'block';
  notification.classList.add('show');
  
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      notification.style.display = 'none';
    }, 500);
  }, 3000);
}

function showAchievements() {
  showNotification("Achievements system coming soon!", "success");
}

// ============================================
// INITIALIZE APP
// ============================================

// Load Chart.js dynamically
const script = document.createElement('script');
script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
script.onload = initializeApp;
document.head.appendChild(script);

// Initialize the rest
window.addEventListener('load', () => {
  if (typeof Chart !== 'undefined') {
    initializeApp();
  }
});

// Service Worker Registration for PWA
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
      .then(registration => {
        console.log('Service Worker registered:', registration);
      })
      .catch(error => {
        console.log('Service Worker registration failed:', error);
      });
  });
}
</script>
</body>
</html>
