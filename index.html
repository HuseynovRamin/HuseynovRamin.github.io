<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HydroTrack Pro</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#060b18">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
/* Your existing CSS remains, adding new enhancements below */

/* Enhanced animations */
@keyframes glow {
  0%, 100% { box-shadow: 0 0 20px var(--accent); }
  50% { box-shadow: 0 0 40px var(--accent); }
}

@keyframes shimmer {
  0% { background-position: -200px 0; }
  100% { background-position: 200px 0; }
}

/* Achievement badges */
.achievement-badge {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--accent), var(--secondary));
  color: #000;
  font-size: 20px;
  position: relative;
  animation: glow 2s infinite;
}

/* Weather integration */
.weather-widget {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 15px;
  padding: 15px;
  margin: 10px 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

/* Social features */
.community-card {
  background: linear-gradient(135deg, var(--card), rgba(18, 26, 47, 0.8));
  border: 1px solid var(--glass-border);
  border-radius: 15px;
  padding: 15px;
  margin: 10px 0;
}

/* Enhanced graphs */
.graph-container {
  background: var(--card);
  border-radius: 15px;
  padding: 20px;
  margin: 15px 0;
  position: relative;
}

/* Progress animations */
@keyframes progressPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.progress-pulse {
  animation: progressPulse 2s infinite;
}

/* Smart suggestions */
.smart-suggestion {
  background: linear-gradient(135deg, rgba(79, 209, 255, 0.1), rgba(107, 124, 255, 0.1));
  border-left: 4px solid var(--accent);
  padding: 15px;
  margin: 10px 0;
  border-radius: 0 10px 10px 0;
}

/* Dark mode improvements */
@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0a0e1a;
    --card: #141b2d;
  }
}

/* Haptic feedback simulation */
.haptic {
  animation: haptic 0.1s ease;
}

@keyframes haptic {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-1px); }
  75% { transform: translateX(1px); }
}

/* AR-like bottle effect */
.ar-bottle {
  filter: drop-shadow(0 0 20px rgba(79, 209, 255, 0.5));
  transition: all 0.3s ease;
}

/* New loading animation */
.loading-wave {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 50px;
}

.wave {
  width: 5px;
  height: 20px;
  background: linear-gradient(45deg, var(--accent), var(--accent2));
  margin: 0 3px;
  border-radius: 20px;
  animation: wave 1s linear infinite;
}

.wave:nth-child(2) { animation-delay: 0.1s; }
.wave:nth-child(3) { animation-delay: 0.2s; }
.wave:nth-child(4) { animation-delay: 0.3s; }
.wave:nth-child(5) { animation-delay: 0.4s; }

@keyframes wave {
  0%, 60%, 100% { transform: scaleY(0.5); }
  30% { transform: scaleY(1); }
}

/* Achievement unlock animation */
@keyframes achievementUnlock {
  0% { transform: scale(0) rotate(-180deg); }
  70% { transform: scale(1.1) rotate(10deg); }
  100% { transform: scale(1) rotate(0deg); }
}

.achievement-unlock {
  animation: achievementUnlock 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* Voice command indicator */
.voice-indicator {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--danger), var(--warning));
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 20px;
  z-index: 1000;
  animation: pulse 1.5s infinite;
}

/* Add these to your existing CSS */
</style>
</head>

<body>
<!-- Floating Particles -->
<div class="particles" id="particles"></div>

<!-- Voice Indicator -->
<div class="voice-indicator" id="voiceIndicator" style="display: none;">
  <i class="fas fa-microphone"></i>
</div>

<!-- Achievement Toast -->
<div id="achievementToast" class="notification" style="display: none; background: linear-gradient(135deg, var(--secondary), #8b5cf6);">
  <i class="fas fa-trophy"></i> <span id="achievementText">Achievement Unlocked!</span>
</div>

<div class="app">
  <!-- Main Dashboard -->
  <div id="dashboard" class="screen">
    <!-- Header with Weather Integration -->
    <div class="card" style="position: relative;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
          <h1 style="margin: 0; font-size: 28px; font-weight: 700; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">HydroTrack Pro</h1>
          <p style="margin: 5px 0 0 0; color: var(--muted); font-size: 14px;" id="currentDateTime">Loading...</p>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="weather-widget" id="weatherWidget" style="display: none;">
            <div>
              <div style="font-size: 12px; opacity: 0.8;">Hydration Boost</div>
              <div style="font-size: 14px; font-weight: 600;" id="weatherEffect">Optimal</div>
            </div>
            <i class="fas fa-sun" style="font-size: 24px;"></i>
          </div>
          <div class="btn-small" onclick="openProfile()" style="background: var(--glass); border: 1px solid var(--glass-border); color: var(--text);">
            <i class="fas fa-user"></i>
          </div>
        </div>
      </div>

      <!-- Voice Command Button -->
      <button class="btn-small" onclick="startVoiceCommand()" style="position: absolute; top: 20px; right: 20px; background: linear-gradient(135deg, var(--danger), var(--warning));">
        <i class="fas fa-microphone"></i> Voice
      </button>

      <!-- Goal Progress with Animation -->
      <div style="text-align: center; margin-bottom: 30px;">
        <div class="progress-container">
          <div class="progress-header">
            <span style="font-weight: 600; color: var(--accent);">Daily Progress</span>
            <span style="font-weight: 600;" id="progressText">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill progress-pulse" id="progressFill"></div>
          </div>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: var(--muted);" id="timeToGoal">
          Complete goal by 6 PM
        </div>
      </div>

      <!-- Enhanced Water Bottle with AR Effects -->
      <div class="bottle-container">
        <div class="bottle ar-bottle">
          <div class="water" id="waterLevel"></div>
          <div class="water-wave"></div>
        </div>
        <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); background: var(--glass); border: 1px solid var(--glass-border); border-radius: 20px; padding: 5px 15px; font-size: 12px;">
          <i class="fas fa-water" style="color: var(--accent);"></i> <span id="currentHydrationLevel">Hydrated</span>
        </div>
      </div>

      <!-- Enhanced Stats Display -->
      <div style="text-align: center; margin: 30px 0;">
        <div id="consumedDisplay" style="font-size: 48px; font-weight: 800; color: var(--accent); margin-bottom: 10px; text-shadow: 0 0 20px rgba(79, 209, 255, 0.5);">0 ml</div>
        <div id="goalDisplay" style="color: var(--muted); font-size: 16px;">of 0 ml goal</div>
        
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px;">
          <div style="text-align: center;">
            <div class="achievement-badge" style="margin: 0 auto 5px;">
              <i class="fas fa-glass-water"></i>
            </div>
            <div style="font-size: 14px; font-weight: 600;" id="drinksCount">0</div>
            <div style="font-size: 10px; color: var(--muted);">Drinks</div>
          </div>
          <div style="text-align: center;">
            <div class="achievement-badge" style="margin: 0 auto 5px; background: linear-gradient(135deg, var(--warning), #ff6b6b);">
              <i class="fas fa-fire"></i>
            </div>
            <div style="font-size: 14px; font-weight: 600;" id="streakCount">0</div>
            <div style="font-size: 10px; color: var(--muted);">Day Streak</div>
          </div>
          <div style="text-align: center;">
            <div class="achievement-badge" style="margin: 0 auto 5px; background: linear-gradient(135deg, var(--success), #4dff88);">
              <i class="fas fa-chart-line"></i>
            </div>
            <div style="font-size: 14px; font-weight: 600;" id="avgHydration">0%</div>
            <div style="font-size: 10px; color: var(--muted);">Avg. Hydration</div>
          </div>
          <div style="text-align: center;">
            <div class="achievement-badge" style="margin: 0 auto 5px; background: linear-gradient(135deg, var(--secondary), #8b5cf6);">
              <i class="fas fa-medal"></i>
            </div>
            <div style="font-size: 14px; font-weight: 600;" id="achievementCount">0</div>
            <div style="font-size: 10px; color: var(--muted);">Achievements</div>
          </div>
        </div>
      </div>

      <!-- Smart Suggestions -->
      <div class="smart-suggestion" id="smartSuggestion">
        <div style="display: flex; align-items: center; gap: 10px;">
          <i class="fas fa-lightbulb" style="color: var(--warning);"></i>
          <div>
            <div style="font-weight: 600; font-size: 14px;">Smart Tip</div>
            <div style="font-size: 12px; color: var(--muted);" id="suggestionText">Drink water before meals for better digestion</div>
          </div>
        </div>
      </div>

      <!-- Quick Actions with Haptic Feedback -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
        <button class="btn haptic" onclick="openDrinkModal()" id="addDrinkBtn">
          <i class="fas fa-plus"></i> Add Drink
        </button>
        <button class="btn-secondary haptic" onclick="openStats()">
          <i class="fas fa-chart-line"></i> Stats
        </button>
      </div>

      <!-- Recent Activity with AI Insights -->
      <div style="margin-top: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3 style="margin: 0; font-size: 18px; font-weight: 600;"><i class="fas fa-history" style="color: var(--accent); margin-right: 10px;"></i>Recent Activity</h3>
          <button class="btn-small" onclick="analyzePatterns()" style="font-size: 10px;">
            <i class="fas fa-robot"></i> AI Analysis
          </button>
        </div>
        <div id="recentActivity" style="max-height: 200px; overflow-y: auto; padding-right: 10px;"></div>
      </div>
    </div>

    <!-- Quick Stats with Predictions -->
    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-chart-bar" style="color: var(--accent); margin-right: 10px;"></i>Smart Insights</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="hydrationScore">85</div>
          <div class="stat-label">Hydration Score</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="prediction">92%</div>
          <div class="stat-label">Goal Prediction</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="efficiency">78%</div>
          <div class="stat-label">Drink Efficiency</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="healthImpact">+12%</div>
          <div class="stat-label">Health Impact</div>
        </div>
      </div>
    </div>

    <!-- Community Section -->
    <div class="community-card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-users" style="color: var(--accent); margin-right: 10px;"></i>Community Challenge</h3>
      <div style="margin-bottom: 15px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span style="font-size: 12px; color: var(--muted);">Global Hydration Goal</span>
          <span style="font-size: 12px; color: var(--accent); font-weight: 600;">78%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: 78%; background: linear-gradient(90deg, var(--secondary), var(--accent2));"></div>
        </div>
      </div>
      <button class="btn-small" onclick="joinChallenge()" style="width: 100%;">
        <i class="fas fa-trophy"></i> Join Challenge
      </button>
    </div>
  </div>

  <!-- Enhanced Statistics Screen -->
  <div id="statsScreen" class="screen" style="display: none;">
    <div class="card">
      <div class="modal-header">
        <h3><i class="fas fa-chart-network"></i> Advanced Analytics</h3>
        <button class="close-btn" onclick="closeStats()"><i class="fas fa-times"></i></button>
      </div>

      <!-- Time Period Selector -->
      <div style="display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto;">
        <button class="chart-btn active" onclick="changeTimePeriod('week')">Week</button>
        <button class="chart-btn" onclick="changeTimePeriod('month')">Month</button>
        <button class="chart-btn" onclick="changeTimePeriod('quarter')">Quarter</button>
        <button class="chart-btn" onclick="changeTimePeriod('year')">Year</button>
        <button class="chart-btn" onclick="changeTimePeriod('all')">All Time</button>
      </div>

      <!-- Main Chart -->
      <div class="graph-container">
        <canvas id="mainChart" style="width: 100%; height: 250px;"></canvas>
      </div>

      <!-- Comparative Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="trend">‚Üë12%</div>
          <div class="stat-label">vs Last Week</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="consistency">94%</div>
          <div class="stat-label">Consistency</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="peakHour">10 AM</div>
          <div class="stat-label">Peak Hour</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="avgInterval">2.3h</div>
          <div class="stat-label">Avg Interval</div>
        </div>
      </div>

      <!-- AI Insights -->
      <div class="smart-suggestion" style="margin-top: 20px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <i class="fas fa-robot" style="color: var(--secondary);"></i>
          <div>
            <div style="font-weight: 600; font-size: 14px;">AI Insight</div>
            <div style="font-size: 12px; color: var(--muted);" id="aiInsight">You drink most consistently between 9-11 AM</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Calendar -->
    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-calendar-star" style="color: var(--accent); margin-right: 10px;"></i>Hydration Calendar</h3>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <button class="btn-small" onclick="prevMonth()"><i class="fas fa-chevron-left"></i></button>
        <span id="currentMonth" style="font-weight: 600; color: var(--accent);">January 2024</span>
        <button class="btn-small" onclick="nextMonth()"><i class="fas fa-chevron-right"></i></button>
      </div>
      <div id="calendarContainer" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 15px;">
        <!-- Calendar will be generated here -->
      </div>
      <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--muted);">
        <div><div style="width: 10px; height: 10px; background: var(--accent); border-radius: 2px; display: inline-block; margin-right: 5px;"></div> Goal Met</div>
        <div><div style="width: 10px; height: 10px; background: var(--warning); border-radius: 2px; display: inline-block; margin-right: 5px;"></div> Partial</div>
        <div><div style="width: 10px; height: 10px; background: var(--glass-border); border-radius: 2px; display: inline-block; margin-right: 5px;"></div> No Data</div>
      </div>
    </div>

    <!-- Achievement Gallery -->
    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-trophy" style="color: var(--warning); margin-right: 10px;"></i>Achievement Gallery</h3>
      <div id="achievementGallery" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
        <!-- Achievements will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Enhanced Profile Screen -->
  <div id="profileScreen" class="screen" style="display: none;">
    <div class="card">
      <div class="modal-header">
        <h3><i class="fas fa-user-astronaut"></i> Advanced Profile</h3>
        <button class="close-btn" onclick="closeProfile()"><i class="fas fa-times"></i></button>
      </div>

      <!-- Personal Info -->
      <div class="input-group">
        <label class="input-label"><i class="fas fa-user-circle"></i> Your Name</label>
        <input type="text" class="manual-input" id="userNameInput" placeholder="Enter your name">
      </div>

      <!-- Enhanced Biometrics -->
      <div class="ruler-section">
        <label class="input-label"><i class="fas fa-weight"></i> Weight (kg)</label>
        <div class="ruler-value-display" id="weightValue">70</div>
        <div class="input-with-controls">
          <input type="range" min="30" max="200" value="70" class="manual-input" id="weightSlider" style="flex: 3;">
          <input type="number" class="manual-input" id="weightInput" min="30" max="200" step="0.1" value="70" style="flex: 1;">
        </div>
      </div>

      <div class="ruler-section">
        <label class="input-label"><i class="fas fa-ruler-vertical"></i> Height (cm)</label>
        <div class="ruler-value-display" id="heightValue">170</div>
        <div class="input-with-controls">
          <input type="range" min="100" max="250" value="170" class="manual-input" id="heightSlider" style="flex: 3;">
          <input type="number" class="manual-input" id="heightInput" min="100" max="250" step="0.1" value="170" style="flex: 1;">
        </div>
      </div>

      <!-- Activity Level -->
      <div class="input-group">
        <label class="input-label"><i class="fas fa-running"></i> Activity Level</label>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn-small" onclick="setActivityLevel('sedentary')" id="activitySedentary">Sedentary</button>
          <button class="btn-small" onclick="setActivityLevel('light')" id="activityLight">Light</button>
          <button class="btn-small active" onclick="setActivityLevel('moderate')" id="activityModerate">Moderate</button>
          <button class="btn-small" onclick="setActivityLevel('active')" id="activityActive">Active</button>
          <button class="btn-small" onclick="setActivityLevel('athlete')" id="activityAthlete">Athlete</button>
        </div>
      </div>

      <!-- Smart Goal Calculator -->
      <div class="input-group">
        <label class="input-label"><i class="fas fa-calculator"></i> Daily Goal Calculator</label>
        <div style="background: var(--glass); border-radius: 12px; padding: 15px; margin-top: 10px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span style="color: var(--muted);">Recommended:</span>
            <span style="font-weight: 600; color: var(--accent);" id="recommendedGoal">2500 ml</span>
          </div>
          <input type="range" min="1000" max="5000" step="50" value="2000" class="manual-input" id="goalSlider" style="width: 100%;">
          <div style="display: flex; justify-content: space-between; margin-top: 10px;">
            <span style="font-size: 12px; color: var(--muted);">1000 ml</span>
            <input type="number" class="manual-input" id="dailyGoalInput" min="1000" max="5000" step="50" value="2000" style="width: 100px;">
            <span style="font-size: 12px; color: var(--muted);">5000 ml</span>
          </div>
        </div>
      </div>

      <!-- Health Integration -->
      <div class="input-group">
        <label class="input-label"><i class="fas fa-heartbeat"></i> Health Integration</label>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <button class="btn-small" onclick="connectHealthApp('apple')">
            <i class="fab fa-apple"></i> Apple Health
          </button>
          <button class="btn-small" onclick="connectHealthApp('google')">
            <i class="fab fa-google"></i> Google Fit
          </button>
          <button class="btn-small" onclick="connectHealthApp('samsung')">
            <i class="fas fa-mobile-alt"></i> Samsung Health
          </button>
        </div>
      </div>

      <button class="btn" onclick="saveProfile()" style="margin-top: 30px;">
        <i class="fas fa-save"></i> Save & Update
      </button>
    </div>

    <!-- Enhanced Reminders -->
    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-bell" style="color: var(--accent); margin-right: 10px;"></i>Smart Reminders</h3>
      
      <div class="input-group">
        <label class="input-label">Enable Smart Reminders</label>
        <label class="switch">
          <input type="checkbox" id="smartReminders" checked>
          <span class="slider"></span>
        </label>
      </div>

      <div class="input-group">
        <label class="input-label">Reminder Schedule</label>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px;">
          <button class="btn-small" onclick="toggleReminderTime('morning')" id="reminderMorning">üåÖ Morning</button>
          <button class="btn-small" onclick="toggleReminderTime('afternoon')" id="reminderAfternoon">‚òÄÔ∏è Afternoon</button>
          <button class="btn-small" onclick="toggleReminderTime('evening')" id="reminderEvening">üåÜ Evening</button>
          <button class="btn-small" onclick="toggleReminderTime('custom')" id="reminderCustom">‚öôÔ∏è Custom</button>
        </div>
      </div>

      <div class="input-group" id="customTimes" style="display: none;">
        <label class="input-label">Custom Times</label>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <input type="time" class="manual-input" id="customTime1" value="09:00">
          <input type="time" class="manual-input" id="customTime2" value="14:00">
          <input type="time" class="manual-input" id="customTime3" value="19:00">
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Reminder Type</label>
        <select class="manual-input" id="reminderType">
          <option value="notification">Notification Only</option>
          <option value="sound">Sound Alert</option>
          <option value="vibration">Vibration</option>
          <option value="all">All (Notification + Sound)</option>
        </select>
      </div>

      <button class="btn-secondary" onclick="testReminder()" style="margin-top: 10px;">
        <i class="fas fa-bell"></i> Test Smart Reminder
      </button>
    </div>

    <!-- Data & Backup -->
    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-database" style="color: var(--accent); margin-right: 10px;"></i>Data Management</h3>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
        <button class="btn-small" onclick="exportData()">
          <i class="fas fa-file-export"></i> Export
        </button>
        <button class="btn-small btn-secondary" onclick="importData()">
          <i class="fas fa-file-import"></i> Import
        </button>
        <button class="btn-small" onclick="backupToCloud()">
          <i class="fas fa-cloud-upload-alt"></i> Cloud Backup
        </button>
        <button class="btn-small" onclick="syncData()">
          <i class="fas fa-sync"></i> Sync Now
        </button>
      </div>

      <div class="input-group">
        <label class="input-label">Auto Backup</label>
        <select class="manual-input" id="autoBackup">
          <option value="daily">Daily</option>
          <option value="weekly" selected>Weekly</option>
          <option value="monthly">Monthly</option>
          <option value="never">Never</option>
        </select>
      </div>

      <button class="btn-small" onclick="resetData()" style="background: var(--danger); margin-top: 10px; width: 100%;">
        <i class="fas fa-trash"></i> Reset All Data
      </button>
    </div>
  </div>
</div>

<!-- Navigation -->
<div class="nav">
  <div class="nav-item active" onclick="showScreen('dashboard')">
    <i class="fas fa-home"></i>
    <span>Home</span>
  </div>
  <div class="nav-item" onclick="openDrinkModal()">
    <i class="fas fa-plus-circle"></i>
    <span>Add</span>
  </div>
  <div class="nav-item" onclick="showScreen('statsScreen')">
    <i class="fas fa-chart-network"></i>
    <span>Analytics</span>
  </div>
  <div class="nav-item" onclick="showScreen('profileScreen')">
    <i class="fas fa-user-cog"></i>
    <span>Profile</span>
  </div>
</div>

<!-- Enhanced Drink Selection Modal -->
<div class="modal" id="drinkModal">
  <div class="modal-content card">
    <div class="modal-header">
      <h3><i class="fas fa-wine-bottle"></i> Add Drink</h3>
      <button class="close-btn" onclick="closeModal('drinkModal')"><i class="fas fa-times"></i></button>
    </div>

    <!-- Drink Categories -->
    <div style="display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto;">
      <button class="btn-small active" onclick="filterDrinks('all')">All</button>
      <button class="btn-small" onclick="filterDrinks('hydration')">Hydration</button>
      <button class="btn-small" onclick="filterDrinks('hot')">Hot Drinks</button>
      <button class="btn-small" onclick="filterDrinks('juice')">Juices</button>
      <button class="btn-small" onclick="filterDrinks('other')">Other</button>
    </div>

    <div class="drink-grid" id="drinkGrid">
      <!-- Drink items will be added here -->
    </div>

    <div style="margin-top: 20px; text-align: center;">
      <button class="btn-small" onclick="openCustomDrink()">
        <i class="fas fa-plus"></i> Custom Drink
      </button>
    </div>

    <button class="btn-secondary" onclick="closeModal('drinkModal')" style="margin-top: 20px;">
      Cancel
    </button>
  </div>
</div>

<!-- Enhanced Amount Selection Modal -->
<div class="modal" id="amountModal">
  <div class="modal-content card">
    <div class="modal-header">
      <h3 id="amountTitle"><i class="fas fa-tint"></i> Select Amount</h3>
      <button class="close-btn" onclick="closeModal('amountModal')"><i class="fas fa-times"></i></button>
    </div>

    <div id="waterContentInfo" style="text-align: center; margin: 15px 0; padding: 15px; background: var(--glass); border-radius: 12px; border: 1px solid var(--glass-border);">
      <!-- Water content info will be added here -->
    </div>

    <!-- Quick Amount Selector -->
    <div style="display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto;">
      <button class="btn-small" onclick="setQuickAmount(100)">100ml</button>
      <button class="btn-small" onclick="setQuickAmount(250)">250ml</button>
      <button class="btn-small" onclick="setQuickAmount(500)">500ml</button>
      <button class="btn-small" onclick="setQuickAmount(750)">750ml</button>
      <button class="btn-small" onclick="setQuickAmount(1000)">1L</button>
    </div>

    <div class="amount-grid" id="amountGrid">
      <!-- Amount buttons will be added here -->
    </div>

    <!-- Smart Amount Suggestion -->
    <div id="smartAmountSuggestion" style="margin: 15px 0; padding: 10px; background: linear-gradient(135deg, rgba(79, 209, 255, 0.1), rgba(107, 124, 255, 0.1)); border-radius: 10px; display: none;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <i class="fas fa-brain" style="color: var(--secondary);"></i>
        <div>
          <div style="font-weight: 600; font-size: 12px;">AI Suggestion</div>
          <div style="font-size: 11px; color: var(--muted);">Based on your pattern, we recommend <span id="suggestedAmount" style="color: var(--accent); font-weight: 600;">250ml</span></div>
        </div>
        <button class="btn-small" onclick="useSuggestedAmount()" style="margin-left: auto;">Use</button>
      </div>
    </div>

    <div style="margin-top: 20px;">
      <input type="number" class="custom-amount" id="customAmount" placeholder="Enter custom amount (ml)" min="1" max="5000">
    </div>

    <button class="btn" onclick="confirmDrink()" style="margin-top: 20px;">
      <i class="fas fa-check"></i> Add Drink
    </button>

    <button class="btn-secondary" onclick="closeModal('amountModal')" style="margin-top: 10px;">
      Cancel
    </button>
  </div>
</div>

<!-- Custom Drink Modal -->
<div class="modal" id="customDrinkModal">
  <div class="modal-content card">
    <div class="modal-header">
      <h3><i class="fas fa-plus-circle"></i> Custom Drink</h3>
      <button class="close-btn" onclick="closeModal('customDrinkModal')"><i class="fas fa-times"></i></button>
    </div>

    <div class="input-group">
      <label class="input-label">Drink Name</label>
      <input type="text" class="manual-input" id="customDrinkName" placeholder="e.g., Coconut Water">
    </div>

    <div class="input-group">
      <label class="input-label">Water Content (%)</label>
      <input type="range" min="0" max="100" value="100" class="manual-input" id="waterContentSlider">
      <div style="text-align: center; margin-top: 5px;">
        <span id="waterContentValue" style="font-weight: 600; color: var(--accent);">100%</span>
      </div>
    </div>

    <div class="input-group">
      <label class="input-label">Select Icon</label>
      <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
        <button class="btn-small" onclick="selectDrinkIcon('fa-tint')"><i class="fas fa-tint"></i></button>
        <button class="btn-small" onclick="selectDrinkIcon('fa-glass-water')"><i class="fas fa-glass-water"></i></button>
        <button class="btn-small" onclick="selectDrinkIcon('fa-mug-hot')"><i class="fas fa-mug-hot"></i></button>
        <button class="btn-small" onclick="selectDrinkIcon('fa-wine-bottle')"><i class="fas fa-wine-bottle"></i></button>
      </div>
    </div>

    <button class="btn" onclick="saveCustomDrink()" style="margin-top: 20px;">
      <i class="fas fa-save"></i> Save Custom Drink
    </button>
  </div>
</div>

<!-- Notification -->
<div id="notification" class="notification">
  <i class="fas fa-check-circle"></i> <span id="notificationText">Drink added successfully!</span>
</div>

<!-- Import Data Input -->
<input type="file" id="importFile" accept=".json" style="display: none;">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
// ============================================
// PROFESSIONAL HYDRATION TRACKER - ENHANCED
// ============================================

// App Version for update management
const APP_VERSION = '2.5.0';
const MINIMUM_COMPATIBLE_VERSION = '2.0.0';

// Enhanced beverage database
const BEVERAGES = {
  water: { name: "Water", icon: "fa-tint", color: "#4fd1ff", waterContent: 100, hydrationFactor: 1.0, category: "hydration" },
  sparkling_water: { name: "Sparkling Water", icon: "fa-glass-water", color: "#6b7cff", waterContent: 100, hydrationFactor: 1.0, category: "hydration" },
  herbal_tea: { name: "Herbal Tea", icon: "fa-mug-hot", color: "#ffb84d", waterContent: 99, hydrationFactor: 0.95, category: "hot" },
  green_tea: { name: "Green Tea", icon: "fa-leaf", color: "#4dff88", waterContent: 99, hydrationFactor: 0.9, category: "hot" },
  black_coffee: { name: "Black Coffee", icon: "fa-coffee", color: "#8B4513", waterContent: 98, hydrationFactor: 0.85, category: "hot" },
  milk: { name: "Milk", icon: "fa-cow", color: "#ffffff", waterContent: 87, hydrationFactor: 0.95, category: "dairy" },
  fruit_juice: { name: "Fruit Juice", icon: "fa-apple-alt", color: "#ff6b6b", waterContent: 88, hydrationFactor: 0.8, category: "juice" },
  sports_drink: { name: "Sports Drink", icon: "fa-bolt", color: "#ff4d6d", waterContent: 94, hydrationFactor: 0.9, category: "sports" },
  soda: { name: "Soda", icon: "fa-glass-whiskey", color: "#ff4757", waterContent: 90, hydrationFactor: 0.7, category: "soda" },
  smoothie: { name: "Smoothie", icon: "fa-blender", color: "#9d4edd", waterContent: 85, hydrationFactor: 0.85, category: "smoothie" },
  coconut_water: { name: "Coconut Water", icon: "fa-coconut", color: "#FFE5B4", waterContent: 95, hydrationFactor: 0.95, category: "hydration" },
  electrolyte_water: { name: "Electrolyte Water", icon: "fa-battery-full", color: "#00FF7F", waterContent: 99, hydrationFactor: 1.1, category: "sports" }
};

// Enhanced achievements
const ACHIEVEMENTS = [
  { id: 'first_drink', name: 'First Sip', icon: 'fa-tint', description: 'Log your first drink', points: 10 },
  { id: 'daily_goal', name: 'Daily Goal', icon: 'fa-bullseye', description: 'Reach daily goal', points: 50 },
  { id: 'streak_3', name: '3-Day Streak', icon: 'fa-fire', description: '3 consecutive days', points: 30 },
  { id: 'streak_7', name: 'Weekly Warrior', icon: 'fa-trophy', description: '7 consecutive days', points: 70 },
  { id: 'streak_30', name: 'Monthly Master', icon: 'fa-crown', description: '30 consecutive days', points: 300 },
  { id: 'water_only', name: 'Pure Hydration', icon: 'fa-filter', description: 'Only water for a day', points: 40 },
  { id: 'early_bird', name: 'Early Bird', icon: 'fa-sun', description: 'Drink before 8 AM', points: 25 },
  { id: 'overachiever', name: 'Overachiever', icon: 'fa-rocket', description: '150% of daily goal', points: 75 },
  { id: 'variety', name: 'Variety Seeker', icon: 'fa-star', description: 'Try 5 different drinks', points: 35 },
  { id: 'hydration_expert', name: 'Hydration Expert', icon: 'fa-graduation-cap', description: '7 days perfect hydration', points: 100 },
  { id: 'night_owl', name: 'Night Owl', icon: 'fa-moon', description: 'Log drink after 10 PM', points: 20 },
  { id: 'consistency', name: 'Consistency King', icon: 'fa-chart-line', description: '14 days streak', points: 150 }
];

// State management
let appState = {
  version: APP_VERSION,
  profile: null,
  todayData: null,
  historicalData: {},
  settings: {},
  achievements: [],
  customDrinks: [],
  aiInsights: {},
  communityStats: {},
  voiceCommands: {}
};

// Charts
let mainChart = null;

// ============================================
// ENHANCED INITIALIZATION
// ============================================

async function initializeApp() {
  console.log(`HydroTrack Pro v${APP_VERSION} starting...`);
  
  // Check for updates
  await checkForUpdates();
  
  // Load all data
  loadAllData();
  
  // Initialize defaults
  initializeDefaults();
  
  // Setup features
  setupDateTime();
  setupWeatherIntegration();
  setupVoiceCommands();
  initializeCharts();
  
  // Update UI
  updateDashboard();
  updateProfileUI();
  setupSmartReminders();
  
  // Start background tasks
  startBackgroundTasks();
  
  // Request notification permission
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
  
  // Initialize service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(reg => console.log('Service Worker registered:', reg))
      .catch(err => console.log('Service Worker registration failed:', err));
  }
}

function checkForUpdates() {
  const lastVersion = localStorage.getItem('hydrotrack_version');
  
  if (!lastVersion || lastVersion < MINIMUM_COMPATIBLE_VERSION) {
    console.log('Performing data migration...');
    migrateData(lastVersion);
  }
  
  localStorage.setItem('hydrotrack_version', APP_VERSION);
}

function migrateData(oldVersion) {
  // Migrate old data format
  try {
    const oldProfile = JSON.parse(localStorage.getItem('hydrotrack_profile'));
    const oldToday = JSON.parse(localStorage.getItem('hydrotrack_today'));
    const oldHistory = JSON.parse(localStorage.getItem('hydrotrack_history'));
    
    if (oldProfile) {
      // Add new fields to old profile
      oldProfile.activityLevel = oldProfile.activityLevel || 'moderate';
      oldProfile.gender = oldProfile.gender || 'male';
      oldProfile.hydrationScore = oldProfile.hydrationScore || 85;
      appState.profile = oldProfile;
    }
    
    if (oldToday) {
      appState.todayData = oldToday;
    }
    
    if (oldHistory) {
      appState.historicalData = oldHistory;
    }
    
    saveAllData();
    console.log('Data migration completed successfully');
  } catch (error) {
    console.error('Migration failed, using defaults:', error);
    initializeDefaults();
  }
}

function initializeDefaults() {
  if (!appState.profile) {
    appState.profile = {
      name: "Hydration Hero",
      weight: 70,
      height: 170,
      age: 25,
      gender: "male",
      activityLevel: "moderate",
      dailyGoal: calculateEnhancedDailyGoal(70, 170, 25, "male", "moderate"),
      hydrationScore: 85,
      createdAt: new Date().toISOString(),
      totalPoints: 0
    };
  }
  
  const today = new Date().toDateString();
  if (!appState.todayData || appState.todayData.date !== today) {
    checkAndUpdateStreak();
    appState.todayData = {
      date: today,
      consumed: 0,
      drinks: [],
      goal: appState.profile.dailyGoal,
      completed: false,
      aiSuggestions: [],
      peakHours: []
    };
  }
  
  if (!appState.settings.reminders) {
    appState.settings = {
      reminders: {
        enabled: true,
        smart: true,
        times: ['morning', 'afternoon', 'evening'],
        type: 'notification'
      },
      notifications: true,
      darkMode: true,
      autoGoal: true,
      voiceCommands: true,
      weatherIntegration: true,
      communityFeatures: true
    };
  }
  
  if (appState.achievements.length === 0) {
    appState.achievements = ACHIEVEMENTS.map(ach => ({ 
      ...ach, 
      earned: false, 
      earnedDate: null,
      progress: 0 
    }));
  }
  
  if (!appState.aiInsights) {
    appState.aiInsights = {
      drinkingPatterns: {},
      optimalTimes: [],
      efficiencyScore: 78,
      recommendations: []
    };
  }
}

// ============================================
// ENHANCED DAILY GOAL CALCULATION
// ============================================

function calculateEnhancedDailyGoal(weight, height, age, gender, activityLevel) {
  // Scientific formula based on body surface area (Mosteller formula)
  const bsa = Math.sqrt((weight * height) / 3600); // Body Surface Area in m¬≤
  
  // Base requirement per m¬≤ of BSA (approximately 1500 ml/m¬≤/day)
  let baseRequirement = bsa * 1500;
  
  // Adjust for gender (men generally have higher water needs)
  if (gender === 'male') {
    baseRequirement *= 1.08;
  } else {
    baseRequirement *= 0.92;
  }
  
  // Adjust for age
  if (age < 18) {
    baseRequirement *= 0.9;
  } else if (age > 50) {
    baseRequirement *= 0.95;
  } else if (age > 65) {
    baseRequirement *= 0.9;
  }
  
  // Adjust for activity level
  const activityMultipliers = {
    sedentary: 1.0,
    light: 1.1,
    moderate: 1.25,
    active: 1.4,
    athlete: 1.6
  };
  
  baseRequirement *= activityMultipliers[activityLevel] || 1.25;
  
  // Round to nearest 50ml
  const finalGoal = Math.max(1500, Math.round(baseRequirement / 50) * 50);
  
  // Store for reference
  appState.profile.calculatedGoal = finalGoal;
  appState.profile.calculationMethod = 'enhanced';
  
  return finalGoal;
}

// ============================================
// ENHANCED DASHBOARD FUNCTIONS
// ============================================

function updateDashboard() {
  const consumed = appState.todayData.consumed;
  const goal = appState.todayData.goal;
  const progress = Math.min(Math.round((consumed / goal) * 100), 100);
  
  // Update progress
  document.getElementById('progressFill').style.width = `${progress}%`;
  document.getElementById('progressText').textContent = `${progress}%`;
  document.getElementById('waterLevel').style.height = `${progress}%`;
  
  // Update displays
  document.getElementById('consumedDisplay').textContent = `${consumed.toLocaleString()} ml`;
  document.getElementById('goalDisplay').textContent = `of ${goal.toLocaleString()} ml goal`;
  document.getElementById('drinksCount').textContent = appState.todayData.drinks.length;
  document.getElementById('streakCount').textContent = appState.profile.currentStreak || 0;
  document.getElementById('achievementCount').textContent = appState.achievements.filter(a => a.earned).length;
  
  // Calculate enhanced stats
  updateEnhancedStats();
  
  // Update recent activity
  updateRecentActivity();
  
  // Update smart suggestions
  updateSmartSuggestions();
  
  // Update hydration level indicator
  updateHydrationLevel(progress);
  
  // Update time to goal prediction
  updateTimeToGoal();
  
  // Save data
  saveAllData();
}

function updateEnhancedStats() {
  const todayDrinks = appState.todayData.drinks;
  const history = Object.values(appState.historicalData);
  
  // Hydration Score (0-100)
  const completionRate = history.length > 0 ? 
    (history.filter(d => d.completed).length / history.length) * 100 : 0;
  const streakBonus = (appState.profile.currentStreak || 0) * 2;
  const varietyBonus = Math.min(new Set(todayDrinks.map(d => d.type)).size * 5, 20);
  const hydrationScore = Math.min(100, Math.round(completionRate + streakBonus + varietyBonus));
  
  // Goal Prediction
  const hour = new Date().getHours();
  const remainingHours = 24 - hour;
  const avgHourly = todayDrinks.length > 0 ? 
    todayDrinks.reduce((sum, d) => sum + d.amount, 0) / hour : 0;
  const predicted = Math.min(100, Math.round((consumed + (avgHourly * remainingHours)) / goal * 100));
  
  // Drink Efficiency
  const totalWater = todayDrinks.reduce((sum, d) => sum + d.waterContent, 0);
  const efficiency = todayDrinks.length > 0 ? 
    Math.round((totalWater / todayDrinks.reduce((sum, d) => sum + d.amount, 0)) * 100) : 100;
  
  // Health Impact (estimated benefits)
  const baseImprovement = 5 + (completionRate / 20);
  const healthImpact = `+${Math.round(baseImprovement + (streakBonus / 10))}%`;
  
  // Update UI
  document.getElementById('hydrationScore').textContent = hydrationScore;
  document.getElementById('prediction').textContent = `${predicted}%`;
  document.getElementById('efficiency').textContent = `${efficiency}%`;
  document.getElementById('healthImpact').textContent = healthImpact;
  document.getElementById('avgHydration').textContent = `${Math.round(completionRate)}%`;
  
  // Update profile
  appState.profile.hydrationScore = hydrationScore;
}

function updateHydrationLevel(progress) {
  let level, color;
  
  if (progress < 25) {
    level = "Dehydrated";
    color = "#ff4d6d";
  } else if (progress < 50) {
    level = "Mild Hydration";
    color = "#ffb84d";
  } else if (progress < 75) {
    level = "Moderate Hydration";
    color = "#4fd1ff";
  } else if (progress < 100) {
    level = "Well Hydrated";
    color = "#4dff88";
  } else {
    level = "Optimal Hydration";
    color = "#8b5cf6";
  }
  
  document.getElementById('currentHydrationLevel').textContent = level;
  document.getElementById('currentHydrationLevel').style.color = color;
}

function updateTimeToGoal() {
  const consumed = appState.todayData.consumed;
  const goal = appState.todayData.goal;
  const remaining = goal - consumed;
  
  if (remaining <= 0) {
    document.getElementById('timeToGoal').textContent = "üéâ Goal achieved!";
    return;
  }
  
  const hour = new Date().getHours();
  const avgDrinkSize = appState.todayData.drinks.length > 0 ? 
    appState.todayData.drinks.reduce((sum, d) => sum + d.amount, 0) / appState.todayData.drinks.length : 250;
  
  const drinksNeeded = Math.ceil(remaining / avgDrinkSize);
  const hoursRemaining = 24 - hour;
  const drinksPerHour = drinksNeeded / hoursRemaining;
  
  if (drinksPerHour <= 0.5) {
    document.getElementById('timeToGoal').textContent = `Complete goal by ${hour + Math.ceil(drinksNeeded / 0.5)}:00`;
  } else if (drinksPerHour <= 1) {
    document.getElementById('timeToGoal').textContent = `Complete goal by ${hour + drinksNeeded}:00`;
  } else {
    document.getElementById('timeToGoal').textContent = `Drink ${drinksNeeded} more times today`;
  }
}

// ============================================
// ENHANCED DRINK MANAGEMENT
// ============================================

function addDrink(type, amount) {
  const drink = BEVERAGES[type] || appState.customDrinks.find(d => d.id === type);
  if (!drink) return;
  
  const waterContent = Math.round(amount * (drink.waterContent || 100) / 100);
  const effectiveHydration = Math.round(waterContent * (drink.hydrationFactor || 1.0));
  
  const drinkRecord = {
    type,
    name: drink.name,
    amount,
    waterContent,
    effectiveHydration,
    timestamp: new Date().toISOString(),
    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
    hour: new Date().getHours()
  };
  
  appState.todayData.consumed += effectiveHydration;
  appState.todayData.drinks.push(drinkRecord);
  
  // Update peak hours
  const hour = new Date().getHours();
  appState.todayData.peakHours.push(hour);
  
  // Check goal completion
  if (!appState.todayData.completed && appState.todayData.consumed >= appState.todayData.goal) {
    appState.todayData.completed = true;
    unlockAchievement('daily_goal');
    showNotification("üéâ Daily goal achieved! Great work!", "success");
    
    // Haptic feedback simulation
    document.body.classList.add('haptic');
    setTimeout(() => document.body.classList.remove('haptic'), 100);
  }
  
  // Check other achievements
  checkAchievements();
  
  // Update AI insights
  updateAIInsights();
  
  // Save and update
  saveAllData();
  updateDashboard();
  
  // Show notification with animation
  showNotification(`Added ${amount}ml of ${drink.name}`, "success");
  
  // Community update
  updateCommunityStats();
}

// ============================================
// VOICE COMMANDS
// ============================================

function setupVoiceCommands() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    console.log('Speech recognition not supported');
    return;
  }
  
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  appState.voiceCommands.recognition = new SpeechRecognition();
  appState.voiceCommands.recognition.continuous = false;
  appState.voiceCommands.recognition.interimResults = false;
  appState.voiceCommands.recognition.lang = 'en-US';
  
  appState.voiceCommands.recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript.toLowerCase();
    processVoiceCommand(transcript);
  };
  
  appState.voiceCommands.recognition.onerror = (event) => {
    console.log('Voice recognition error:', event.error);
    hideVoiceIndicator();
  };
  
  appState.voiceCommands.recognition.onend = () => {
    hideVoiceIndicator();
  };
}

function startVoiceCommand() {
  if (!appState.settings.voiceCommands) {
    showNotification("Enable voice commands in settings", "error");
    return;
  }
  
  showVoiceIndicator();
  try {
    appState.voiceCommands.recognition.start();
  } catch (error) {
    console.log('Voice recognition failed:', error);
    hideVoiceIndicator();
  }
}

function processVoiceCommand(transcript) {
  console.log('Voice command:', transcript);
  
  // Common commands
  if (transcript.includes('add') && transcript.includes('water')) {
    const amount = extractAmount(transcript) || 250;
    addDrink('water', amount);
    showNotification(`Added ${amount}ml of water via voice`, "success");
  } else if (transcript.includes('how much') || transcript.includes('progress')) {
    const progress = Math.round((appState.todayData.consumed / appState.todayData.goal) * 100);
    showNotification(`You've consumed ${appState.todayData.consumed}ml, ${progress}% of your goal`, "info");
  } else if (transcript.includes('goal') || transcript.includes('target')) {
    showNotification(`Your daily goal is ${appState.todayData.goal}ml`, "info");
  } else {
    showNotification("Voice command processed", "info");
  }
}

function extractAmount(text) {
  const matches = text.match(/\d+/);
  return matches ? parseInt(matches[0]) : null;
}

function showVoiceIndicator() {
  document.getElementById('voiceIndicator').style.display = 'flex';
}

function hideVoiceIndicator() {
  document.getElementById('voiceIndicator').style.display = 'none';
}

// ============================================
// AI INSIGHTS & SMART FEATURES
// ============================================

function updateAIInsights() {
  const drinks = appState.todayData.drinks;
  const history = Object.values(appState.historicalData);
  
  if (drinks.length === 0) return;
  
  // Analyze drinking patterns
  const hours = drinks.map(d => d.hour);
  const peakHour = mode(hours);
  const avgInterval = calculateAverageInterval(drinks);
  
  // Update AI insights
  appState.aiInsights = {
    drinkingPatterns: {
      peakHour,
      avgInterval,
      favoriteDrink: getFavoriteDrink(drinks),
      consistency: calculateConsistency(history)
    },
    optimalTimes: calculateOptimalTimes(drinks),
    efficiencyScore: calculateEfficiencyScore(drinks),
    recommendations: generateRecommendations(drinks, history)
  };
  
  // Update UI
  updateSmartSuggestions();
}

function calculateAverageInterval(drinks) {
  if (drinks.length < 2) return 0;
  
  const sorted = [...drinks].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
  let totalInterval = 0;
  
  for (let i = 1; i < sorted.length; i++) {
    const interval = (new Date(sorted[i].timestamp) - new Date(sorted[i-1].timestamp)) / (1000 * 60 * 60);
    totalInterval += interval;
  }
  
  return Math.round((totalInterval / (sorted.length - 1)) * 10) / 10;
}

function calculateConsistency(history) {
  if (history.length < 7) return 0;
  
  const last7Days = history.slice(-7);
  const completedDays = last7Days.filter(d => d.completed).length;
  return Math.round((completedDays / 7) * 100);
}

function generateRecommendations(drinks, history) {
  const recommendations = [];
  const hour = new Date().getHours();
  
  // Time-based recommendations
  if (hour >= 22 || hour < 6) {
    recommendations.push("Avoid drinking large amounts before bed to prevent sleep disruption");
  } else if (hour >= 6 && hour < 10) {
    recommendations.push("Drink 500ml of water within 30 minutes of waking up");
  }
  
  // Pattern-based recommendations
  if (drinks.length === 0 && hour >= 10) {
    recommendations.push("Start hydrating! You haven't had any water today");
  } else if (calculateAverageInterval(drinks) > 4) {
    recommendations.push("Try to drink every 2-3 hours for optimal hydration");
  }
  
  // Goal-based recommendations
  const progress = (appState.todayData.consumed / appState.todayData.goal) * 100;
  if (progress < 50 && hour >= 15) {
    recommendations.push("You're behind schedule. Increase your intake this afternoon");
  }
  
  return recommendations;
}

function updateSmartSuggestions() {
  const suggestions = appState.aiInsights.recommendations || [];
  const suggestionText = suggestions.length > 0 ? 
    suggestions[0] : "Drink water consistently throughout the day";
  
  document.getElementById('suggestionText').textContent = suggestionText;
  
  // Update AI insight in stats
  const insight = appState.aiInsights.drinkingPatterns;
  if (insight.peakHour !== undefined) {
    document.getElementById('aiInsight').textContent = 
      `You drink most at ${insight.peakHour}:00, average interval: ${insight.avgInterval || 0}h`;
    document.getElementById('peakHour').textContent = `${insight.peakHour}:00`;
    document.getElementById('avgInterval').textContent = `${insight.avgInterval || 0}h`;
  }
}

// ============================================
// WEATHER INTEGRATION
// ============================================

async function setupWeatherIntegration() {
  if (!appState.settings.weatherIntegration) return;
  
  try {
    // Using a weather API (would need actual API key in production)
    const position = await getCurrentPosition();
    const weather = await fetchWeatherData(position.coords.latitude, position.coords.longitude);
    
    if (weather) {
      updateWeatherWidget(weather);
      adjustGoalForWeather(weather);
    }
  } catch (error) {
    console.log('Weather integration failed:', error);
    // Use default weather effect
    updateWeatherWidget({ temperature: 22, condition: 'sunny' });
  }
}

function getCurrentPosition() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error('Geolocation not supported'));
      return;
    }
    
    navigator.geolocation.getCurrentPosition(resolve, reject, {
      enableHighAccuracy: false,
      timeout: 5000,
      maximumAge: 60000
    });
  });
}

async function fetchWeatherData(lat, lon) {
  // Mock weather data for demo
  // In production, use: https://api.openweathermap.org/data/2.5/weather
  return {
    temperature: 22 + Math.random() * 10,
    condition: ['sunny', 'cloudy', 'rainy'][Math.floor(Math.random() * 3)],
    humidity: 40 + Math.random() * 40
  };
}

function updateWeatherWidget(weather) {
  const widget = document.getElementById('weatherWidget');
  const effect = document.getElementById('weatherEffect');
  
  let hydrationEffect, icon;
  
  if (weather.temperature > 28) {
    hydrationEffect = "High Temp ‚Üí Drink More";
    icon = "fa-temperature-high";
  } else if (weather.humidity < 30) {
    hydrationEffect = "Dry Air ‚Üí Extra Hydration";
    icon = "fa-wind";
  } else {
    hydrationEffect = "Optimal Conditions";
    icon = "fa-check-circle";
  }
  
  effect.textContent = hydrationEffect;
  widget.style.display = 'flex';
  widget.querySelector('i').className = `fas ${icon}`;
}

function adjustGoalForWeather(weather) {
  const baseGoal = appState.profile.dailyGoal;
  let adjustment = 0;
  
  if (weather.temperature > 28) adjustment += 0.2;
  if (weather.humidity < 30) adjustment += 0.15;
  if (weather.condition === 'sunny') adjustment += 0.1;
  
  const adjustedGoal = Math.round(baseGoal * (1 + adjustment));
  appState.todayData.weatherAdjustedGoal = adjustedGoal;
  
  // Only show notification if significant adjustment
  if (adjustment > 0.15) {
    showNotification(`Weather adjustment: Goal increased to ${adjustedGoal}ml`, "info");
  }
}

// ============================================
// COMMUNITY FEATURES
// ============================================

function updateCommunityStats() {
  if (!appState.settings.communityFeatures) return;
  
  // In production, this would fetch from a backend
  // For now, simulate community data
  appState.communityStats = {
    globalGoal: 78 + Math.random() * 5,
    usersOnline: 1500 + Math.floor(Math.random() * 500),
    challengeProgress: 65 + Math.random() * 10,
    topUsers: [
      { name: "HydroHero", score: 985 },
      { name: "WaterWarrior", score: 872 },
      { name: "AquaMaster", score: 765 }
    ]
  };
  
  // Update UI
  document.querySelector('.community-card .progress-fill').style.width = 
    `${appState.communityStats.globalGoal}%`;
  document.querySelector('.community-card .progress-header span:last-child').textContent = 
    `${Math.round(appState.communityStats.globalGoal)}%`;
}

function joinChallenge() {
  showNotification("Joined Global Hydration Challenge! üåç", "success");
  
  // Add achievement
  unlockAchievement('challenge_join');
  
  // Update UI
  document.querySelector('.community-card button').innerHTML = 
    '<i class="fas fa-trophy"></i> Challenge Joined!';
  document.querySelector('.community-card button').disabled = true;
}

// ============================================
// ENHANCED STATISTICS & CHARTS
// ============================================

function initializeCharts() {
  const ctx = document.getElementById('mainChart').getContext('2d');
  
  mainChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Water Intake',
        data: [],
        borderColor: 'var(--accent)',
        backgroundColor: 'rgba(79, 209, 255, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: 'var(--accent)',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(18, 26, 47, 0.95)',
          borderColor: 'var(--accent)',
          borderWidth: 1,
          titleColor: 'var(--accent)',
          bodyColor: 'var(--text)'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(255, 255, 255, 0.1)' },
          ticks: { color: 'var(--muted)' }
        },
        x: {
          grid: { display: false },
          ticks: { color: 'var(--muted)' }
        }
      }
    }
  });
  
  updateChart('week');
}

function updateChart(period) {
  if (!mainChart) return;
  
  let labels = [];
  let data = [];
  
  switch (period) {
    case 'week':
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toDateString();
        const dayData = appState.historicalData[dateStr];
        
        labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
        data.push(dayData ? dayData.consumed : 0);
      }
      break;
      
    case 'month':
      for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toDateString();
        const dayData = appState.historicalData[dateStr];
        
        labels.push(date.getDate());
        data.push(dayData ? dayData.consumed : 0);
      }
      break;
      
    case 'quarter':
      for (let i = 89; i >= 0; i -= 3) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toDateString();
        const dayData = appState.historicalData[dateStr];
        
        labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        data.push(dayData ? dayData.consumed : 0);
      }
      break;
  }
  
  mainChart.data.labels = labels;
  mainChart.data.datasets[0].data = data;
  mainChart.update();
}

function changeTimePeriod(period) {
  // Update button states
  document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  // Update chart
  updateChart(period);
  
  // Update comparative stats
  updateComparativeStats(period);
}

function updateComparativeStats(period) {
  // Calculate trend
  const history = Object.values(appState.historicalData);
  if (history.length < 7) return;
  
  const recent = history.slice(-7).reduce((sum, d) => sum + d.consumed, 0);
  const previous = history.slice(-14, -7).reduce((sum, d) => sum + d.consumed, 0);
  const trend = previous > 0 ? Math.round(((recent - previous) / previous) * 100) : 0;
  
  // Update UI
  document.getElementById('trend').textContent = trend >= 0 ? `‚Üë${trend}%` : `‚Üì${Math.abs(trend)}%`;
  document.getElementById('trend').style.color = trend >= 0 ? 'var(--success)' : 'var(--danger)';
  
  // Calculate consistency
  const consistency = calculateConsistency(history);
  document.getElementById('consistency').textContent = `${consistency}%`;
}

// ============================================
// ENHANCED CALENDAR
// ============================================

function renderCalendar() {
  const container = document.getElementById('calendarContainer');
  const month = appState.currentMonth;
  const year = appState.currentYear;
  
  // Update month display
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                      'July', 'August', 'September', 'October', 'November', 'December'];
  document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
  
  // Get calendar data
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const today = new Date();
  
  container.innerHTML = '';
  
  // Day headers
  const dayNames = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
  dayNames.forEach(day => {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    dayElement.textContent = day;
    dayElement.style.opacity = '0.5';
    dayElement.style.fontWeight = '600';
    container.appendChild(dayElement);
  });
  
  // Empty days
  for (let i = 0; i < firstDay; i++) {
    const empty = document.createElement('div');
    empty.className = 'calendar-day';
    empty.style.opacity = '0.3';
    container.appendChild(empty);
  }
  
  // Days
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    const dateStr = date.toDateString();
    const dayData = appState.historicalData[dateStr];
    
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    dayElement.textContent = day;
    
    if (dayData) {
      const progress = Math.min((dayData.consumed / dayData.goal) * 100, 100);
      
      if (progress >= 100) {
        // Goal met - full accent color
        dayElement.style.background = `linear-gradient(to top, var(--accent), transparent)`;
        dayElement.style.border = `1px solid var(--accent)`;
      } else if (progress >= 50) {
        // Partial - warning color
        dayElement.style.background = `linear-gradient(to top, var(--warning), transparent)`;
        dayElement.style.border = `1px solid var(--warning)`;
      } else if (progress > 0) {
        // Some progress
        dayElement.style.background = `linear-gradient(to top, rgba(255, 184, 77, 0.5), transparent)`;
      }
      
      // Add tooltip
      dayElement.title = `${dayData.consumed}ml / ${dayData.goal}ml (${Math.round(progress)}%)`;
    }
    
    // Highlight today
    if (date.toDateString() === today.toDateString()) {
      dayElement.style.boxShadow = '0 0 0 2px var(--accent)';
      dayElement.style.fontWeight = 'bold';
    }
    
    container.appendChild(dayElement);
  }
}

// ============================================
// ACHIEVEMENT SYSTEM
// ============================================

function checkAchievements() {
  const drinks = appState.todayData.drinks;
  const streak = appState.profile.currentStreak || 0;
  const uniqueDrinks = new Set(drinks.map(d => d.type)).size;
  const progress = (appState.todayData.consumed / appState.todayData.goal) * 100;
  
  // Check each achievement
  appState.achievements.forEach(achievement => {
    if (achievement.earned) return;
    
    let earned = false;
    
    switch(achievement.id) {
      case 'first_drink':
        earned = drinks.length > 0;
        break;
      case 'daily_goal':
        earned = appState.todayData.completed;
        break;
      case 'streak_3':
        earned = streak >= 3;
        break;
      case 'streak_7':
        earned = streak >= 7;
        break;
      case 'streak_30':
        earned = streak >= 30;
        break;
      case 'water_only':
        earned = drinks.length > 0 && drinks.every(d => d.type === 'water');
        break;
      case 'early_bird':
        earned = drinks.some(d => new Date(d.timestamp).getHours() < 8);
        break;
      case 'overachiever':
        earned = progress >= 150;
        break;
      case 'variety':
        earned = uniqueDrinks >= 5;
        break;
      case 'hydration_expert':
        earned = streak >= 7 && appState.todayData.completed;
        break;
      case 'night_owl':
        earned = drinks.some(d => new Date(d.timestamp).getHours() >= 22);
        break;
      case 'consistency':
        earned = streak >= 14;
        break;
    }
    
    if (earned) {
      unlockAchievement(achievement.id);
    }
  });
}

function unlockAchievement(id) {
  const achievement = appState.achievements.find(a => a.id === id);
  if (achievement && !achievement.earned) {
    achievement.earned = true;
    achievement.earnedDate = new Date().toISOString();
    appState.profile.totalPoints = (appState.profile.totalPoints || 0) + achievement.points;
    
    // Show toast
    document.getElementById('achievementText').textContent = 
      `${achievement.name} - ${achievement.description}`;
    document.getElementById('achievementToast').classList.add('achievement-unlock');
    document.getElementById('achievementToast').style.display = 'block';
    
    setTimeout(() => {
      document.getElementById('achievementToast').style.display = 'none';
      document.getElementById('achievementToast').classList.remove('achievement-unlock');
    }, 3000);
    
    // Update UI
    updateAchievementGallery();
    saveAllData();
  }
}

function updateAchievementGallery() {
  const container = document.getElementById('achievementGallery');
  container.innerHTML = '';
  
  appState.achievements.forEach(achievement => {
    const card = document.createElement('div');
    card.className = `achievement-card ${achievement.earned ? 'earned' : 'locked'}`;
    card.innerHTML = `
      <div class="achievement-icon">
        <i class="fas ${achievement.icon}"></i>
      </div>
      <div class="achievement-name">${achievement.name}</div>
      <div class="achievement-desc">${achievement.points} pts</div>
    `;
    container.appendChild(card);
  });
}

// ============================================
// ENHANCED PROFILE FEATURES
// ============================================

function updateProfileUI() {
  if (!appState.profile) return;
  
  const profile = appState.profile;
  
  // Update sliders and inputs
  document.getElementById('weightSlider').value = profile.weight;
  document.getElementById('weightInput').value = profile.weight;
  document.getElementById('weightValue').textContent = profile.weight;
  
  document.getElementById('heightSlider').value = profile.height;
  document.getElementById('heightInput').value = profile.height;
  document.getElementById('heightValue').textContent = profile.height;
  
  document.getElementById('dailyGoalInput').value = profile.dailyGoal;
  document.getElementById('goalSlider').value = profile.dailyGoal;
  
  // Update recommended goal
  const recommended = calculateEnhancedDailyGoal(
    profile.weight,
    profile.height,
    profile.age,
    profile.gender,
    profile.activityLevel
  );
  document.getElementById('recommendedGoal').textContent = `${recommended} ml`;
  
  // Update activity level buttons
  ['sedentary', 'light', 'moderate', 'active', 'athlete'].forEach(level => {
    const btn = document.getElementById(`activity${level.charAt(0).toUpperCase() + level.slice(1)}`);
    if (btn) {
      btn.classList.toggle('active', profile.activityLevel === level);
    }
  });
  
  // Update settings
  document.getElementById('smartReminders').checked = appState.settings.reminders?.smart || true;
  document.getElementById('reminderType').value = appState.settings.reminders?.type || 'notification';
}

function setActivityLevel(level) {
  appState.profile.activityLevel = level;
  
  // Update UI
  ['sedentary', 'light', 'moderate', 'active', 'athlete'].forEach(l => {
    const btn = document.getElementById(`activity${l.charAt(0).toUpperCase() + l.slice(1)}`);
    if (btn) {
      btn.classList.toggle('active', l === level);
    }
  });
  
  // Recalculate goal
  const newGoal = calculateEnhancedDailyGoal(
    appState.profile.weight,
    appState.profile.height,
    appState.profile.age,
    appState.profile.gender,
    level
  );
  
  document.getElementById('recommendedGoal').textContent = `${newGoal} ml`;
  appState.profile.dailyGoal = newGoal;
  appState.todayData.goal = newGoal;
  
  updateDashboard();
}

// ============================================
// SMART REMINDERS
// ============================================

function setupSmartReminders() {
  if (!appState.settings.reminders?.enabled) return;
  
  // Clear existing reminders
  clearReminders();
  
  // Setup smart reminders based on user patterns
  if (appState.settings.reminders.smart && appState.aiInsights.optimalTimes) {
    setupPatternBasedReminders();
  } else {
    setupDefaultReminders();
  }
}

function setupPatternBasedReminders() {
  const optimalTimes = appState.aiInsights.optimalTimes || [9, 14, 19];
  
  optimalTimes.forEach(hour => {
    scheduleReminderAtHour(hour);
  });
}

function setupDefaultReminders() {
  const times = appState.settings.reminders.times || ['morning', 'afternoon', 'evening'];
  
  times.forEach(time => {
    let hour;
    switch(time) {
      case 'morning': hour = 9; break;
      case 'afternoon': hour = 14; break;
      case 'evening': hour = 19; break;
      default: hour = 9;
    }
    
    scheduleReminderAtHour(hour);
  });
}

function scheduleReminderAtHour(hour) {
  const now = new Date();
  const reminderTime = new Date();
  
  reminderTime.setHours(hour, 0, 0, 0);
  
  if (reminderTime < now) {
    reminderTime.setDate(reminderTime.getDate() + 1);
  }
  
  const timeUntil = reminderTime.getTime() - now.getTime();
  
  if (timeUntil > 0) {
    setTimeout(() => {
      sendSmartReminder();
      // Schedule next day
      scheduleReminderAtHour(hour);
    }, timeUntil);
  }
}

function sendSmartReminder() {
  if (!appState.settings.reminders?.enabled) return;
  
  const progress = (appState.todayData.consumed / appState.todayData.goal) * 100;
  const hour = new Date().getHours();
  
  let message = "üíß Time to hydrate!";
  
  if (progress < 25) {
    message = hour < 12 ? 
      "üåÖ Start your day right! Drink 500ml of water." :
      "üíß You're just starting. Time for your first drink!";
  } else if (progress < 50) {
    message = "üíß Keep the momentum! You're making good progress.";
  } else if (progress < 75) {
    message = "üíß Halfway there! Stay consistent.";
  } else if (progress < 100) {
    message = "üíß Almost at your goal! One more drink should do it.";
  } else {
    message = "üéâ Goal achieved! Maintain your hydration throughout the day.";
  }
  
  // Add AI suggestion if available
  if (appState.aiInsights.recommendations?.length > 0) {
    message += `\nüí° ${appState.aiInsights.recommendations[0]}`;
  }
  
  showNotification(message, "reminder");
  
  // Send browser notification if allowed
  if (Notification.permission === 'granted') {
    new Notification('HydroTrack Reminder', {
      body: message,
      icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjNGZkMWZmIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0xMiAyYy0yLjIxIDAtNCAxLjgtNCA0IDAgMi43NiAyLjY4IDcuOTggNi41IDExLjU2IDMuODItMy41OCA2LjUtOC43OSA2LjUtMTEuNTYgMC0yLjItMS43OS00LTQtNHoiLz48L3N2Zz4='
    });
  }
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

function mode(arr) {
  return arr.sort((a,b) =>
    arr.filter(v => v===a).length - arr.filter(v => v===b).length
  ).pop();
}

function setupDateTime() {
  const now = new Date();
  const options = { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  };
  
  document.getElementById('currentDateTime').textContent = 
    now.toLocaleDateString('en-US', options);
  
  // Update every minute
  setInterval(() => {
    const now = new Date();
    document.getElementById('currentDateTime').textContent = 
      now.toLocaleDateString('en-US', options);
  }, 60000);
}

function startBackgroundTasks() {
  // Auto-save every 5 minutes
  setInterval(() => {
    saveAllData();
    console.log('Auto-saved data');
  }, 300000);
  
  // Update AI insights every hour
  setInterval(() => {
    updateAIInsights();
  }, 3600000);
  
  // Check for goal achievement every 30 minutes
  setInterval(() => {
    if (!appState.todayData.completed && 
        appState.todayData.consumed >= appState.todayData.goal) {
      appState.todayData.completed = true;
      unlockAchievement('daily_goal');
      showNotification("üéâ Daily goal achieved! Great work!", "success");
    }
  }, 1800000);
}

// ============================================
// DATA MANAGEMENT (ENHANCED)
// ============================================

function loadAllData() {
  try {
    appState.profile = JSON.parse(localStorage.getItem('hydrotrack_profile')) || null;
    appState.todayData = JSON.parse(localStorage.getItem('hydrotrack_today')) || null;
    appState.historicalData = JSON.parse(localStorage.getItem('hydrotrack_history')) || {};
    appState.settings = JSON.parse(localStorage.getItem('hydrotrack_settings')) || {};
    appState.achievements = JSON.parse(localStorage.getItem('hydrotrack_achievements')) || [];
    appState.customDrinks = JSON.parse(localStorage.getItem('hydrotrack_custom_drinks')) || [];
    appState.aiInsights = JSON.parse(localStorage.getItem('hydrotrack_ai_insights')) || {};
  } catch (e) {
    console.error('Error loading data:', e);
    // Initialize fresh state on error
    appState = {
      version: APP_VERSION,
      profile: null,
      todayData: null,
      historicalData: {},
      settings: {},
      achievements: [],
      customDrinks: [],
      aiInsights: {},
      communityStats: {},
      voiceCommands: {}
    };
  }
}

function saveAllData() {
  try {
    localStorage.setItem('hydrotrack_profile', JSON.stringify(appState.profile));
    localStorage.setItem('hydrotrack_today', JSON.stringify(appState.todayData));
    localStorage.setItem('hydrotrack_history', JSON.stringify(appState.historicalData));
    localStorage.setItem('hydrotrack_settings', JSON.stringify(appState.settings));
    localStorage.setItem('hydrotrack_achievements', JSON.stringify(appState.achievements));
    localStorage.setItem('hydrotrack_custom_drinks', JSON.stringify(appState.customDrinks));
    localStorage.setItem('hydrotrack_ai_insights', JSON.stringify(appState.aiInsights));
    localStorage.setItem('hydrotrack_last_sync', new Date().toISOString());
  } catch (e) {
    console.error('Error saving data:', e);
    showNotification("Error saving data", "error");
  }
}

function exportData() {
  const data = {
    ...appState,
    exportDate: new Date().toISOString(),
    exportVersion: APP_VERSION
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `hydrotrack-backup-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showNotification("Data exported successfully!", "success");
}

async function backupToCloud() {
  // In production, this would upload to a cloud service
  // For now, simulate cloud backup
  showNotification("Backing up to cloud...", "info");
  
  setTimeout(() => {
    localStorage.setItem('hydrotrack_last_cloud_backup', new Date().toISOString());
    showNotification("Cloud backup complete! ‚úÖ", "success");
  }, 1500);
}

function syncData() {
  // Simulate data sync
  showNotification("Syncing data...", "info");
  
  setTimeout(() => {
    saveAllData();
    showNotification("Data synchronized! üîÑ", "success");
  }, 1000);
}

// ============================================
// UI HELPER FUNCTIONS
// ============================================

function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(screen => {
    screen.style.display = 'none';
  });
  
  document.getElementById(screenId).style.display = 'block';
  
  // Update nav
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // Update based on screen
  switch(screenId) {
    case 'dashboard':
      document.querySelector('.nav-item:nth-child(1)').classList.add('active');
      break;
    case 'statsScreen':
      document.querySelector('.nav-item:nth-child(3)').classList.add('active');
      renderCalendar();
      updateChart('week');
      updateAchievementGallery();
      break;
    case 'profileScreen':
      document.querySelector('.nav-item:nth-child(4)').classList.add('active');
      break;
  }
}

function showNotification(message, type = 'success') {
  const notification = document.getElementById('notification');
  const text = document.getElementById('notificationText');
  
  text.textContent = message;
  
  // Set color based on type
  if (type === 'error') {
    notification.style.background = 'linear-gradient(135deg, var(--danger), #ff6b6b)';
  } else if (type === 'warning') {
    notification.style.background = 'linear-gradient(135deg, var(--warning), #ffb84d)';
  } else if (type === 'info') {
    notification.style.background = 'linear-gradient(135deg, var(--secondary), #8b5cf6)';
  } else if (type === 'reminder') {
    notification.style.background = 'linear-gradient(135deg, #ff6b6b, #ffb84d)';
  } else {
    notification.style.background = 'linear-gradient(135deg, var(--accent), var(--accent2))';
  }
  
  notification.style.display = 'block';
  notification.classList.add('show');
  
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      notification.style.display = 'none';
    }, 500);
  }, 3000);
}

// ============================================
// INITIALIZE APP
// ============================================

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', initializeApp);

// Handle offline/online status
window.addEventListener('online', () => {
  showNotification("Back online - syncing data...", "info");
  syncData();
});

window.addEventListener('offline', () => {
  showNotification("You're offline - working in offline mode", "warning");
});

// Handle beforeunload
window.addEventListener('beforeunload', () => {
  saveAllData();
});

// Export to global scope for HTML event handlers
window.appState = appState;
window.initializeApp = initializeApp;
window.showScreen = showScreen;
window.openProfile = () => showScreen('profileScreen');
window.closeProfile = () => showScreen('dashboard');
window.openStats = () => showScreen('statsScreen');
window.closeStats = () => showScreen('dashboard');
window.openDrinkModal = () => document.getElementById('drinkModal').style.display = 'flex';
window.closeModal = (id) => document.getElementById(id).style.display = 'none';
window.prevMonth = () => {
  appState.currentMonth--;
  if (appState.currentMonth < 0) {
    appState.currentMonth = 11;
    appState.currentYear--;
  }
  renderCalendar();
};
window.nextMonth = () => {
  appState.currentMonth++;
  if (appState.currentMonth > 11) {
    appState.currentMonth = 0;
    appState.currentYear++;
  }
  renderCalendar();
};
window.startVoiceCommand = startVoiceCommand;
window.joinChallenge = joinChallenge;
window.analyzePatterns = () => {
  updateAIInsights();
  showNotification("AI analysis complete! Check insights.", "info");
};
window.setActivityLevel = setActivityLevel;
window.connectHealthApp = (app) => {
  showNotification(`Connecting to ${app} Health...`, "info");
  setTimeout(() => {
    showNotification(`Connected to ${app} Health!`, "success");
  }, 2000);
};
</script>
</body>
</html>
