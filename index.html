<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Waterify Pro</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#060b18">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* Add new animation styles for achievements */
@keyframes achievementUnlock {
  0% {
    transform: scale(0.5) rotate(-10deg);
    opacity: 0;
  }
  60% {
    transform: scale(1.1) rotate(5deg);
  }
  100% {
    transform: scale(1) rotate(0);
    opacity: 1;
  }
}

@keyframes confettiRain {
  0% { transform: translateY(-100px) rotate(0deg); }
  100% { transform: translateY(100vh) rotate(360deg); }
}

@keyframes glowPulse {
  0%, 100% { box-shadow: 0 0 20px rgba(79, 209, 255, 0.5); }
  50% { box-shadow: 0 0 40px rgba(79, 209, 255, 0.8); }
}

.achievement-unlock-modal {
  animation: achievementUnlock 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  position: relative;
  overflow: hidden;
}

.achievement-unlock-modal::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(79, 209, 255, 0.2) 0%, transparent 70%);
  animation: glowPulse 2s infinite;
}

.confetti {
  position: fixed;
  width: 10px;
  height: 10px;
  background: var(--accent);
  pointer-events: none;
  z-index: 1001;
  opacity: 0.8;
}

/* Enhanced notification for achievements */
.achievement-notification {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: linear-gradient(135deg, #4fd1ff, #8b5cf6, #ffb84d);
  background-size: 200% 200%;
  color: white;
  padding: 20px 30px;
  border-radius: 20px;
  font-weight: 600;
  box-shadow: 0 15px 40px rgba(79, 209, 255, 0.4),
              0 0 50px rgba(139, 92, 246, 0.3);
  z-index: 1000;
  text-align: center;
  min-width: 300px;
  animation: slideDown 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards,
             gradientShift 3s infinite linear;
  border: 2px solid rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(10px);
}

@keyframes slideDown {
  to { transform: translateX(-50%) translateY(0); }
}

@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.achievement-notification i {
  font-size: 24px;
  margin-bottom: 10px;
  display: block;
  animation: bounce 2s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

/* Enhanced drink removal styles */
.drink-item-with-remove {
  position: relative;
  transition: all 0.3s ease;
}

.remove-drink-btn {
  position: absolute;
  top: 5px;
  right: 5px;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--danger);
  color: white;
  border: none;
  font-size: 12px;
  cursor: pointer;
  opacity: 0;
  transform: scale(0.8);
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2;
}

.drink-item-with-remove:hover .remove-drink-btn {
  opacity: 1;
  transform: scale(1);
}

.remove-drink-btn:hover {
  background: #ff1a4d;
  transform: scale(1.1);
}

/* Update time progress for 24-hour coverage */
.time-progress {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  margin: 20px 0;
}

@media (min-width: 480px) {
  .time-progress {
    grid-template-columns: repeat(8, 1fr);
  }
}

.time-slot.night {
  background: linear-gradient(145deg, rgba(18, 26, 47, 0.8), rgba(12, 18, 34, 0.9));
  border-color: rgba(107, 124, 255, 0.3);
}

.time-slot.night.active {
  background: rgba(107, 124, 255, 0.2);
  border-color: var(--accent2);
  box-shadow: 0 0 15px rgba(107, 124, 255, 0.3);
}

/* Rest of your existing CSS remains exactly the same */
:root {
  --bg: #060b18;
  --card: #121a2f;
  --accent: #4fd1ff;
  --accent2: #6b7cff;
  --text: #fff;
  --muted: #9aa4bf;
  --success: #4dffb8;
  --warning: #ffb84d;
  --danger: #ff4d6d;
  --secondary: #8b5cf6;
  --grid-bg: rgba(79, 209, 255, 0.05);
  --glass: rgba(255, 255, 255, 0.05);
  --glass-border: rgba(255, 255, 255, 0.1);
}

* {
  box-sizing: border-box;
  font-family: 'Poppins', sans-serif;
  -webkit-tap-highlight-color: transparent;
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  overflow-x: hidden;
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 20% 80%, rgba(79, 209, 255, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(107, 124, 255, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
  pointer-events: none;
  z-index: -1;
}

.app {
  max-width: 480px;
  margin: auto;
  padding: 16px;
  padding-bottom: 100px;
  min-height: 100vh;
  position: relative;
}

/* Card */
.card {
  background: linear-gradient(145deg, rgba(18, 26, 47, 0.95), rgba(12, 18, 34, 0.95));
  backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  border-radius: 24px;
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 
    0 8px 32px rgba(0, 0, 0, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
  position: relative;
  overflow: hidden;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 
    0 12px 40px rgba(0, 0, 0, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.15);
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--accent), transparent);
}

/* Bottle */
.bottle-container {
  position: relative;
  width: 160px;
  height: 320px;
  margin: 24px auto;
  perspective: 1000px;
}

.bottle {
  width: 100%;
  height: 100%;
  border-radius: 40px;
  border: 2px solid rgba(255, 255, 255, 0.15);
  position: relative;
  overflow: hidden;
  background: rgba(0, 0, 0, 0.2);
  box-shadow: 
    inset 0 0 20px rgba(0, 0, 0, 0.5),
    0 10px 30px rgba(79, 209, 255, 0.2);
  transform-style: preserve-3d;
  animation: floatBottle 4s ease-in-out infinite;
}

@keyframes floatBottle {
  0%, 100% { transform: translateY(0) rotateX(5deg); }
  50% { transform: translateY(-10px) rotateX(5deg); }
}

.water {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 0%;
  background: linear-gradient(180deg, 
    rgba(123, 231, 255, 0.9) 0%,
    rgba(63, 169, 245, 0.9) 100%);
  transition: height 1s cubic-bezier(0.34, 1.56, 0.64, 1);
  border-radius: 0 0 38px 38px;
  box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.3);
}

/* Buttons */
.btn {
  width: 100%;
  padding: 16px;
  border: none;
  border-radius: 16px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  font-weight: 600;
  color: #000;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  font-size: 16px;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(79, 209, 255, 0.4);
}

.btn-secondary {
  background: var(--glass);
  color: var(--text);
  border: 1px solid var(--glass-border);
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.1);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.btn-small {
  padding: 8px 16px;
  width: auto;
  font-size: 14px;
}

/* Navigation */
.nav {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(11, 18, 40, 0.95);
  backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 50px;
  display: flex;
  justify-content: space-around;
  padding: 12px 24px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
  z-index: 100;
}

.nav-item {
  position: relative;
  padding: 10px;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  color: var(--muted);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  min-width: 60px;
}

.nav-item i {
  font-size: 20px;
  transition: all 0.3s ease;
}

.nav-item span {
  font-size: 11px;
  font-weight: 500;
  opacity: 0.8;
}

.nav-item.active {
  color: var(--accent);
  background: rgba(79, 209, 255, 0.1);
}

.nav-item.active::after {
  content: '';
  position: absolute;
  bottom: -12px;
  left: 50%;
  transform: translateX(-50%);
  width: 4px;
  height: 4px;
  background: var(--accent);
  border-radius: 50%;
  box-shadow: 0 0 10px var(--accent);
}

.nav-item:hover:not(.active) {
  color: var(--text);
  background: rgba(255, 255, 255, 0.05);
}

/* Modals */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(10px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  width: 100%;
  max-width: 420px;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes slideUp {
  from { transform: translateY(50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid var(--glass-border);
}

.modal-header h3 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
}

.close-btn {
  background: none;
  border: none;
  color: var(--muted);
  font-size: 20px;
  cursor: pointer;
  padding: 5px;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.close-btn:hover {
  color: var(--text);
  background: rgba(255, 255, 255, 0.1);
}

/* Enhanced Rulers */
.ruler-section {
  margin: 20px 0;
}

.ruler-value-display {
  text-align: center;
  font-size: 42px;
  font-weight: 700;
  margin: 15px 0;
  color: var(--accent);
  text-shadow: 0 0 20px rgba(79, 209, 255, 0.5);
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.ruler-container {
  position: relative;
  height: 140px;
  margin: 30px -20px 40px -20px;
  overflow: hidden;
  padding-top: 20px;
}

.ruler-track {
  position: absolute;
  top: 60%;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, 
    transparent 10%, 
    var(--glass-border) 10%, 
    var(--glass-border) 90%, 
    transparent 90%);
  transform: translateY(-50%);
}

.ruler-scroll {
  display: flex;
  height: 100%;
  overflow-x: scroll;
  scrollbar-width: none;
  scroll-behavior: smooth;
  padding: 0 50%;
  -webkit-overflow-scrolling: touch;
  scroll-snap-type: x mandatory;
}

.ruler-scroll::-webkit-scrollbar {
  display: none;
}

.ruler-tick {
  width: 40px;
  flex-shrink: 0;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  scroll-snap-align: center;
  padding-bottom: 30px;
  cursor: pointer;
}

.tick-line {
  width: 2px;
  background: var(--glass-border);
  transition: all 0.3s ease;
}

.tick-label {
  position: absolute;
  bottom: 0;
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
  opacity: 0.5;
  transition: all 0.3s ease;
  text-align: center;
  width: 100%;
}

.ruler-tick.active .tick-line {
  height: 40px !important;
  background: var(--accent);
  box-shadow: 0 0 10px var(--accent);
}

.ruler-tick.active .tick-label {
  color: var(--accent);
  opacity: 1;
  font-weight: 600;
  font-size: 14px;
}

.center-indicator {
  position: absolute;
  top: 60%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 4px;
  height: 60px;
  background: var(--accent);
  box-shadow: 0 0 20px var(--accent);
  border-radius: 2px;
  z-index: 2;
}

/* Manual Input Controls */
.input-group {
  margin-bottom: 20px;
}

.input-label {
  display: block;
  margin-bottom: 8px;
  color: var(--muted);
  font-size: 14px;
  font-weight: 500;
}

.input-with-controls {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 10px;
}

.manual-input {
  flex: 1;
  padding: 14px;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  color: var(--text);
  font-size: 16px;
  font-weight: 500;
  text-align: center;
  outline: none;
  transition: all 0.3s ease;
}

.manual-input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(79, 209, 255, 0.2);
}

.unit-btn {
  padding: 10px 16px;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  color: var(--text);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  min-width: 60px;
}

.unit-btn:hover {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
}

/* Age Selector */
.age-selector {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 30px 0;
}

.age-display {
  font-size: 48px;
  font-weight: 800;
  color: var(--accent);
  margin: 20px 0;
  text-shadow: 0 0 30px rgba(79, 209, 255, 0.5);
}

.age-controls {
  display: flex;
  gap: 20px;
  align-items: center;
  margin-bottom: 30px;
}

.age-btn {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  color: var(--text);
  font-size: 24px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.age-btn:hover {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
  transform: scale(1.1);
}

/* Enhanced Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
  margin: 20px 0;
}

.stat-card {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  transition: all 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-2px);
  border-color: var(--accent);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}

.stat-value {
  font-size: 32px;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 5px;
}

.stat-label {
  font-size: 12px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Progress Indicators */
.progress-container {
  margin: 20px 0;
}

.progress-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.progress-bar {
  height: 8px;
  background: var(--glass);
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  border-radius: 4px;
  transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* Drink Selection */
.drink-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin: 20px 0;
}

.drink-item {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.drink-item:hover {
  transform: translateY(-4px);
  border-color: var(--accent);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}

.drink-icon {
  font-size: 32px;
  margin-bottom: 5px;
}

.drink-name {
  font-weight: 600;
  font-size: 14px;
}

.drink-percentage {
  font-size: 12px;
  color: var(--muted);
}

/* Amount Selection */
.amount-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin: 20px 0;
}

.amount-btn {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 16px 8px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.amount-btn:hover {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
}

.amount-btn.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
  box-shadow: 0 0 20px rgba(79, 209, 255, 0.3);
}

.amount-value {
  font-weight: 600;
  font-size: 16px;
}

.amount-water {
  font-size: 11px;
  color: var(--muted);
}

.custom-amount {
  grid-column: span 4;
  padding: 16px;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  color: var(--text);
  font-size: 16px;
  text-align: center;
  outline: none;
  transition: all 0.3s ease;
}

.custom-amount:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(79, 209, 255, 0.2);
}

/* Advanced Stats Section */
.advanced-stats {
  margin-top: 30px;
}

.chart-container {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.chart-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--accent);
}

.chart-actions {
  display: flex;
  gap: 10px;
}

.chart-btn {
  padding: 6px 12px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--glass-border);
  border-radius: 8px;
  color: var(--text);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.chart-btn:hover {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
}

.chart-btn.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

/* Notification */
.notification {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: #000;
  padding: 15px 25px;
  border-radius: 15px;
  font-weight: 600;
  box-shadow: 0 10px 30px rgba(79, 209, 255, 0.4);
  z-index: 1000;
  transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
  text-align: center;
  display: none;
}

.notification.show {
  transform: translateX(-50%) translateY(0);
}

/* Mobile Optimizations */
@media (max-width: 480px) {
  .app {
    padding: 12px;
    padding-bottom: 100px;
  }
  
  .card {
    padding: 20px;
    border-radius: 20px;
  }
  
  .drink-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .amount-grid {
    grid-template-columns: repeat(3, 1fr);
  }
  
  .amount-btn {
    padding: 14px 6px;
  }
  
  .nav {
    padding: 10px 20px;
    border-radius: 40px;
  }
  
  .nav-item {
    min-width: 50px;
    padding: 8px;
  }
  
  .nav-item i {
    font-size: 18px;
  }
  
  .nav-item span {
    font-size: 10px;
  }
}

/* Scrollbar Styling */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--accent2);
}

/* NEW FEATURES */
/* Hydration Levels */
.hydration-levels {
  display: flex;
  justify-content: space-between;
  margin: 20px 0;
}

.hydration-level {
  text-align: center;
  opacity: 0.5;
  transition: all 0.3s ease;
  cursor: pointer;
}

.hydration-level.active {
  opacity: 1;
  transform: scale(1.1);
}

.level-circle {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin: 0 auto 8px;
  transition: all 0.3s ease;
}

.level-0 { background: var(--danger); }
.level-1 { background: #ff9966; }
.level-2 { background: var(--warning); }
.level-3 { background: #a6ff4d; }
.level-4 { background: var(--success); }

/* Time-based Progress - UPDATED FOR 24 HOURS */
.time-progress {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  margin: 20px 0;
}

@media (min-width: 480px) {
  .time-progress {
    grid-template-columns: repeat(8, 1fr);
  }
}

.time-slot {
  text-align: center;
  padding: 12px;
  background: var(--glass);
  border-radius: 12px;
  border: 1px solid var(--glass-border);
  transition: all 0.3s ease;
}

.time-slot.active {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
}

.time-slot.night {
  background: linear-gradient(145deg, rgba(18, 26, 47, 0.8), rgba(12, 18, 34, 0.9));
  border-color: rgba(107, 124, 255, 0.3);
}

.time-slot.night.active {
  background: rgba(107, 124, 255, 0.2);
  border-color: var(--accent2);
  box-shadow: 0 0 15px rgba(107, 124, 255, 0.3);
}

.time-label {
  font-size: 11px;
  color: var(--muted);
  margin-bottom: 5px;
}

.time-value {
  font-weight: 600;
  font-size: 14px;
  color: var(--accent);
}

/* Achievement Badges */
.achievement-badge {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 40px;
  height: 40px;
  background: var(--accent);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #000;
  font-size: 20px;
  box-shadow: 0 0 20px rgba(79, 209, 255, 0.5);
  animation: pulse 2s infinite;
  cursor: pointer;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* Water Drop Animation */
.water-drop {
  position: fixed;
  width: 20px;
  height: 30px;
  background: rgba(79, 209, 255, 0.3);
  border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
  animation: drop 1.5s linear infinite;
  pointer-events: none;
  z-index: 1;
}

@keyframes drop {
  0% {
    transform: translateY(-100vh) rotate(0deg);
    opacity: 0;
  }
  10% {
    opacity: 1;
  }
  90% {
    opacity: 1;
  }
  100% {
    transform: translateY(100vh) rotate(360deg);
    opacity: 0;
  }
}

/* Quick Add Buttons */
.quick-add-buttons {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin: 20px 0;
}

.quick-add-btn {
  padding: 12px;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.quick-add-btn:hover {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
}

.quick-add-btn i {
  font-size: 20px;
  color: var(--accent);
}

.quick-add-btn span {
  font-size: 12px;
  color: var(--muted);
}

/* Gender Selector */
.gender-selector {
  display: flex;
  gap: 10px;
  margin: 15px 0;
}

.gender-option {
  flex: 1;
  padding: 12px;
  text-align: center;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.gender-option.active {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
  color: var(--accent);
}

/* Activity Level Selector */
.activity-levels {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin: 15px 0;
}

.activity-level {
  padding: 12px;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.activity-level.active {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
}

.activity-info {
  font-size: 12px;
  color: var(--muted);
}

/* Chart Fixes */
.chart-grid-white {
  background: rgba(255, 255, 255, 0.1) !important;
  border-color: rgba(255, 255, 255, 0.2) !important;
}

.chart-text-white {
  color: rgba(255, 255, 255, 0.8) !important;
}

/* Unit Conversion Buttons */
.unit-conversion {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.unit-conversion-btn {
  flex: 1;
  padding: 10px;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 10px;
  color: var(--text);
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
  font-size: 14px;
}

.unit-conversion-btn.active {
  background: rgba(79, 209, 255, 0.1);
  border-color: var(--accent);
  color: var(--accent);
}

.unit-conversion-btn:hover:not(.active) {
  background: rgba(255, 255, 255, 0.05);
}

/* Welcome Modal */
.welcome-modal {
  z-index: 2000;
}

.welcome-modal .modal-content {
  max-width: 400px;
}

/* Achievements Grid */
.achievements-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin: 20px 0;
}

.achievement-item {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 16px;
  text-align: center;
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

.achievement-item.locked {
  opacity: 0.5;
  filter: grayscale(0.8);
}

.achievement-item.unlocked {
  border-color: var(--accent);
  box-shadow: 0 0 15px rgba(79, 209, 255, 0.2);
}

.achievement-icon {
  width: 48px;
  height: 48px;
  background: var(--accent);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  color: #000;
  margin-bottom: 8px;
}

.achievement-name {
  font-weight: 600;
  font-size: 14px;
}

.achievement-desc {
  font-size: 11px;
  color: var(--muted);
  line-height: 1.3;
}

.achievement-date {
  font-size: 10px;
  color: var(--accent);
  font-style: italic;
}
</style>
</head>

<body>
<!-- Water Drop Animation Container -->
<div id="waterDropsContainer"></div>

<!-- Achievement Badge -->
<div class="achievement-badge" onclick="showAchievementsModal()" title="View Achievements">
  <i class="fas fa-trophy"></i>
</div>

<div class="app">
  <!-- Main Dashboard -->
  <div id="dashboard" class="screen">
    <div class="card" style="position: relative;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
          <h1 style="margin: 0; font-size: 28px; font-weight: 700; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Waterify Pro</h1>
          <p style="margin: 5px 0 0 0; color: var(--muted); font-size: 14px;" id="greetingMessage">Stay Hydrated, Stay Healthy</p>
        </div>
        <div class="btn-small" onclick="openProfile()" style="background: var(--glass); border: 1px solid var(--glass-border); color: var(--text);">
          <i class="fas fa-user"></i>
          <span id="userName">Profile</span>
        </div>
      </div>

      <!-- Time-based Progress - UPDATED FOR 24 HOURS -->
      <div class="time-progress" id="timeProgress">
        <!-- Will be populated by JavaScript -->
      </div>

      <div style="text-align: center; margin-bottom: 30px;">
        <div class="progress-container">
          <div class="progress-header">
            <span style="font-weight: 600; color: var(--accent);">Daily Progress</span>
            <span style="font-weight: 600;" id="progressText">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>
      </div>

      <!-- Hydration Levels -->
      <div class="hydration-levels">
        <div class="hydration-level" onclick="setGoalPercentage(0)">
          <div class="level-circle level-0"></div>
          <div style="font-size: 11px;">Low</div>
        </div>
        <div class="hydration-level" onclick="setGoalPercentage(25)">
          <div class="level-circle level-1"></div>
          <div style="font-size: 11px;">25%</div>
        </div>
        <div class="hydration-level" onclick="setGoalPercentage(50)">
          <div class="level-circle level-2"></div>
          <div style="font-size: 11px;">50%</div>
        </div>
        <div class="hydration-level" onclick="setGoalPercentage(75)">
          <div class="level-circle level-3"></div>
          <div style="font-size: 11px;">75%</div>
        </div>
        <div class="hydration-level" onclick="setGoalPercentage(100)">
          <div class="level-circle level-4"></div>
          <div style="font-size: 11px;">Goal</div>
        </div>
      </div>

      <div class="bottle-container">
        <div class="bottle">
          <div class="water" id="waterLevel"></div>
        </div>
      </div>

      <div style="text-align: center; margin: 30px 0;">
        <div id="consumedDisplay" style="font-size: 48px; font-weight: 800; color: var(--accent); margin-bottom: 10px; text-shadow: 0 0 20px rgba(79, 209, 255, 0.5);">0 ml</div>
        <div id="goalDisplay" style="color: var(--muted); font-size: 16px;">of 0 ml goal</div>
        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: var(--accent);" id="drinksCount">0</div>
            <div style="font-size: 12px; color: var(--muted);">Drinks</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: var(--accent);" id="streakCount">0</div>
            <div style="font-size: 12px; color: var(--muted);">Day Streak</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: var(--accent);" id="todayBest">0</div>
            <div style="font-size: 12px; color: var(--muted);">Today's Best</div>
          </div>
        </div>
      </div>

      <!-- Quick Add Buttons -->
      <div class="quick-add-buttons">
        <div class="quick-add-btn" onclick="quickAddDrink('water', 250)">
          <i class="fas fa-tint"></i>
          <span>250ml</span>
        </div>
        <div class="quick-add-btn" onclick="quickAddDrink('water', 500)">
          <i class="fas fa-wine-bottle"></i>
          <span>500ml</span>
        </div>
        <div class="quick-add-btn" onclick="quickAddDrink('water', 750)">
          <i class="fas fa-glass-water"></i>
          <span>750ml</span>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
        <button class="btn" onclick="openDrinkModal()">
          <i class="fas fa-plus"></i> Add Drink
        </button>
        <button class="btn-secondary" onclick="openStats()">
          <i class="fas fa-chart-line"></i> Stats
        </button>
      </div>

      <div style="margin-top: 30px;">
        <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-history" style="color: var(--accent); margin-right: 10px;"></i>Recent Activity</h3>
        <div id="recentActivity" style="max-height: 200px; overflow-y: auto; padding-right: 10px;"></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-chart-bar" style="color: var(--accent); margin-right: 10px;"></i>Quick Stats</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="weekAvg">0</div>
          <div class="stat-label">Weekly Avg</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="monthTotal">0</div>
          <div class="stat-label">Monthly Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="goalDays">0%</div>
          <div class="stat-label">Goal Days</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="bestStreak">0</div>
          <div class="stat-label">Best Streak</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-lightbulb" style="color: var(--accent); margin-right: 10px;"></i>Hydration Tip</h3>
      <div id="hydrationTip" style="color: var(--muted); font-size: 14px; line-height: 1.6;">Loading tip...</div>
    </div>
  </div>

  <!-- Statistics Screen -->
  <div id="statsScreen" class="screen" style="display: none;">
    <div class="card">
      <div class="modal-header">
        <h3><i class="fas fa-chart-line"></i> Advanced Statistics</h3>
        <button class="close-btn" onclick="closeStats()"><i class="fas fa-times"></i></button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalConsumed">0</div>
          <div class="stat-label">Lifetime Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="avgDaily">0</div>
          <div class="stat-label">Daily Average</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="bestDay">0</div>
          <div class="stat-label">Best Day</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="completionRate">0%</div>
          <div class="stat-label">Success Rate</div>
        </div>
      </div>

      <div class="advanced-stats">
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">Weekly Trend</div>
            <div class="chart-actions">
              <button class="chart-btn active" onclick="changeChartType('weekly')">Week</button>
              <button class="chart-btn" onclick="changeChartType('monthly')">Month</button>
              <button class="chart-btn" onclick="changeChartType('yearly')">Year</button>
            </div>
          </div>
          <div id="chartContainer" style="width: 100%; height: 250px;">
            <canvas id="trendChart" style="width: 100%; height: 100%;"></canvas>
          </div>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">Drink Distribution</div>
            <div class="chart-actions">
              <button class="chart-btn active" onclick="changePieType('today')">Today</button>
              <button class="chart-btn" onclick="changePieType('week')">Week</button>
              <button class="chart-btn" onclick="changePieType('month')">Month</button>
            </div>
          </div>
          <div id="pieContainer" style="width: 100%; height: 250px;">
            <canvas id="distributionChart" style="width: 100%; height: 100%;"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-calendar-alt" style="color: var(--accent); margin-right: 10px;"></i>Monthly Overview</h3>
      <div id="calendarContainer" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">
        <!-- Calendar will be generated here -->
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 20px;">
        <button class="btn-small" onclick="prevMonth()"><i class="fas fa-chevron-left"></i> Prev</button>
        <span id="currentMonth" style="font-weight: 600; color: var(--accent);">January 2024</span>
        <button class="btn-small" onclick="nextMonth()">Next <i class="fas fa-chevron-right"></i></button>
      </div>
    </div>
  </div>

  <!-- Profile Screen -->
  <div id="profileScreen" class="screen" style="display: none;">
    <div class="card">
      <div class="modal-header">
        <h3><i class="fas fa-user-cog"></i> Profile Settings</h3>
        <button class="close-btn" onclick="closeProfile()"><i class="fas fa-times"></i></button>
      </div>

      <div class="input-group">
        <label class="input-label">Your Name</label>
        <input type="text" class="manual-input" id="userNameInput" placeholder="Enter your name">
      </div>

      <!-- Gender Selection -->
      <div class="input-group">
        <label class="input-label">Gender</label>
        <div class="gender-selector">
          <div class="gender-option" data-gender="male" onclick="selectGender('male')">
            <i class="fas fa-mars"></i> Male
          </div>
          <div class="gender-option" data-gender="female" onclick="selectGender('female')">
            <i class="fas fa-venus"></i> Female
          </div>
          <div class="gender-option" data-gender="other" onclick="selectGender('other')">
            <i class="fas fa-genderless"></i> Other
          </div>
        </div>
      </div>

      <div class="ruler-section">
        <label class="input-label">
          <span id="weightLabel">Weight (kg)</span>
          <div class="unit-conversion">
            <button class="unit-conversion-btn active" data-unit="metric" onclick="setWeightUnit('metric')">kg/cm</button>
            <button class="unit-conversion-btn" data-unit="imperial" onclick="setWeightUnit('imperial')">lbs/ft</button>
          </div>
        </label>
        <div class="ruler-value-display">
          <span id="weightValue">70</span>
          <span id="weightUnit">kg</span>
        </div>
        <div class="input-with-controls">
          <input type="number" class="manual-input" id="weightInput" min="30" max="200" step="1" value="70" onchange="updateWeightFromInput()">
          <button class="unit-btn" onclick="adjustWeight(-1)">-1</button>
          <button class="unit-btn" onclick="adjustWeight(1)">+1</button>
        </div>
        <div class="ruler-container">
          <div class="ruler-track"></div>
          <div class="center-indicator"></div>
          <div class="ruler-scroll" id="weightRuler"></div>
        </div>
      </div>

      <div class="ruler-section">
        <label class="input-label">
          <span id="heightLabel">Height (cm)</span>
        </label>
        <div class="ruler-value-display">
          <span id="heightValue">170</span>
          <span id="heightUnit">cm</span>
        </div>
        <div class="input-with-controls">
          <input type="number" class="manual-input" id="heightInput" min="100" max="250" step="1" value="170" onchange="updateHeightFromInput()">
          <button class="unit-btn" onclick="adjustHeight(-1)">-1</button>
          <button class="unit-btn" onclick="adjustHeight(1)">+1</button>
        </div>
        <div class="ruler-container">
          <div class="ruler-track"></div>
          <div class="center-indicator"></div>
          <div class="ruler-scroll" id="heightRuler"></div>
        </div>
      </div>

      <div class="age-selector">
        <label class="input-label">Age</label>
        <div class="age-display" id="ageValue">25</div>
        <div class="age-controls">
          <button class="age-btn" onclick="adjustAge(-1)"><i class="fas fa-minus"></i></button>
          <input type="number" class="manual-input" id="ageManualInput" min="10" max="100" value="25" style="width: 100px;" onchange="updateAgeFromInput()">
          <button class="age-btn" onclick="adjustAge(1)"><i class="fas fa-plus"></i></button>
        </div>
        <div class="input-with-controls">
          <button class="unit-btn" onclick="setAge(18)">18</button>
          <button class="unit-btn" onclick="setAge(25)">25</button>
          <button class="unit-btn" onclick="setAge(35)">35</button>
          <button class="unit-btn" onclick="setAge(50)">50</button>
        </div>
      </div>

      <!-- Activity Level -->
      <div class="input-group">
        <label class="input-label">Activity Level</label>
        <div class="activity-levels">
          <div class="activity-level" data-level="sedentary" onclick="selectActivityLevel('sedentary')">
            <span>Sedentary</span>
            <span class="activity-info">Little or no exercise</span>
          </div>
          <div class="activity-level" data-level="light" onclick="selectActivityLevel('light')">
            <span>Lightly Active</span>
            <span class="activity-info">Light exercise 1-3 days/week</span>
          </div>
          <div class="activity-level active" data-level="moderate" onclick="selectActivityLevel('moderate')">
            <span>Moderately Active</span>
            <span class="activity-info">Moderate exercise 3-5 days/week</span>
          </div>
          <div class="activity-level" data-level="active" onclick="selectActivityLevel('active')">
            <span>Very Active</span>
            <span class="activity-info">Hard exercise 6-7 days/week</span>
          </div>
          <div class="activity-level" data-level="athlete" onclick="selectActivityLevel('athlete')">
            <span>Extremely Active</span>
            <span class="activity-info">Very hard exercise & physical job</span>
          </div>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Daily Goal (ml)</label>
        <div class="input-with-controls">
          <input type="number" class="manual-input" id="dailyGoalInput" min="1000" max="5000" step="50" value="2000">
          <button class="unit-btn" onclick="calculateRecommendedGoal()">Recommended</button>
        </div>
      </div>

      <button class="btn" onclick="saveProfile()" style="margin-top: 30px;">
        <i class="fas fa-save"></i> Save Profile
      </button>
    </div>

    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-bell" style="color: var(--accent); margin-right: 10px;"></i>Reminders</h3>
      
      <div class="input-group">
        <label class="input-label">Enable Reminders</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="remindersEnabled" checked style="width: 20px; height: 20px;">
            <span>Enable daily reminders</span>
          </label>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Reminder Time</label>
        <input type="time" class="manual-input" id="reminderTime" value="09:00">
      </div>

      <div class="input-group">
        <label class="input-label">Reminder Frequency</label>
        <select class="manual-input" id="reminderFrequency">
          <option value="1">Every hour</option>
          <option value="2" selected>Every 2 hours</option>
          <option value="3">Every 3 hours</option>
          <option value="4">Every 4 hours</option>
        </select>
      </div>

      <button class="btn-secondary" onclick="testReminder()" style="margin-top: 10px;">
        <i class="fas fa-bell"></i> Test Reminder
      </button>
    </div>

    <div class="card">
      <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;"><i class="fas fa-download" style="color: var(--accent); margin-right: 10px;"></i>Data Management</h3>
      
      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button class="btn-small" onclick="exportData()">
          <i class="fas fa-file-export"></i> Export Data
        </button>
        <button class="btn-small btn-secondary" onclick="importData()">
          <i class="fas fa-file-import"></i> Import Data
        </button>
        <button class="btn-small" onclick="resetData()" style="background: var(--danger);">
          <i class="fas fa-trash"></i> Reset All
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Navigation -->
<div class="nav">
  <div class="nav-item active" onclick="showScreen('dashboard')">
    <i class="fas fa-home"></i>
    <span>Home</span>
  </div>
  <div class="nav-item" onclick="openDrinkModal()">
    <i class="fas fa-plus-circle"></i>
    <span>Add</span>
  </div>
  <div class="nav-item" onclick="showScreen('statsScreen')">
    <i class="fas fa-chart-bar"></i>
    <span>Stats</span>
  </div>
  <div class="nav-item" onclick="showScreen('profileScreen')">
    <i class="fas fa-cog"></i>
    <span>Settings</span>
  </div>
</div>

<!-- Drink Selection Modal -->
<div class="modal" id="drinkModal">
  <div class="modal-content card">
    <div class="modal-header">
      <h3><i class="fas fa-wine-bottle"></i> Add Drink</h3>
      <button class="close-btn" onclick="closeModal('drinkModal')"><i class="fas fa-times"></i></button>
    </div>

    <div class="drink-grid" id="drinkGrid"></div>
  </div>
</div>

<!-- Amount Selection Modal -->
<div class="modal" id="amountModal">
  <div class="modal-content card">
    <div class="modal-header">
      <h3 id="amountTitle"><i class="fas fa-tint"></i> Select Amount</h3>
      <button class="close-btn" onclick="closeModal('amountModal')"><i class="fas fa-times"></i></button>
    </div>

    <div id="waterContentInfo" style="text-align: center; margin: 15px 0; padding: 15px; background: var(--glass); border-radius: 12px; border: 1px solid var(--glass-border);"></div>

    <div class="amount-grid" id="amountGrid"></div>

    <div style="margin-top: 20px;">
      <input type="number" class="custom-amount" id="customAmount" placeholder="Enter custom amount (ml)" min="1" max="5000">
    </div>

    <button class="btn" onclick="confirmDrink()" style="margin-top: 20px;">
      <i class="fas fa-check"></i> Add Drink
    </button>
  </div>
</div>

<!-- Date Detail Modal -->
<div class="modal" id="dateDetailModal">
  <div class="modal-content card">
    <div class="modal-header">
      <h3><i class="fas fa-calendar-day"></i> Daily Details</h3>
      <button class="close-btn" onclick="closeModal('dateDetailModal')"><i class="fas fa-times"></i></button>
    </div>
    <div id="dateDetailContent">
      <!-- Content will be populated by JavaScript -->
    </div>
    <button class="btn-secondary" onclick="closeModal('dateDetailModal')" style="margin-top: 20px;">
      Close
    </button>
  </div>
</div>

<!-- Achievements Modal -->
<div class="modal" id="achievementsModal">
  <div class="modal-content card">
    <div class="modal-header">
      <h3><i class="fas fa-trophy"></i> Achievements</h3>
      <button class="close-btn" onclick="closeModal('achievementsModal')"><i class="fas fa-times"></i></button>
    </div>
    <div id="achievementsContent" style="margin: 20px 0;">
      <!-- Achievements will be populated here -->
    </div>
    <button class="btn-secondary" onclick="closeModal('achievementsModal')" style="margin-top: 20px;">
      Close
    </button>
  </div>
</div>

<!-- Welcome Modal for New Users -->
<div class="modal welcome-modal" id="welcomeModal">
  <div class="modal-content card">
    <div class="modal-header">
      <h3><i class="fas fa-glass-water"></i> Welcome to Waterify Pro!</h3>
    </div>
    <div style="text-align: center; padding: 20px;">
      <i class="fas fa-tint" style="font-size: 64px; color: var(--accent); margin-bottom: 20px;"></i>
      <h3 style="margin: 0 0 10px 0;">Let's Set Up Your Profile</h3>
      <p style="color: var(--muted); margin-bottom: 30px;">To provide accurate hydration recommendations, we need some information about you.</p>
      <button class="btn" onclick="closeModal('welcomeModal'); openProfile();">
        <i class="fas fa-user-cog"></i> Set Up Profile
      </button>
    </div>
  </div>
</div>

<!-- Notification -->
<div id="notification" class="notification">
  <i class="fas fa-check-circle"></i> <span id="notificationText">Drink added successfully!</span>
</div>

<!-- Import Data Input (Hidden) -->
<input type="file" id="importFile" accept=".json" style="display: none;">

<script>
// ============================================
// FIXED: updateTimeProgress function - Correct 24-hour coverage with proper labels
// ============================================

function updateTimeProgress() {
  const container = document.getElementById('timeProgress');
  const timeSlots = [
    { label: "12-3AM", hour: 0, isNight: true },
    { label: "3-6AM", hour: 3, isNight: true },
    { label: "6-9AM", hour: 6 },
    { label: "9-12", hour: 9 },
    { label: "12-3PM", hour: 12 },
    { label: "3-6PM", hour: 15 },
    { label: "6-9PM", hour: 18, isNight: true },
    { label: "9-12PM", hour: 21, isNight: true }
  ];
  
  const currentHour = new Date().getHours();
  
  container.innerHTML = '';
  
  timeSlots.forEach(slot => {
    const div = document.createElement('div');
    div.className = 'time-slot';
    
    if (slot.isNight) {
      div.classList.add('night');
    }
    
    // Check if current hour is in this time slot
    let isActive = false;
    const slotStart = slot.hour;
    const slotEnd = slot.hour + 3;
    
    if (slot.label === "9-12PM") {
      // Special case: 9 PM to midnight (21:00 to 24:00)
      isActive = currentHour >= 21 && currentHour < 24;
    } else {
      isActive = currentHour >= slotStart && currentHour < slotEnd;
    }
    
    if (isActive) {
      div.classList.add('active');
    }
    
    // Calculate drinks in this time slot
    const drinksInSlot = appState.todayData?.drinks?.filter(drink => {
      const drinkHour = new Date(drink.timestamp).getHours();
      
      if (slot.label === "9-12PM") {
        // 9 PM to midnight (21:00 to 24:00)
        return drinkHour >= 21 && drinkHour < 24;
      } else {
        return drinkHour >= slotStart && drinkHour < slotEnd;
      }
    }) || [];
    
    const totalInSlot = drinksInSlot.reduce((sum, drink) => sum + drink.amount, 0);
    
    div.innerHTML = `
      <div class="time-label">${slot.label}</div>
      <div class="time-value">${totalInSlot}ml</div>
    `;
    
    container.appendChild(div);
  });
}

// ============================================
// FIXED: showDateDetails function - Properly check both todayData and historicalData
// ============================================

function showDateDetails(dateStr, dayData) {
  const modal = document.getElementById('dateDetailModal');
  const content = document.getElementById('dateDetailContent');
  
  const date = new Date(dateStr);
  const formattedDate = date.toLocaleDateString('en-US', { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
  
  // Check if this is today's date
  const todayStr = new Date().toDateString();
  const isToday = dateStr === todayStr;
  
  // Get the correct data (either from todayData or historicalData)
  let dayDataToShow = dayData;
  if (isToday && appState.todayData) {
    dayDataToShow = appState.todayData;
  }
  
  if (dayDataToShow && (dayDataToShow.drinks || dayDataToShow.consumed > 0)) {
    const goal = appState.profile?.dailyGoal || 2000;
    const progress = Math.round((dayDataToShow.consumed / goal) * 100);
    const drinksCount = dayDataToShow.drinks ? dayDataToShow.drinks.length : 0;
    
    let drinksHtml = '';
    if (dayDataToShow.drinks && dayDataToShow.drinks.length > 0) {
      drinksHtml = '<div style="margin-top: 15px;"><strong style="display: block; margin-bottom: 10px;">Drinks:</strong><div style="max-height: 200px; overflow-y: auto; padding-right: 10px;">';
      dayDataToShow.drinks.forEach((drink, index) => {
        const beverage = BEVERAGES[drink.type];
        drinksHtml += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; position: relative;" class="drink-item-with-remove">
            ${!isToday ? `<button class="remove-drink-btn" onclick="removeHistoricalDrink('${dateStr}', ${index})" title="Remove this drink" style="opacity: 0.7;">
              <i class="fas fa-times"></i>
            </button>` : ''}
            <div style="display: flex; align-items: center; gap: 10px;">
              <i class="fas ${beverage.icon}" style="color: ${beverage.color};"></i>
              <div>
                <div style="font-weight: 600; font-size: 13px;">${beverage.name}</div>
                <div style="font-size: 11px; color: var(--muted);">${drink.time}</div>
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: 700; font-size: 14px;">${drink.amount}ml</div>
              <div style="font-size: 10px; color: var(--accent);">${drink.waterContent}ml water</div>
            </div>
          </div>
        `;
      });
      drinksHtml += '</div></div>';
    }
    
    content.innerHTML = `
      <h4 style="margin: 0 0 15px 0; color: var(--accent);">${formattedDate}</h4>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
        <div style="text-align: center; padding: 15px; background: var(--glass); border-radius: 12px;">
          <div style="font-size: 24px; font-weight: 700; color: var(--accent);">${dayDataToShow.consumed}ml</div>
          <div style="font-size: 12px; color: var(--muted);">Total Consumed</div>
        </div>
        <div style="text-align: center; padding: 15px; background: var(--glass); border-radius: 12px;">
          <div style="font-size: 24px; font-weight: 700; color: ${progress >= 100 ? 'var(--success)' : progress >= 75 ? '#a6ff4d' : progress >= 50 ? 'var(--warning)' : '#ff9966'};">${progress}%</div>
          <div style="font-size: 12px; color: var(--muted);">Goal Progress</div>
        </div>
        <div style="text-align: center; padding: 15px; background: var(--glass); border-radius: 12px;">
          <div style="font-size: 24px; font-weight: 700; color: var(--accent);">${drinksCount}</div>
          <div style="font-size: 12px; color: var(--muted);">Number of Drinks</div>
        </div>
        <div style="text-align: center; padding: 15px; background: var(--glass); border-radius: 12px;">
          <div style="font-size: 24px; font-weight: 700; color: ${dayDataToShow.completed ? 'var(--success)' : 'var(--danger)'};">${dayDataToShow.completed ? '' : ''}</div>
          <div style="font-size: 12px; color: var(--muted);">Goal ${dayDataToShow.completed ? 'Achieved' : 'Not Met'}</div>
        </div>
      </div>
      ${drinksHtml}
    `;
  } else {
    content.innerHTML = `
      <h4 style="margin: 0 0 15px 0; color: var(--accent);">${formattedDate}</h4>
      <div style="text-align: center; padding: 40px 20px;">
        <i class="fas fa-tint" style="font-size: 48px; color: var(--muted); opacity: 0.5; margin-bottom: 20px;"></i>
        <p style="color: var(--muted);">No hydration data recorded for this day.</p>
      </div>
    `;
  }
  
  openModal('dateDetailModal');
}

// ============================================
// FIXED: updateDistributionChart function - Proper initialization
// ============================================

function updateDistributionChart() {
  if (!distributionChart) return;
  
  const drinkTypes = {};
  let drinks = [];
  
  if (appState.currentPieType === 'today') {
    drinks = appState.todayData?.drinks || [];
  } else if (appState.currentPieType === 'week') {
    const last7Days = getLastNDays(7);
    drinks = last7Days.flatMap(day => day?.drinks || []);
  } else if (appState.currentPieType === 'month') {
    const last30Days = getLastNDays(30);
    drinks = last30Days.flatMap(day => day?.drinks || []);
  }
  
  // Initialize all drink types with 0
  Object.keys(BEVERAGES).forEach(type => {
    drinkTypes[type] = 0;
  });
  
  // Count drinks
  drinks.forEach(drink => {
    drinkTypes[drink.type] = (drinkTypes[drink.type] || 0) + drink.amount;
  });
  
  // Filter out drink types with 0 amount
  const filteredDrinkTypes = Object.entries(drinkTypes)
    .filter(([type, amount]) => amount > 0);
  
  // If no drinks, show empty state
  if (filteredDrinkTypes.length === 0) {
    distributionChart.data.labels = ['No drinks recorded'];
    distributionChart.data.datasets[0].data = [1];
    distributionChart.data.datasets[0].backgroundColor = ['rgba(255, 255, 255, 0.1)'];
    distributionChart.update();
    return;
  }
  
  const labels = filteredDrinkTypes.map(([type, amount]) => BEVERAGES[type]?.name || type);
  const data = filteredDrinkTypes.map(([type, amount]) => amount);
  const colors = filteredDrinkTypes.map(([type, amount]) => BEVERAGES[type]?.color || '#4fd1ff');
  
  distributionChart.data.labels = labels;
  distributionChart.data.datasets[0].data = data;
  distributionChart.data.datasets[0].backgroundColor = colors;
  
  distributionChart.update();
}

// ============================================
// FIXED: openStats function - Ensure charts are properly initialized
// ============================================

function openStats() {
  showScreen('statsScreen');
  updateStatistics();
  renderCalendar();
  
  // Initialize charts if they don't exist
  if (!trendChart || !distributionChart) {
    initializeCharts();
  } else {
    updateCharts();
  }
  
  // Force update of distribution chart
  setTimeout(() => {
    updateDistributionChart();
  }, 50);
}

// ============================================
// FIXED: renderCalendar function - Check both todayData and historicalData
// ============================================

function renderCalendar() {
  const container = document.getElementById('calendarContainer');
  const month = appState.currentMonth;
  const year = appState.currentYear;
  
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
  
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  container.innerHTML = '';
  
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  dayNames.forEach(day => {
    const dayElement = document.createElement('div');
    dayElement.style.cssText = `
      text-align: center;
      padding: 8px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
    `;
    dayElement.textContent = day;
    container.appendChild(dayElement);
  });
  
  for (let i = 0; i < firstDay; i++) {
    const empty = document.createElement('div');
    container.appendChild(empty);
  }
  
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    const dateStr = date.toDateString();
    const todayStr = new Date().toDateString();
    
    // Check if this is today to use todayData instead of historicalData
    let dayData = appState.historicalData[dateStr];
    if (dateStr === todayStr && appState.todayData) {
      dayData = appState.todayData;
    }
    
    const dayElement = document.createElement('div');
    dayElement.style.cssText = `
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      background: var(--glass);
      border: 1px solid var(--glass-border);
    `;
    
    dayElement.textContent = day;
    dayElement.dataset.date = dateStr;
    
    if (dayData && (dayData.drinks || dayData.consumed > 0)) {
      const goal = appState.profile?.dailyGoal || 2000;
      const progress = Math.min((dayData.consumed / goal) * 100, 100);
      
      if (progress >= 100) {
        dayElement.style.background = `linear-gradient(135deg, var(--success), rgba(77, 255, 184, 0.3))`;
        dayElement.style.borderColor = 'var(--success)';
      } else if (progress >= 75) {
        dayElement.style.background = `linear-gradient(135deg, #a6ff4d, rgba(166, 255, 77, 0.3))`;
      } else if (progress >= 50) {
        dayElement.style.background = `linear-gradient(135deg, var(--warning), rgba(255, 184, 77, 0.3))`;
      } else if (progress > 0) {
        dayElement.style.background = `linear-gradient(135deg, #ff9966, rgba(255, 153, 102, 0.3))`;
      }
      
      if (dayData.completed) {
        dayElement.style.border = '2px solid var(--accent)';
      }
      
      dayElement.onclick = () => showDateDetails(dateStr, dayData);
    } else {
      dayElement.onclick = () => showDateDetails(dateStr, null);
    }
    
    if (date.toDateString() === new Date().toDateString()) {
      dayElement.style.boxShadow = '0 0 0 2px var(--accent)';
      dayElement.style.fontWeight = '700';
    }
    
    if (dayData && (dayData.drinks || dayData.consumed > 0)) {
      const goal = appState.profile?.dailyGoal || 2000;
      const progress = Math.round((dayData.consumed / goal) * 100);
      dayElement.title = `${dayData.consumed}ml (${progress}%)`;
    } else {
      dayElement.title = 'No data';
    }
    
    container.appendChild(dayElement);
  }
}

// ============================================
// NEW: ACHIEVEMENT ANIMATION FUNCTIONS
// ============================================

function showAchievementUnlock(achievement) {
  // Create confetti effect
  createConfetti();
  
  // Create beautiful achievement notification
  const notification = document.createElement('div');
  notification.className = 'achievement-notification';
  notification.innerHTML = `
    <i class="fas ${achievement.icon}"></i>
    <div style="font-size: 18px; font-weight: 700; margin-bottom: 5px;">Achievement Unlocked!</div>
    <div style="font-size: 16px; margin-bottom: 5px;">${achievement.name}</div>
    <div style="font-size: 12px; opacity: 0.9;">${achievement.description}</div>
    <div style="font-size: 11px; margin-top: 8px; opacity: 0.7;">${new Date().toLocaleDateString()}</div>
  `;
  
  document.body.appendChild(notification);
  
  // Remove notification after 4 seconds
  setTimeout(() => {
    notification.style.transition = 'transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.5s';
    notification.style.transform = 'translateX(-50%) translateY(-100px)';
    notification.style.opacity = '0';
    
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 500);
  }, 4000);
}

function createConfetti() {
  const colors = ['#4fd1ff', '#6b7cff', '#8b5cf6', '#ffb84d', '#4dffb8'];
  
  for (let i = 0; i < 50; i++) {
    setTimeout(() => {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = `${Math.random() * 100}%`;
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.width = `${Math.random() * 10 + 5}px`;
      confetti.style.height = `${Math.random() * 10 + 5}px`;
      confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
      confetti.style.animation = `confettiRain ${Math.random() * 2 + 1}s linear forwards`;
      
      document.body.appendChild(confetti);
      
      setTimeout(() => {
        if (confetti.parentNode) {
          confetti.parentNode.removeChild(confetti);
        }
      }, 2000);
    }, i * 20);
  }
}

// ============================================
// UPDATED: checkAndUpdateAchievements function with animations
// ============================================

function checkAndUpdateAchievements() {
  if (!appState.profile) return;
  
  const achievements = appState.profile.achievements || {};
  let newAchievements = [];
  
  ACHIEVEMENTS.forEach(achievement => {
    if (!achievements[achievement.id] || !achievements[achievement.id].unlocked) {
      if (achievement.condition(appState.profile, appState.todayData, appState.historicalData)) {
        if (!achievements[achievement.id]) {
          achievements[achievement.id] = {
            unlocked: true,
            unlockedAt: new Date().toISOString()
          };
          newAchievements.push(achievement);
        }
      }
    }
  });
  
  appState.profile.achievements = achievements;
  
  // Show beautiful animations for new achievements
  if (newAchievements.length > 0) {
    // Show first achievement immediately
    showAchievementUnlock(newAchievements[0]);
    
    // Show remaining achievements with delay
    for (let i = 1; i < newAchievements.length; i++) {
      setTimeout(() => {
        showAchievementUnlock(newAchievements[i]);
      }, i * 4500); // Stagger achievements
    }
    
    saveAllData();
  }
}

// ============================================
// NEW: DRINK REMOVAL FUNCTIONALITY
// ============================================

function removeDrink(drinkIndex, fromHistory = false, date = null) {
  if (!appState.todayData || !appState.todayData.drinks) return;
  
  const drinks = appState.todayData.drinks;
  
  if (drinkIndex >= 0 && drinkIndex < drinks.length) {
    const removedDrink = drinks[drinkIndex];
    const beverage = BEVERAGES[removedDrink.type];
    
    // Subtract the water content from total consumed
    appState.todayData.consumed = Math.max(0, appState.todayData.consumed - removedDrink.waterContent);
    
    // Remove the drink
    drinks.splice(drinkIndex, 1);
    
    // Re-check if goal is still completed
    appState.todayData.completed = appState.todayData.consumed >= appState.todayData.goal;
    
    // Save changes
    saveAllData();
    
    // Update UI
    updateDashboard();
    updateRecentActivity();
    updateTimeProgress();
    updateStatistics();
    
    // Show notification
    showNotification(`Removed ${removedDrink.amount}ml of ${beverage.name}`, "success");
  }
}

function removeHistoricalDrink(dateStr, drinkIndex) {
  if (!appState.historicalData[dateStr] || !appState.historicalData[dateStr].drinks) return;
  
  const dayData = appState.historicalData[dateStr];
  const drinks = dayData.drinks;
  
  if (drinkIndex >= 0 && drinkIndex < drinks.length) {
    const removedDrink = drinks[drinkIndex];
    
    // Subtract the water content
    dayData.consumed = Math.max(0, dayData.consumed - removedDrink.waterContent);
    
    // Re-check completion
    const goal = appState.profile?.dailyGoal || 2000;
    dayData.completed = dayData.consumed >= goal;
    
    // Remove the drink
    drinks.splice(drinkIndex, 1);
    
    // If no drinks left, remove the drinks array
    if (drinks.length === 0) {
      delete dayData.drinks;
    }
    
    saveAllData();
    updateStatistics();
    
    // Refresh the date details if modal is open
    if (document.getElementById('dateDetailModal').style.display === 'flex') {
      showDateDetails(dateStr, dayData);
    }
    
    showNotification("Drink removed from history", "success");
  }
}

// ============================================
// UPDATED: updateRecentActivity function with remove buttons
// ============================================

function updateRecentActivity() {
  const container = document.getElementById('recentActivity');
  if (!appState.todayData?.drinks) return;
  
  const recentDrinks = appState.todayData.drinks.slice(-5).reverse();
  
  if (recentDrinks.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 20px; color: var(--muted);">
        <i class="fas fa-tint" style="font-size: 24px; margin-bottom: 10px; display: block; opacity: 0.5;"></i>
        No drinks added yet today
      </div>
    `;
    return;
  }
  
  container.innerHTML = '';
  recentDrinks.forEach((drink, index) => {
    const beverage = BEVERAGES[drink.type];
    if (!beverage) return;
    
    // Calculate original index (since we reversed the array)
    const originalIndex = appState.todayData.drinks.length - 1 - index;
    
    const item = document.createElement('div');
    item.className = 'drink-item-with-remove';
    item.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      margin-bottom: 8px;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      transition: all 0.3s ease;
      position: relative;
    `;
    
    item.innerHTML = `
      <button class="remove-drink-btn" onclick="removeDrink(${originalIndex})" title="Remove this drink">
        <i class="fas fa-times"></i>
      </button>
      <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
        <i class="fas ${beverage.icon}" style="color: ${beverage.color}; font-size: 20px;"></i>
        <div style="flex: 1;">
          <div style="font-weight: 600; font-size: 14px;">${beverage.name}</div>
          <div style="font-size: 12px; color: var(--muted);">${drink.time}</div>
        </div>
      </div>
      <div style="text-align: right;">
        <div style="font-weight: 700; font-size: 16px;">${drink.amount}ml</div>
        <div style="font-size: 11px; color: var(--accent);">${drink.waterContent}ml water</div>
      </div>
    `;
    
    container.appendChild(item);
  });
}

// ============================================
// MAIN APP CODE
// ============================================

const BEVERAGES = {
  water: {
    name: "Water",
    icon: "fa-tint",
    color: "#4fd1ff",
    waterContent: 100,
    description: "Pure hydration - no additives"
  },
  sparkling_water: {
    name: "Sparkling Water",
    icon: "fa-glass-water",
    color: "#6b7cff",
    waterContent: 100,
    description: "Carbonated water - same hydration"
  },
  herbal_tea: {
    name: "Herbal Tea",
    icon: "fa-mug-hot",
    color: "#ffb84d",
    waterContent: 99,
    description: "No caffeine - excellent hydration"
  },
  green_tea: {
    name: "Green Tea",
    icon: "fa-leaf",
    color: "#4dff88",
    waterContent: 99,
    description: "Antioxidants - minimal caffeine"
  },
  black_coffee: {
    name: "Black Coffee",
    icon: "fa-coffee",
    color: "#8B4513",
    waterContent: 98,
    description: "Caffeine reduces hydration by 15%"
  },
  milk: {
    name: "Milk",
    icon: "fa-cow",
    color: "#ffffff",
    waterContent: 87,
    description: "Contains nutrients - good hydration"
  },
  fruit_juice: {
    name: "Fruit Juice",
    icon: "fa-apple-alt",
    color: "#ff6b6b",
    waterContent: 88,
    description: "Natural sugars - moderate hydration"
  },
  sports_drink: {
    name: "Sports Drink",
    icon: "fa-bolt",
    color: "#ff4d6d",
    waterContent: 94,
    description: "Electrolytes - good for exercise"
  },
  soda: {
    name: "Soda",
    icon: "fa-glass-whiskey",
    color: "#ff4757",
    waterContent: 90,
    description: "High sugar - poor hydration"
  },
  smoothie: {
    name: "Smoothie",
    icon: "fa-blender",
    color: "#9d4edd",
    waterContent: 85,
    description: "Nutrient-rich - good hydration"
  }
};

const ACHIEVEMENTS = [
  {
    id: 'first_drink',
    name: 'First Sip',
    description: 'Added your first drink',
    icon: 'fa-tint',
    condition: (profile, todayData, historicalData) => {
      const totalDrinks = (todayData?.drinks?.length || 0) + 
                         Object.values(historicalData).reduce((sum, day) => sum + (day.drinks?.length || 0), 0);
      return totalDrinks >= 1;
    }
  },
  {
    id: 'first_streak',
    name: 'Streak Starter',
    description: 'Achieved a 3-day streak',
    icon: 'fa-fire',
    condition: (profile) => profile.currentStreak >= 3
  },
  {
    id: 'hydrated_beginner',
    name: 'Hydration Beginner',
    description: 'Reached daily goal for first time',
    icon: 'fa-star',
    condition: (profile, todayData, historicalData) => {
      const completedDays = Object.values(historicalData).filter(d => d.completed).length;
      return completedDays >= 1;
    }
  },
  {
    id: 'week_warrior',
    name: 'Week Warrior',
    description: 'Completed a full week of hydration',
    icon: 'fa-calendar-week',
    condition: (profile, todayData, historicalData) => {
      const last7Days = getLastNDaysData(7);
      const completedDays = last7Days.filter(d => d?.completed).length;
      return completedDays >= 7;
    }
  },
  {
    id: 'month_master',
    name: 'Month Master',
    description: 'Completed 30 days of hydration',
    icon: 'fa-calendar-alt',
    condition: (profile, todayData, historicalData) => {
      const completedDays = Object.values(historicalData).filter(d => d.completed).length;
      return completedDays >= 30;
    }
  },
  {
    id: 'water_expert',
    name: 'Water Expert',
    description: 'Drank 3L in a single day',
    icon: 'fa-water',
    condition: (profile, todayData, historicalData) => {
      const allDays = [todayData, ...Object.values(historicalData)];
      return allDays.some(d => d && d.consumed >= 3000);
    }
  },
  {
    id: 'consistency_king',
    name: 'Consistency King',
    description: 'Maintained a 7-day streak',
    icon: 'fa-crown',
    condition: (profile) => profile.bestStreak >= 7
  },
  {
    id: 'legendary_hydrator',
    name: 'Legendary Hydrator',
    description: 'Maintained a 30-day streak',
    icon: 'fa-trophy',
    condition: (profile) => profile.bestStreak >= 30
  },
  {
    id: 'variety_seeker',
    name: 'Variety Seeker',
    description: 'Tried 5 different drink types',
    icon: 'fa-glass-whiskey',
    condition: (profile, todayData, historicalData) => {
      const allDrinks = [...(todayData?.drinks || []), 
                        ...Object.values(historicalData).flatMap(d => d.drinks || [])];
      const uniqueTypes = new Set(allDrinks.map(d => d.type));
      return uniqueTypes.size >= 5;
    }
  },
  {
    id: 'early_bird',
    name: 'Early Bird',
    description: 'Drank before 8 AM for 5 days',
    icon: 'fa-sun',
    condition: (profile, todayData, historicalData) => {
      const earlyDrinks = [...(todayData?.drinks || []), 
                          ...Object.values(historicalData).flatMap(d => d.drinks || [])];
      const earlyDays = new Set();
      earlyDrinks.forEach(drink => {
        const hour = new Date(drink.timestamp).getHours();
        if (hour < 8) {
          const date = new Date(drink.timestamp).toDateString();
          earlyDays.add(date);
        }
      });
      return earlyDays.size >= 5;
    }
  }
];

const HYDRATION_TIPS = [
  "Start your day with a glass of water to kickstart metabolism",
  "Drink water 30 minutes before meals for better digestion",
  "Your body is about 60% water - keep it replenished!",
  "Dehydration can reduce cognitive performance by up to 30%",
  "Carry a reusable water bottle to stay hydrated on the go",
  "Eat water-rich foods like watermelon, cucumber, and oranges",
  "Listen to your body - thirst is a sign you're already dehydrated",
  "Alcohol and caffeine can dehydrate you - balance with water",
  "Stay hydrated during exercise to maintain performance",
  "Proper hydration helps regulate body temperature"
];

const ACTIVITY_LEVELS = {
  sedentary: 1.0,
  light: 1.2,
  moderate: 1.4,
  active: 1.6,
  athlete: 1.8
};

let appState = {
  profile: null,
  todayData: null,
  historicalData: {},
  settings: {},
  selectedDrink: null,
  selectedAmount: 250,
  currentChartType: 'weekly',
  currentPieType: 'today',
  currentMonth: new Date().getMonth(),
  currentYear: new Date().getFullYear(),
  dataVersion: 5,
  unitSystem: 'metric'
};

let trendChart = null;
let distributionChart = null;

function addDrink(type, amount) {
  const drink = BEVERAGES[type];
  if (!drink) return;
  
  const waterContent = Math.round(amount * drink.waterContent / 100);
  
  const drinkRecord = {
    type,
    amount,
    waterContent,
    timestamp: new Date().toISOString(),
    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
  };
  
  appState.todayData.consumed += waterContent;
  if (!appState.todayData.drinks) appState.todayData.drinks = [];
  appState.todayData.drinks.push(drinkRecord);
  
  if (!appState.todayData.completed && appState.todayData.consumed >= appState.todayData.goal) {
    appState.todayData.completed = true;
    showNotification(" Daily goal achieved! Great work!", "success");
  }
  
  checkAndUpdateAchievements();
  
  saveAllData();
  updateDashboard();
  updateStatistics();
  updateTimeProgress();
  showNotification(`Added ${amount}ml of ${drink.name} (${waterContent}ml water)`, "success");
}

function initializeApp() {
  loadAllData();
  
  const isNewUser = !appState.profile || !appState.profile.name || appState.profile.name === "User";
  
  if (!appState.profile) {
    appState.profile = {
      name: "User",
      weight: 70,
      height: 170,
      age: 25,
      gender: "male",
      activityLevel: "moderate",
      dailyGoal: 2000,
      createdAt: new Date().toISOString(),
      currentStreak: 0,
      bestStreak: 0,
      unitSystem: 'metric',
      achievements: {}
    };
  }
  
  appState.unitSystem = appState.profile.unitSystem || 'metric';
  
  const today = new Date().toDateString();
  const todayData = JSON.parse(localStorage.getItem('waterify_today'));
  
  if (!todayData || todayData.date !== today) {
    checkAndUpdateStreak();
    
    if (todayData && todayData.date !== today) {
      appState.historicalData[todayData.date] = todayData;
      saveAllData();
    }
    
    appState.todayData = {
      date: today,
      consumed: 0,
      drinks: [],
      goal: appState.profile.dailyGoal,
      completed: false
    };
  } else {
    appState.todayData = todayData;
  }
  
  if (!appState.settings.reminders) {
    appState.settings = {
      reminders: {
        enabled: true,
        frequency: 2,
        time: "09:00"
      }
    };
  }
  
  // FIX: Ensure current month/year are set correctly
  const now = new Date();
  appState.currentMonth = now.getMonth();
  appState.currentYear = now.getFullYear();
  
  updateDashboard();
  updateProfileUI();
  updateTimeProgress();
  setupReminders();
  updateGreetingMessage();
  
  setTimeout(() => {
    if (typeof Chart !== 'undefined') {
      initializeCharts();
    }
  }, 100);
  
  createWaterDrops();
  checkAndUpdateAchievements();
  
  if (isNewUser) {
    setTimeout(() => {
      openModal('welcomeModal');
    }, 500);
  }
}

function loadAllData() {
  try {
    appState.profile = JSON.parse(localStorage.getItem('waterify_profile')) || null;
    
    const todayData = JSON.parse(localStorage.getItem('waterify_today'));
    const today = new Date().toDateString();
    
    if (todayData && todayData.date === today) {
      appState.todayData = todayData;
    }
    
    appState.historicalData = JSON.parse(localStorage.getItem('waterify_history')) || {};
    appState.settings = JSON.parse(localStorage.getItem('waterify_settings')) || {};
  } catch (e) {
    console.error('Error loading data:', e);
    appState.profile = null;
    appState.todayData = null;
    appState.historicalData = {};
    appState.settings = {};
  }
}

function saveAllData() {
  try {
    localStorage.setItem('waterify_profile', JSON.stringify(appState.profile));
    localStorage.setItem('waterify_today', JSON.stringify(appState.todayData));
    localStorage.setItem('waterify_history', JSON.stringify(appState.historicalData));
    localStorage.setItem('waterify_settings', JSON.stringify(appState.settings));
    localStorage.setItem('waterify_version', '5');
  } catch (e) {
    console.error('Error saving data:', e);
  }
}

function setWeightUnit(system) {
  appState.unitSystem = system;
  appState.profile.unitSystem = system;
  
  document.querySelectorAll('.unit-conversion-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.unit === system);
  });
  
  if (system === 'metric') {
    document.getElementById('weightLabel').textContent = 'Weight (kg)';
    document.getElementById('heightLabel').textContent = 'Height (cm)';
    document.getElementById('weightUnit').textContent = 'kg';
    document.getElementById('heightUnit').textContent = 'cm';
    
    if (appState.profile.weight > 200) {
      appState.profile.weight = Math.round(appState.profile.weight / 2.20462);
    }
    if (appState.profile.height > 84) {
      appState.profile.height = Math.round(appState.profile.height * 2.54);
    }
    
    document.getElementById('weightValue').textContent = appState.profile.weight;
    document.getElementById('heightValue').textContent = appState.profile.height;
    document.getElementById('weightInput').value = appState.profile.weight;
    document.getElementById('heightInput').value = appState.profile.height;
    
    initRuler('weightRuler', 30, 200, appState.profile.weight, 'kg', (value) => {
      appState.profile.weight = value;
      document.getElementById('weightValue').textContent = value;
      document.getElementById('weightInput').value = value;
    });
    
    initRuler('heightRuler', 100, 250, appState.profile.height, 'cm', (value) => {
      appState.profile.height = value;
      document.getElementById('heightValue').textContent = value;
      document.getElementById('heightInput').value = value;
    });
    
  } else {
    document.getElementById('weightLabel').textContent = 'Weight (lbs)';
    document.getElementById('heightLabel').textContent = 'Height (in)';
    document.getElementById('weightUnit').textContent = 'lbs';
    document.getElementById('heightUnit').textContent = 'in';
    
    const weightLbs = Math.round(appState.profile.weight * 2.20462);
    const heightIn = Math.round(appState.profile.height / 2.54);
    
    document.getElementById('weightValue').textContent = weightLbs;
    document.getElementById('heightValue').textContent = heightIn;
    document.getElementById('weightInput').value = weightLbs;
    document.getElementById('heightInput').value = heightIn;
    
    initRuler('weightRuler', 66, 440, weightLbs, 'lbs', (value) => {
      appState.profile.weight = Math.round(value / 2.20462);
      document.getElementById('weightValue').textContent = value;
      document.getElementById('weightInput').value = value;
    });
    
    initRuler('heightRuler', 39, 98, heightIn, 'in', (value) => {
      appState.profile.height = Math.round(value * 2.54);
      document.getElementById('heightValue').textContent = value;
      document.getElementById('heightInput').value = value;
    });
  }
  
  calculateRecommendedGoal();
}

function initRuler(containerId, min, max, initial, unit, onChange) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  
  for (let i = min; i <= max; i++) {
    const tick = document.createElement('div');
    tick.className = 'ruler-tick';
    tick.dataset.value = i;
    
    const isMajor = i % 5 === 0;
    const lineHeight = isMajor ? 40 : 20;
    
    tick.innerHTML = `
      <div class="tick-line" style="height: ${lineHeight}px;"></div>
      ${isMajor ? `<div class="tick-label">${i}${unit}</div>` : ''}
    `;
    
    if (i === initial) {
      tick.classList.add('active');
    }
    
    container.appendChild(tick);
  }
  
  let scrollTimeout;
  container.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      const center = container.scrollLeft + container.clientWidth / 2;
      const ticks = Array.from(container.children);
      let closestTick = null;
      let closestDistance = Infinity;
      
      ticks.forEach(tick => {
        const tickCenter = tick.offsetLeft + tick.offsetWidth / 2;
        const distance = Math.abs(tickCenter - center);
        
        if (distance < closestDistance) {
          closestDistance = distance;
          closestTick = tick;
        }
      });
      
      if (closestTick) {
        const value = parseInt(closestTick.dataset.value);
        onChange(value);
        
        ticks.forEach(t => t.classList.remove('active'));
        closestTick.classList.add('active');
        
        if (navigator.vibrate) {
          navigator.vibrate(10);
        }
      }
    }, 150);
  });
  
  setTimeout(() => {
    const tickWidth = 40;
    const centerOffset = container.clientWidth / 2;
    const targetTick = Array.from(container.children).find(t => parseInt(t.dataset.value) === initial);
    if (targetTick) {
      const tickIndex = Array.from(container.children).indexOf(targetTick);
      container.scrollLeft = (tickIndex * tickWidth) - centerOffset + (tickWidth / 2);
    }
  }, 100);
}

function selectGender(gender) {
  if (!appState.profile) return;
  appState.profile.gender = gender;
  
  document.querySelectorAll('.gender-option').forEach(option => {
    option.classList.remove('active');
    if (option.dataset.gender === gender) {
      option.classList.add('active');
    }
  });
  
  saveAllData();
}

function selectActivityLevel(level) {
  if (!appState.profile) return;
  appState.profile.activityLevel = level;
  
  document.querySelectorAll('.activity-level').forEach(item => {
    item.classList.remove('active');
    if (item.dataset.level === level) {
      item.classList.add('active');
    }
  });
}

function calculateRecommendedGoal() {
  if (!appState.profile) return;
  
  let weightKg = appState.profile.weight;
  if (appState.unitSystem === 'imperial') {
    weightKg = weightKg / 2.20462;
  }
  
  let heightCm = appState.profile.height;
  if (appState.unitSystem === 'imperial') {
    heightCm = heightCm * 2.54;
  }
  
  let baseGoal;
  if (appState.profile.gender === 'male') {
    baseGoal = weightKg * 35;
  } else if (appState.profile.gender === 'female') {
    baseGoal = weightKg * 31;
  } else {
    baseGoal = weightKg * 33;
  }
  
  const heightFactor = heightCm / 170;
  baseGoal *= heightFactor;
  
  if (appState.profile.age < 18) {
    baseGoal *= 1.1;
  } else if (appState.profile.age > 50) {
    baseGoal *= 0.95;
  }
  
  const activityMultiplier = ACTIVITY_LEVELS[appState.profile.activityLevel] || 1.0;
  baseGoal *= activityMultiplier;
  
  const roundedGoal = Math.round(baseGoal / 50) * 50;
  const finalGoal = Math.max(1500, Math.min(roundedGoal, 4000));
  
  document.getElementById('dailyGoalInput').value = finalGoal;
  appState.profile.dailyGoal = finalGoal;
  if (appState.todayData) {
    appState.todayData.goal = finalGoal;
  }
  
  showNotification(`Recommended daily goal: ${finalGoal}ml`, "success");
}

function updateGreetingMessage() {
  const hour = new Date().getHours();
  let greeting = "Stay Hydrated, Stay Healthy";
  
  if (hour < 12) greeting = "Good morning! Stay hydrated today";
  else if (hour < 18) greeting = "Good afternoon! Keep drinking water";
  else greeting = "Good evening! Finish your hydration goal";
  
  document.getElementById('greetingMessage').textContent = greeting;
}

function createWaterDrops() {
  const container = document.getElementById('waterDropsContainer');
  if (!container) return;
  
  for (let i = 0; i < 15; i++) {
    setTimeout(() => {
      const drop = document.createElement('div');
      drop.className = 'water-drop';
      drop.style.left = `${Math.random() * 100}%`;
      drop.style.animationDelay = `${Math.random() * 2}s`;
      drop.style.width = `${Math.random() * 10 + 5}px`;
      drop.style.height = `${Math.random() * 20 + 10}px`;
      drop.style.opacity = Math.random() * 0.3 + 0.1;
      
      container.appendChild(drop);
      
      setTimeout(() => {
        if (drop.parentNode) {
          drop.parentNode.removeChild(drop);
        }
      }, 1500);
    }, i * 300);
  }
  
  setTimeout(createWaterDrops, 15000);
}

function quickAddDrink(type, amount) {
  addDrink(type, amount);
}

// ============================================
// FIXED: setGoalPercentage function with proper hydration level highlighting
// ============================================

function setGoalPercentage(percentage) {
  const goal = appState.profile.dailyGoal;
  const targetAmount = Math.round((goal * percentage) / 100);
  
  if (appState.todayData.consumed < targetAmount) {
    const needed = targetAmount - appState.todayData.consumed;
    if (needed > 0) {
      addDrink('water', needed);
    }
  }
  
  // Update hydration levels based on current progress
  updateHydrationLevels();
}

// ============================================
// NEW: updateHydrationLevels function to highlight based on current progress
// ============================================

function updateHydrationLevels() {
  if (!appState.todayData || !appState.profile) return;
  
  const consumed = appState.todayData.consumed || 0;
  const goal = appState.todayData.goal || appState.profile.dailyGoal || 2000;
  const progress = Math.min(Math.round((consumed / goal) * 100), 100);
  
  const hydrationLevels = document.querySelectorAll('.hydration-level');
  hydrationLevels.forEach(level => level.classList.remove('active'));
  
  // Determine which level to highlight based on progress
  if (progress >= 87.5) {
    // 87.5% or more = Goal level
    hydrationLevels[4].classList.add('active');
  } else if (progress >= 62.5) {
    // 62.5% to 87.4% = 75% level
    hydrationLevels[3].classList.add('active');
  } else if (progress >= 37.5) {
    // 37.5% to 62.4% = 50% level
    hydrationLevels[2].classList.add('active');
  } else if (progress >= 12.5) {
    // 12.5% to 37.4% = 25% level
    hydrationLevels[1].classList.add('active');
  } else {
    // Less than 12.5% = Low level
    hydrationLevels[0].classList.add('active');
  }
}

function checkAndUpdateStreak() {
  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayStr = yesterday.toDateString();
  
  const yesterdayData = appState.historicalData[yesterdayStr];
  
  if (yesterdayData) {
    if (yesterdayData.completed) {
      appState.profile.currentStreak = (appState.profile.currentStreak || 0) + 1;
      appState.profile.bestStreak = Math.max(appState.profile.bestStreak || 0, appState.profile.currentStreak);
    } else {
      appState.profile.currentStreak = 0;
    }
  }
}

// ============================================
// UPDATED: updateDashboard function with hydration level updates
// ============================================

function updateDashboard() {
  if (!appState.todayData) return;
  
  const consumed = appState.todayData.consumed || 0;
  const goal = appState.todayData.goal || appState.profile?.dailyGoal || 2000;
  const progress = Math.min(Math.round((consumed / goal) * 100), 100);
  
  document.getElementById('progressFill').style.width = `${progress}%`;
  document.getElementById('progressText').textContent = `${progress}%`;
  document.getElementById('waterLevel').style.height = `${progress}%`;
  document.getElementById('consumedDisplay').textContent = `${consumed.toLocaleString()} ml`;
  document.getElementById('goalDisplay').textContent = `of ${goal.toLocaleString()} ml goal`;
  document.getElementById('drinksCount').textContent = appState.todayData.drinks?.length || 0;
  document.getElementById('streakCount').textContent = appState.profile?.currentStreak || 0;
  
  const todayDrinks = appState.todayData.drinks || [];
  const todayBest = todayDrinks.length > 0 ? Math.max(...todayDrinks.map(d => d.amount)) : 0;
  document.getElementById('todayBest').textContent = `${todayBest}ml`;
  
  // Update hydration levels based on current progress
  updateHydrationLevels();
  
  updateQuickStats();
  updateRecentActivity();
  updateHydrationTip();
  
  if (appState.profile?.name) {
    document.getElementById('userName').textContent = appState.profile.name;
  }
}

function updateQuickStats() {
  if (!appState.todayData || !appState.historicalData) return;
  
  const last7Days = getLastNDays(7);
  const daysWithData = last7Days.filter(d => d && d.consumed > 0);
  const weeklyTotal = daysWithData.reduce((sum, day) => sum + (day?.consumed || 0), 0);
  const weekAvg = daysWithData.length > 0 ? Math.round(weeklyTotal / daysWithData.length) : 0;
  document.getElementById('weekAvg').textContent = `${weekAvg}ml`;
  
  const last30Days = getLastNDays(30);
  const monthlyTotal = last30Days.reduce((sum, day) => sum + (day?.consumed || 0), 0);
  document.getElementById('monthTotal').textContent = `${Math.round(monthlyTotal / 1000)}L`;
  
  const goalDays = last30Days.filter(d => d?.completed).length;
  const goalPercent = last30Days.length > 0 ? Math.round((goalDays / last30Days.length) * 100) : 0;
  document.getElementById('goalDays').textContent = `${goalPercent}%`;
  
  document.getElementById('bestStreak').textContent = appState.profile?.bestStreak || 0;
}

function getLastNDays(n) {
  const days = [];
  for (let i = 0; i < n; i++) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const dateStr = date.toDateString();
    days.push(appState.historicalData[dateStr]);
  }
  return days;
}

function getLastNDaysData(n) {
  const days = [];
  for (let i = 0; i < n; i++) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const dateStr = date.toDateString();
    days.push(appState.historicalData[dateStr]);
  }
  return days;
}

function updateHydrationTip() {
  const tip = HYDRATION_TIPS[Math.floor(Math.random() * HYDRATION_TIPS.length)];
  document.getElementById('hydrationTip').textContent = tip;
}

function updateProfileUI() {
  if (!appState.profile) return;
  
  const profile = appState.profile;
  
  document.getElementById('userName').textContent = profile.name || 'Profile';
  document.getElementById('userNameInput').value = profile.name || '';
  document.getElementById('ageValue').textContent = profile.age;
  document.getElementById('ageManualInput').value = profile.age;
  document.getElementById('dailyGoalInput').value = profile.dailyGoal || 2000;
  
  document.getElementById('remindersEnabled').checked = appState.settings.reminders?.enabled || true;
  document.getElementById('reminderTime').value = appState.settings.reminders?.time || "09:00";
  document.getElementById('reminderFrequency').value = appState.settings.reminders?.frequency || 2;
  
  document.querySelectorAll('.gender-option').forEach(option => {
    option.classList.remove('active');
    if (option.dataset.gender === profile.gender) {
      option.classList.add('active');
    }
  });
  
  document.querySelectorAll('.activity-level').forEach(item => {
    item.classList.remove('active');
    if (item.dataset.level === profile.activityLevel) {
      item.classList.add('active');
    }
  });
  
  setWeightUnit(profile.unitSystem || 'metric');
}

function adjustWeight(change) {
  const input = document.getElementById('weightInput');
  let value = parseInt(input.value) + change;
  
  if (appState.unitSystem === 'metric') {
    value = Math.max(30, Math.min(200, value));
  } else {
    value = Math.max(66, Math.min(440, value));
  }
  
  input.value = value;
  appState.profile.weight = value;
  document.getElementById('weightValue').textContent = value;
  updateRuler('weightRuler', value);
}

function adjustHeight(change) {
  const input = document.getElementById('heightInput');
  let value = parseInt(input.value) + change;
  
  if (appState.unitSystem === 'metric') {
    value = Math.max(100, Math.min(250, value));
  } else {
    value = Math.max(39, Math.min(98, value));
  }
  
  input.value = value;
  appState.profile.height = value;
  document.getElementById('heightValue').textContent = value;
  updateRuler('heightRuler', value);
}

function adjustAge(change) {
  const input = document.getElementById('ageManualInput');
  let value = parseInt(input.value) + change;
  value = Math.max(10, Math.min(100, value));
  input.value = value;
  appState.profile.age = value;
  document.getElementById('ageValue').textContent = value;
}

function setAge(age) {
  const input = document.getElementById('ageManualInput');
  input.value = age;
  appState.profile.age = age;
  document.getElementById('ageValue').textContent = age;
}

function updateWeightFromInput() {
  const input = document.getElementById('weightInput');
  let value = parseInt(input.value);
  
  if (appState.unitSystem === 'metric') {
    value = Math.max(30, Math.min(200, value));
  } else {
    value = Math.max(66, Math.min(440, value));
  }
  
  input.value = value;
  appState.profile.weight = value;
  document.getElementById('weightValue').textContent = value;
  updateRuler('weightRuler', value);
}

function updateHeightFromInput() {
  const input = document.getElementById('heightInput');
  let value = parseInt(input.value);
  
  if (appState.unitSystem === 'metric') {
    value = Math.max(100, Math.min(250, value));
  } else {
    value = Math.max(39, Math.min(98, value));
  }
  
  input.value = value;
  appState.profile.height = value;
  document.getElementById('heightValue').textContent = value;
  updateRuler('heightRuler', value);
}

function updateAgeFromInput() {
  const input = document.getElementById('ageManualInput');
  let value = parseInt(input.value);
  value = Math.max(10, Math.min(100, value));
  input.value = value;
  appState.profile.age = value;
  document.getElementById('ageValue').textContent = value;
}

function updateRuler(containerId, value) {
  const container = document.getElementById(containerId);
  Array.from(container.children).forEach(tick => {
    const tickValue = parseInt(tick.dataset.value);
    tick.classList.toggle('active', tickValue === value);
  });
}

function saveProfile() {
  appState.profile.name = document.getElementById('userNameInput').value || 'User';
  appState.profile.weight = parseInt(document.getElementById('weightInput').value);
  appState.profile.height = parseInt(document.getElementById('heightInput').value);
  appState.profile.age = parseInt(document.getElementById('ageManualInput').value);
  appState.profile.dailyGoal = parseInt(document.getElementById('dailyGoalInput').value);
  appState.profile.unitSystem = appState.unitSystem;
  
  const activeGender = document.querySelector('.gender-option.active');
  if (activeGender) {
    appState.profile.gender = activeGender.dataset.gender;
  }
  
  const activeActivity = document.querySelector('.activity-level.active');
  if (activeActivity) {
    appState.profile.activityLevel = activeActivity.dataset.level;
  }
  
  appState.settings.reminders = {
    enabled: document.getElementById('remindersEnabled').checked,
    frequency: parseInt(document.getElementById('reminderFrequency').value),
    time: document.getElementById('reminderTime').value
  };
  
  appState.todayData.goal = appState.profile.dailyGoal;
  
  saveAllData();
  updateDashboard();
  setupReminders();
  
  showNotification("Profile saved successfully!", "success");
  closeProfile();
}

function updateStatistics() {
  const history = appState.historicalData;
  const todayData = appState.todayData;
  
  let allDays = Object.values(history);
  if (todayData && todayData.consumed > 0) {
    allDays = [todayData, ...allDays];
  }
  
  if (allDays.length === 0) {
    document.getElementById('totalConsumed').textContent = '0';
    document.getElementById('avgDaily').textContent = '0';
    document.getElementById('bestDay').textContent = '0';
    document.getElementById('completionRate').textContent = '0%';
    return;
  }
  
  const totalConsumed = allDays.reduce((sum, day) => sum + (day.consumed || 0), 0);
  const avgDaily = Math.round(totalConsumed / allDays.length);
  const bestDay = Math.max(...allDays.map(d => d.consumed || 0));
  const completionRate = Math.round((allDays.filter(d => d.completed).length / allDays.length) * 100);
  
  document.getElementById('totalConsumed').textContent = Math.round(totalConsumed / 1000).toLocaleString() + 'L';
  document.getElementById('avgDaily').textContent = avgDaily.toLocaleString() + 'ml';
  document.getElementById('bestDay').textContent = bestDay.toLocaleString() + 'ml';
  document.getElementById('completionRate').textContent = `${completionRate}%`;
}

function initializeCharts() {
  const trendCtx = document.getElementById('trendChart');
  const distCtx = document.getElementById('distributionChart');
  
  if (!trendCtx || !distCtx) return;
  
  Chart.defaults.color = 'rgba(255, 255, 255, 0.8)';
  Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.2)';
  
  trendChart = new Chart(trendCtx.getContext('2d'), {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Water Intake (ml)',
        data: [],
        borderColor: 'var(--accent)',
        backgroundColor: 'rgba(79, 209, 255, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: 'var(--accent)',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(18, 26, 47, 0.95)',
          titleColor: 'var(--accent)',
          bodyColor: 'var(--text)',
          borderColor: 'var(--accent)',
          borderWidth: 1,
          padding: 12,
          cornerRadius: 8
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(255, 255, 255, 0.15)' },
          ticks: {
            color: 'rgba(255, 255, 255, 0.8)',
            callback: function(value) { return value + 'ml'; }
          }
        },
        x: {
          grid: { color: 'rgba(255, 255, 255, 0.1)' },
          ticks: { color: 'rgba(255, 255, 255, 0.8)' }
        }
      }
    }
  });
  
  distributionChart = new Chart(distCtx.getContext('2d'), {
    type: 'doughnut',
    data: {
      labels: [],
      datasets: [{
        data: [],
        backgroundColor: [],
        borderWidth: 2,
        borderColor: 'var(--card)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: 'rgba(255, 255, 255, 0.8)',
            padding: 20,
            usePointStyle: true,
            pointStyle: 'circle',
            font: { size: 11 }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(18, 26, 47, 0.95)',
          titleColor: 'var(--accent)',
          bodyColor: 'var(--text)',
          borderColor: 'var(--accent)',
          borderWidth: 1,
          padding: 12,
          cornerRadius: 8
        }
      },
      cutout: '60%'
    }
  });
  
  updateCharts();
}

function updateCharts() {
  if (!trendChart || !distributionChart) return;
  
  let labels = [];
  let data = [];
  
  if (appState.currentChartType === 'weekly') {
    for (let i = 6; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      const dateStr = date.toDateString();
      const dayData = appState.historicalData[dateStr];
      
      labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
      data.push(dayData ? dayData.consumed : 0);
    }
  } else if (appState.currentChartType === 'monthly') {
    const daysInMonth = new Date(appState.currentYear, appState.currentMonth + 1, 0).getDate();
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(appState.currentYear, appState.currentMonth, day);
      const dateStr = date.toDateString();
      const dayData = appState.historicalData[dateStr];
      
      labels.push(day);
      data.push(dayData ? dayData.consumed : 0);
    }
  } else if (appState.currentChartType === 'yearly') {
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    labels = months;
    data = Array(12).fill(0);
    
    Object.entries(appState.historicalData).forEach(([dateStr, dayData]) => {
      const date = new Date(dateStr);
      const month = date.getMonth();
      data[month] = Math.max(data[month], dayData.consumed);
    });
  }
  
  trendChart.data.labels = labels;
  trendChart.data.datasets[0].data = data;
  trendChart.update();
  
  updateDistributionChart();
}

function changeChartType(type) {
  appState.currentChartType = type;
  document.querySelectorAll('.chart-actions .chart-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  updateCharts();
}

function changePieType(type) {
  appState.currentPieType = type;
  document.querySelectorAll('.chart-actions .chart-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  updateDistributionChart();
}

function prevMonth() {
  appState.currentMonth--;
  if (appState.currentMonth < 0) {
    appState.currentMonth = 11;
    appState.currentYear--;
  }
  renderCalendar();
}

function nextMonth() {
  appState.currentMonth++;
  if (appState.currentMonth > 11) {
    appState.currentMonth = 0;
    appState.currentYear++;
  }
  renderCalendar();
}

function updateDrinkGrid() {
  const container = document.getElementById('drinkGrid');
  container.innerHTML = '';
  
  Object.entries(BEVERAGES).forEach(([key, drink]) => {
    const item = document.createElement('div');
    item.className = 'drink-item';
    item.onclick = () => selectDrink(key);
    
    item.innerHTML = `
      <i class="fas ${drink.icon} drink-icon" style="color: ${drink.color};"></i>
      <div class="drink-name">${drink.name}</div>
      <div class="drink-percentage">${drink.waterContent}% water</div>
    `;
    
    container.appendChild(item);
  });
}

function selectDrink(type) {
  appState.selectedDrink = type;
  const drink = BEVERAGES[type];
  
  document.getElementById('amountTitle').innerHTML = `
    <i class="fas ${drink.icon}" style="color: ${drink.color};"></i> ${drink.name}
  `;
  
  document.getElementById('waterContentInfo').innerHTML = `
    <div style="font-weight: 600; margin-bottom: 5px;">${drink.description}</div>
    <div style="font-size: 14px; color: var(--accent);">Contains ${drink.waterContent}% water</div>
  `;
  
  const amounts = [100, 200, 250, 300, 400, 500, 750, 1000];
  const container = document.getElementById('amountGrid');
  container.innerHTML = '';
  
  amounts.forEach(amount => {
    const waterAmount = Math.round(amount * drink.waterContent / 100);
    const btn = document.createElement('button');
    btn.className = 'amount-btn';
    if (amount === appState.selectedAmount) btn.classList.add('active');
    
    btn.innerHTML = `
      <div class="amount-value">${amount === 1000 ? '1L' : `${amount}ml`}</div>
      <div class="amount-water">${waterAmount}ml water</div>
    `;
    
    btn.onclick = () => {
      document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      appState.selectedAmount = amount;
      document.getElementById('customAmount').value = '';
    };
    
    container.appendChild(btn);
  });
  
  closeModal('drinkModal');
  openModal('amountModal');
}

function confirmDrink() {
  let amount = appState.selectedAmount;
  const customAmount = parseInt(document.getElementById('customAmount').value);
  
  if (customAmount && customAmount > 0) {
    amount = customAmount;
  }
  
  if (!appState.selectedDrink || amount <= 0) {
    showNotification("Please select a valid amount", "error");
    return;
  }
  
  addDrink(appState.selectedDrink, amount);
  closeModal('amountModal');
  appState.selectedDrink = null;
  appState.selectedAmount = 250;
}

function setupReminders() {
  if (!appState.settings.reminders?.enabled) return;
  
  if ("Notification" in window && Notification.permission === "default") {
    Notification.requestPermission();
  }
  
  scheduleSystemNotifications();
}

function scheduleSystemNotifications() {
  if (!appState.settings.reminders?.enabled) return;
  
  if (window.reminderInterval) {
    clearInterval(window.reminderInterval);
  }
  
  const frequencyHours = appState.settings.reminders.frequency;
  const [hours, minutes] = appState.settings.reminders.time.split(':').map(Number);
  const reminderMinutes = hours * 60 + minutes;
  
  const now = new Date();
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  const minutesUntilReminder = (reminderMinutes - currentMinutes + 24 * 60) % (24 * 60);
  
  setTimeout(() => {
    sendSystemReminder();
    window.reminderInterval = setInterval(sendSystemReminder, frequencyHours * 60 * 60 * 1000);
  }, minutesUntilReminder * 60 * 1000);
}

function sendSystemReminder() {
  if (!appState.settings.reminders?.enabled) return;
  
  const progress = appState.todayData ? (appState.todayData.consumed / appState.todayData.goal) * 100 : 0;
  let message = " Time to hydrate!";
  
  if (progress < 25) {
    message = " Start your hydration journey! Drink some water.";
  } else if (progress < 50) {
    message = " Keep going! You're making good progress.";
  } else if (progress < 75) {
    message = " Halfway there! Stay hydrated.";
  } else if (progress < 100) {
    message = " Almost at your goal! One more drink.";
  } else {
    message = " Goal achieved! Maintain your hydration.";
  }
  
  showNotification(message, "reminder");
  
  if ("Notification" in window && Notification.permission === "granted") {
    new Notification("Waterify Pro Reminder", {
      body: message,
      icon: "https://cdn.jsdelivr.net/npm/emoji-datasource-apple/img/apple/64/1f4a7.png",
      tag: "hydration-reminder"
    });
  }
  
  if (navigator.vibrate) {
    navigator.vibrate([100, 50, 100]);
  }
}

function testReminder() {
  sendSystemReminder();
  showNotification("Test reminder sent!", "success");
}

function exportData() {
  const data = {
    profile: appState.profile,
    historicalData: appState.historicalData,
    settings: appState.settings,
    exportDate: new Date().toISOString(),
    version: 5
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `waterify-data-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showNotification("Data exported successfully!", "success");
}

function importData() {
  document.getElementById('importFile').click();
}

document.getElementById('importFile').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      
      if (confirm("This will replace all your current data. Continue?")) {
        appState.profile = data.profile || appState.profile;
        appState.historicalData = data.historicalData || appState.historicalData;
        appState.settings = data.settings || appState.settings;
        
        saveAllData();
        updateDashboard();
        updateProfileUI();
        
        showNotification("Data imported successfully!", "success");
      }
    } catch (error) {
      showNotification("Error importing data. Invalid file format.", "error");
    }
  };
  reader.readAsText(file);
});

function resetData() {
  if (confirm("Are you sure you want to reset all data? This cannot be undone.")) {
    localStorage.clear();
    location.reload();
  }
}

function showAchievementsModal() {
  const content = document.getElementById('achievementsContent');
  content.innerHTML = '';
  
  if (!appState.profile || !appState.profile.achievements) {
    content.innerHTML = '<p style="text-align: center; color: var(--muted);">No achievements yet. Keep hydrating!</p>';
    openModal('achievementsModal');
    return;
  }
  
  const achievementsGrid = document.createElement('div');
  achievementsGrid.className = 'achievements-grid';
  
  ACHIEVEMENTS.forEach(achievement => {
    const achievementData = appState.profile.achievements[achievement.id];
    const isUnlocked = achievementData && achievementData.unlocked;
    
    const item = document.createElement('div');
    item.className = `achievement-item ${isUnlocked ? 'unlocked' : 'locked'}`;
    
    item.innerHTML = `
      <div class="achievement-icon" style="background: ${isUnlocked ? 'var(--accent)' : 'var(--glass)'};">
        <i class="fas ${achievement.icon}" style="color: ${isUnlocked ? '#000' : 'var(--muted)'};"></i>
      </div>
      <div class="achievement-name">${achievement.name}</div>
      <div class="achievement-desc">${achievement.description}</div>
      ${isUnlocked && achievementData.unlockedAt ? 
        `<div class="achievement-date">Unlocked: ${new Date(achievementData.unlockedAt).toLocaleDateString()}</div>` : 
        '<div class="achievement-date" style="color: var(--muted);">Locked</div>'}
    `;
    
    achievementsGrid.appendChild(item);
  });
  
  content.appendChild(achievementsGrid);
  openModal('achievementsModal');
}

function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(screen => {
    screen.style.display = 'none';
  });
  
  document.getElementById(screenId).style.display = 'block';
  
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  if (screenId === 'dashboard') {
    document.querySelector('.nav-item:nth-child(1)').classList.add('active');
  } else if (screenId === 'statsScreen') {
    document.querySelector('.nav-item:nth-child(3)').classList.add('active');
  } else if (screenId === 'profileScreen') {
    document.querySelector('.nav-item:nth-child(4)').classList.add('active');
  }
}

function openProfile() {
  showScreen('profileScreen');
}

function closeProfile() {
  showScreen('dashboard');
}

function openDrinkModal() {
  openModal('drinkModal');
}

function openModal(modalId) {
  document.getElementById(modalId).style.display = 'flex';
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

function closeStats() {
  showScreen('dashboard');
}

function showNotification(message, type = 'success') {
  const notification = document.getElementById('notification');
  const text = document.getElementById('notificationText');
  
  text.textContent = message;
  
  if (type === 'error') {
    notification.style.background = 'linear-gradient(135deg, var(--danger), #ff6b6b)';
    notification.style.color = '#000';
  } else if (type === 'reminder') {
    notification.style.background = 'linear-gradient(135deg, var(--secondary), #8b5cf6)';
    notification.style.color = '#000';
  } else {
    notification.style.background = 'linear-gradient(135deg, var(--accent), var(--accent2))';
    notification.style.color = '#000';
  }
  
  notification.style.display = 'block';
  notification.classList.add('show');
  
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      notification.style.display = 'none';
    }, 500);
  }, 3000);
}

// ============================================
// INITIALIZE APP
// ============================================

const script = document.createElement('script');
script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
script.onload = initializeApp;
document.head.appendChild(script);

window.addEventListener('load', () => {
  if (typeof Chart !== 'undefined') {
    initializeApp();
  }
  updateDrinkGrid();
});

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
      .then(registration => {
        console.log('Service Worker registered:', registration);
      })
      .catch(error => {
        console.log('Service Worker registration failed:', error);
      });
  });
}
</script>
</body>
</html>
